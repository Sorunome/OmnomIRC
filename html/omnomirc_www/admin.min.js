/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2015 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
(function(){var e=[],t=function(e,t,n){oirc.network.post("admin.php?set="+e,{data:JSON.stringify(t)},function(e){var t="";if(e.errors.length>0){$.map(e.errors,function(e){t+="ERROR: "+e+"\n"})}else{t=e.message}alert(t);if(n!==undefined){n()}})},n=function(e,n,i){$("#adminContent").append('<div style="font-weight:bold">'+n+" Settings</div>",$.map(i,function(e,t){var n=$("<input>").attr("name",t),i=t,a=e;if((typeof e).toLowerCase()=="object"){i=e[0];if(i===false){return"<br>"}a=e[1]}if(e===null){e=undefined}switch((typeof a).toLowerCase()){case"string":n.attr("type","text").val(a);break;case"number":n.attr("type","number").val(a);break;case"boolean":n.attr("type","checkbox").attr(a?"checked":"false","checked");break;default:n.attr("type","hidden").data("data",a)}return $("<div>").append(i,": ",n)}),"<br>",$("<button>").text("submit").click(function(){var n={};$("input").each(function(e,t){var i=undefined;switch($(t).attr("type")){case"text":i=$(t).val();break;case"number":i=parseInt($(t).val(),10);break;case"checkbox":i=$(t)[0].checked;break;case"hidden":i=$(t).data("data");break}if(i!==undefined){n[$(t).attr("name")]=i}});t(e,n)}))},i=function(e){$("#adminContent").append('<div style="font-weight:bold">Theme Settings</div>',$("<span>").append($.map(e,function(t,n){return[$("<span>").text(t.name)," ",$("<a>").text("edit").click(function(a){a.preventDefault();e[n].lastModified=-1;$(this).parent().replaceWith($("<span>").append($("<a>").text("Back").click(function(t){t.preventDefault();$("#adminContent").empty();i(e)}),"<br><br>Name:",$("<input>").attr("type","text").val(t.name).change(function(){e[n].name=this.value}),$.map([{name:"Background",type:"bg"},{name:"Alternative background",type:"bg2"},{name:"Border",type:"border"},{name:"Text",type:"text"},{name:"Links",type:"link"},{name:"Tab links",type:"tablink",use:"Links"},{name:"Buttons",type:"btn",use:"Alternative background"},{name:"Button Hover",type:"btnhover",use:"Alternative background"},{name:"Input bar",type:"form",use:"Background"},{name:"Popup background",type:"popupbg",use:"Alternative background"},{name:"Popup border",type:"popupborder",use:"Border"}],function(i){return["<br>",i.use!==undefined?$("<span>").append("Use instead of ",i.use,$("<input>").attr("type","checkbox").attr(t["use"+i.type]?"checked":"false","checked").change(function(){e[n]["use"+i.type]=this.checked})):"",i.name,":",$("<input>").attr("type","color").val(t.colors[i.type]).change(function(){if(e[n].colors instanceof Array){e[n].colors={}}e[n].colors[i.type]=this.value})]}),"<br>Extra style sheet:",$("<input>").attr("type","text").val(t.sheet).change(function(){e[n].sheet=this.value})))}),"<br>"]}),"<br>",$("<a>").text("add Theme").click(function(t){t.preventDefault();var n=prompt("new theme name");if(n!==""&&n!==null){e.push({name:n,colors:{},lastModified:-1});$("#adminContent").empty();i(e)}})),"<br>",$("<button>").text("submit").click(function(){t("themes",e)}))},a=function(e,n){var i=function(t,a,r){$(r).empty().append($.map(t.networks,function(r,c){return[$("<div>").css({display:"inline-block",border:"1px solid black",margin:5}).append($("<b>").text(n[r.id].name)," ",$("<a>").text("remove").click(function(n){n.preventDefault();e[a].networks.splice(c,1);t=e[a];i(t,a,$(this).parent().parent())}),"<br>Name:",$("<input>").attr("type","text").val(r.name).change(function(){e[a].networks[c].name=this.value}),n[r.id].type==1?["<br>Hidden:",$("<input>").attr("type","checkbox").attr(r.hidden?"checked":"false","checked").change(function(){e[a].networks[c].hidden=this.checked}),"<br>Order:",$("<input>").attr("type","number").val(r.order).change(function(){e[a].networks[c].order=parseInt($(this).val(),10)})]:""),"<br>"]}),$("<select>").append($("<option>").text("Add to network...").val(-1),$.map(n,function(e){if(e.type===0){return undefined}return $("<option>").text(e.name).val(e.id)})).change(function(){var n=parseInt($(this).val(),10),r=0;$.each(e,function(e,t){$.each(t.networks,function(t,i){if(i.id==n&&i.order>r&&r!=-1){r=i.order}if(i.id==n&&e==a){r=-1}})});if(r==-1){alert("Network already exists!");$(this).val(-1);return}e[a].networks.push({id:n,name:t.networks.length>0?t.networks[0].name:t.alias,hidden:false,order:r+1});t=e[a];i(t,a,$(this).parent())}))};$("#adminContent").append('<div style="font-weight:bold">Channel Settings</div>',$("<div>").append($.map(e,function(t,n){return $("<div>").css({display:"inline-block",border:"1px solid black","vertical-align":"top"}).append($("<b>").text(t.alias),"<br>Enabled:",$("<input>").attr("type","checkbox").attr(t.enabled?"checked":"false","checked").change(function(){e[n].enabled=this.checked}),"<br>",$("<div>").css({display:"inline-block",border:"1px solid black"}).append($("<input>").attr("type","text").val(t.networks.length>0?t.networks[0].name:t.alias).change(function(){var i=this;$.each(t.networks,function(t){e[n].networks[t].name=$(i).val()})}),"<br>",$("<a>").text("Show advanced settings").click(function(e){e.preventDefault();i(t,n,$(this).parent())})))}),$("<button>").text("New Channel").click(function(t){t.preventDefault();var i=prompt("New Channel alias"),r=[],c=0;if(i!==""&&i!==null){r=$.map(n,function(t){var n=0;if(t.type==1){$.each(e,function(e,i){$.each(i.networks,function(e,i){if(i.id==t.id&&i.order>n&&n!=-1){n=i.order}})})}if(t.type===0){return undefined}return{id:t.id,name:"",hidden:false,order:n+1}});$.each(e,function(e,t){if(t.id>c){c=t.id}});e.push({id:c+1,alias:i,enabled:true,networks:r});$("#adminContent").empty();a(e,n)}})),"<br>",$("<button>").text("submit").click(function(){t("channels",e)}))},r=function(e){var n=function(t,i){t.empty().append($.map(e[i],function(a,r){if(r=="inner"){return}return["<br>",$("<span>").text(r).html(),":",$("<input>").attr("type","text").css("width",120).val(e[i][r]).change(function(){e[i][r]=this.value}),$("<a>").text("x").click(function(a){a.preventDefault();if(r=="inner"){return}delete e[i][r];n(t,i)})]}),"<br>",$("<button>").text("New Attribute").click(function(a){a.preventDefault();var r=prompt("new attribute name");if(r!==""&&r!==null){e[i][r]="";n(t,i)}}))};$("#adminContent").append('<div style="font-weight:bold">Hotlinks Settings</div>',$.map(e,function(t,i){$attrSettings=$("<div>");n($attrSettings,i);return $("<div>").css({display:"inline-block",border:"1px solid black","vertical-align":"top"}).append($("<input>").attr("type","text").css("width",160).val(e[i].inner).change(function(){e[i].inner=this.value}),"<br>",$("<a>").text("<").click(function(t){t.preventDefault();if(i==0){return}var n=e[i-1];e[i-1]=e[i];e[i]=n;$("#adminContent").empty();r(e)}),"&nbsp;&nbsp;",$("<a>").text("x").click(function(t){t.preventDefault();if(confirm("Are you sure you want to remove this hotlink?")){e.splice(i,1);$("#adminContent").empty();r(e)}}),"&nbsp;&nbsp;",$("<a>").text(">").click(function(t){t.preventDefault();if(i==e.length-1){return}var n=e[i+1];e[i+1]=e[i];e[i]=n;$("#adminContent").empty();r(e)}),"<br>",$attrSettings)}),$("<button>").text("New Hotlink").click(function(t){t.preventDefault();var n=prompt("new hotlink name");if(n!==""&&n!==null){e.push({inner:n});$("#adminContent").empty();r(e)}}),"<br><br>",$("<button>").text("submit").click(function(){t("hotlinks",e)}))},c=function(e){var n=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},i=$("<div>"),a=$("<div>").append($.map(e,function(t,a){var r=$("<img>"),o=e[a].code;return r.attr("src",t.pic).css({"margin-left":5,cursor:"pointer"}).click(function(){var t=false;i.empty().append($("<a>").text("Remove this smiley").click(function(t){t.preventDefault();if(confirm("Are you sure you want to remove this smiley?")){e.splice(a,1);$("#adminContent").empty();c(e)}}),"<br>","Picture URL:",$("<input>").attr("type","text").val(e[a].pic).change(function(){e[a].pic=this.value;r.attr("src",this.value)}),"<br>","Code:",$("<input>").attr("type","text").val(e[a].code).change(function(i){e[a].code=this.value;if(!t){if(window.getSelection){window.getSelection().removeAllRanges()}else{document.selection.empty()}if((e[a].regex!=n(o)||e[a].replace!='<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>')&&!confirm("Also change regex/replace? They have been manually changed in the advanced settings!")){return}e[a].regex=n(this.value);e[a].replace='<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>';o=this.value}}),"<br>","Show in menu:",$("<input>").attr("type","checkbox").attr(e[a].inMenu?"checked":"false","checked").change(function(){e[a].inMenu=this.checked}),"<br>","Alt (mouseover):",$("<input>").attr("type","text").val(e[a].alt).change(function(){e[a].alt=this.value}),"<br>",$("<a>").text("Show advanced settings").click(function(n){n.preventDefault();t=true;$(this).replaceWith($("<span>").append("Regex:",$("<input>").attr("type","text").val(e[a].regex).change(function(t){e[a].regex=this.value}),"<br>","Replace:",$("<input>").attr("type","text").val(e[a].replace).change(function(t){e[a].replace=this.value})))}))})}));$("#adminContent").append('<div style="font-weight:bold">Smiley Settings</div>',i,"<br>",a,"<br>",$("<button>").text("New Smiley").click(function(t){t.preventDefault();var i=prompt("New image location"),a=prompt("New smiley code"),r="";if(i!==""&&i!==null&&a!==""&&a!==null){e.push({pic:i,alt:a,code:a,inMenu:true,regex:n(a),replace:'<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>'});$("#adminContent").empty();c(e)}}),"<br><br>",$("<button>").text("submit").click(function(){t("smileys",e)}))},o=function(e){$("#adminContent").append('<div style="font-weight:bold">Network Settings</div>',$("<div>").append($.map(e,function(t,n){if(t.type===0){return undefined}return[$("<span>").text(t.name)," ",$("<a>").text("edit").click(function(i){i.preventDefault();var a=$("<b>").text("Unkown network type");switch(t.type){case 0:a.text("Server Network");break;case 1:a=$("<span>").append($("<b>").text("OmnomIRC network"),"<br>checkLogin:",$("<input>").attr("type","text").val(t.config.checkLogin).change(function(){e[n].config.checkLogin=this.value}),"<br>checkLogin hook:",$("<span>").text("loading...").on("now",function(){var t=this;oirc.network.getJSON("admin.php?get=checkLogin&i="+n.toString(10),function(i){var a="";if(i.success===false){a="ERROR: couldn't reach checkLogin server, perhaps the changed URL needs to be saved?"}else if(i.auth===false){a="ERROR: couldn't identify with checkLogin server, perhaps sigKey is false?"}if(a!==""){$(t).replaceWith($("<span>").append(a));return}$(t).replaceWith($("<select>").append($.map(i.checkLogin.hooks,function(e){return $("<option>").val(e).text(e)})).val(i.checkLogin.hook).change(function(){e[n].config.checkLoginHook=this.value}))})}).trigger("now"),"<br>Theme:",$("<span>").text("loading...").on("now",function(){var i=this;oirc.network.getJSON("admin.php?get=themes",function(a){$(i).replaceWith($("<select>").append($("<option>").val(-1).text("default"),$.map(a.themes,function(e,t){return $("<option>").val(t).text(e.name)})).val(t.config.theme?t.config.theme:0).change(function(){e[n].config.theme=parseInt(this.value,10)}))})}).trigger("now"),"<br>",$("<button>").text("Use Current settings as defaults").click(function(){e[n].config.defaults=oirc.options.getFullOptionsString()}),"<br>",$("<select>").append($("<option>").val(0).text("Deny Guest Access"),$("<option>").val(1).text("Guests are read-only")).val(t.config.guests?t.config.guests:0).change(function(t){e[n].config.guests=parseInt(this.value,10)}),"<br>Extra Channels Message:<br>",$("<textarea>").text(t.config.extraChanMsg).change(function(){e[n].config.extraChanMsg=this.value}));break;case 2:a=$("<span>").append($("<b>").text("CalcNet network"),"<br>Server:",$("<input>").attr("type","text").val(t.config.server).change(function(){e[n].config.server=this.value}),"<br>Port:",$("<input>").attr("type","number").val(t.config.port).change(function(){e[n].config.port=parseInt($(this).val(),10)}));break;case 3:a=$("<span>").append($("<b>").text("IRC network"),"<br>Color Nicks:",$("<input>").attr("type","checkbox").attr(t.config.colornicks?"checked":"false","checked").change(function(){e[n].config.colornicks=this.checked}),"<br>","<br>Nick:",$("<input>").attr("type","text").val(t.config.main.nick).change(function(){e[n].config.main.nick=this.value}),"<br>Server:",$("<input>").attr("type","text").val(t.config.main.server).change(function(){e[n].config.main.server=this.value}),"<br>Port",$("<input>").attr("type","number").val(t.config.main.port).change(function(){e[n].config.main.port=parseInt($(this).val(),10)}),"<br>SSL:",$("<input>").attr("type","checkbox").attr(t.config.main.ssl?"checked":"false","checked").change(function(){e[n].config.main.ssl=this.checked}),"<br>NickServ:",$("<input>").attr("type","text").val(t.config.main.nickserv).change(function(){e[n].config.main.nickserv=this.value}),"<br>",$("<a>").text("Show advanced settings").click(function(i){i.preventDefault();$(this).replaceWith($("<span>").append("<br>",$("<b>").text("TopicBot"),"<br>Nick:",$("<input>").attr("type","text").val(t.config.topic.nick).change(function(){e[n].config.topic.nick=this.value}),"<br>Server:",$("<input>").attr("type","text").val(t.config.topic.server).change(function(){e[n].config.topic.server=this.value}),"<br>Port",$("<input>").attr("type","number").val(t.config.topic.port).change(function(){e[n].config.topic.port=parseInt($(this).val(),10)}),"<br>SSL:",$("<input>").attr("type","checkbox").attr(t.config.topic.ssl?"checked":"false","checked").change(function(){e[n].config.topic.ssl=this.checked}),"<br>NickServ:",$("<input>").attr("type","text").val(t.config.topic.nickserv).change(function(){e[n].config.topic.nickserv=this.value})))}));break}$(this).parent().replaceWith($("<div>").append($("<a>").text("back").click(function(t){$("#adminContent").empty();o(e)}),"<br><br>",$("<span>").append($("<span>").css("font-weight","bold").text(t.name),"&nbsp;",$("<a>").text("edit").click(function(i){i.preventDefault();$(this).parent().replaceWith($("<input>").attr("type","text").val(t.name).change(function(){e[n].name=this.value}))})),"<br>Enabled:",$("<input>").attr("type","checkbox").attr(t.enabled?"checked":"false","checked").change(function(){e[n].enabled=this.checked}),"<br>Normal:",$("<input>").attr("type","text").val(t.normal).change(function(){e[n].normal=this.value}),"<br>Userlist:",$("<input>").attr("type","text").val(t.userlist).change(function(){e[n].userlist=this.value}),"<br>IRC:",$("<input>").attr("type","number").val(t.irc.color).css("width",50).change(function(){e[n].irc.color=parseInt($(this).val(),10)}),$("<input>").attr("type","text").val(t.irc.prefix).css("width",50).change(function(){e[n].irc.prefix=this.value}),"<br>",a))}),"<br>"]}),$("<select>").append($("<option>").val(-1).text("Add Network..."),$("<option>").val(1).text("OmnomIRC"),$("<option>").val(2).text("CalcNet"),$("<option>").val(3).text("IRC")).change(function(){var t=prompt("New Network Name"),n=null,i,a;if(t!==""&&t!==null){switch(parseInt($(this).val(),10)){case 1:i={checkLogin:"link to checkLogin file",theme:-1,defaults:"",opGroups:[],guests:0};break;case 2:i={server:"mydomain.com",port:4295};break;case 3:i={main:{nick:"OmnomIRC",server:"irc server",port:6667,nickserv:"nickserv password",ssl:false},topic:{nick:"",server:"irc server",port:6667,nickserv:"nickserv password",ssl:false}};break;default:i=null}if(i!==null){a=0;$.each(e,function(e,t){if(t.id>a){a=t.id}});n={enabled:true,id:a+1,type:parseInt($(this).val(),10),normal:"NICK",userlist:"("+t[0].toUpperCase()+")NICK",irc:{color:-1,prefix:"("+t[0].toUpperCase()+")"},name:t,config:i};e.push(n);$("#adminContent").empty();o(e)}}else{$(this).val(-1)}})),"<br>",$("<button>").text("submit").click(function(){t("networks",e)}))},s=function(n){$("#adminContent").append("OmnomIRC Version: "+n.version+"<br>",$("<span>").attr("id","fetchingUpdates").text("checking for updates..."),"<br>",$("<button>").text("Back up config").click(function(){t("backupConfig",{})}),$("<div>").attr("id","fetchingNews").text("fetching news..."));$.getJSON(oirc.OMNOMIRCSERVER+"/getNewestVersion.php?version="+n.version+(e.betaUpdates?"&experimental":"")+"&jsoncallback=?").done(function(e){if(e.latest){$("#fetchingUpdates").empty().text("No new updates available")}else{$("#fetchingUpdates").empty().append("New updates available! ("+e.version+") ",!n.updaterReady?$("<a>").text("Click here to download the updater script").click(function(n){n.preventDefault();t("getUpdater",{path:oirc.OMNOMIRCSERVER+e.updater},function(){p("index")})}):$("<a>").text("Click here to apply the update").attr("href","updater.php"+(document.URL.split("network=")[1]!==undefined?"?network="+document.URL.split("network=")[1].split("&")[0].split("#")[0]:"")))}});$.getJSON(oirc.OMNOMIRCSERVER+"/getNews.php?jsoncallback=?").done(function(e){$("#fetchingNews").empty().css({height:300,border:"1px solid black",overflow:"auto",width:"70%"}).append($("<table>").css("width","100%").append($("<tr>").append($("<th>").css("width",150).text("date"),$("<th>").text("news")),$.map(e.news,function(e){return $("<tr>").append($("<td>").css({width:"auto",border:"1px solid black"}).text(new Date(e.time*1e3).toLocaleString()),$("<td>").css({width:"auto",border:"1px solid black"}).html(e.message))})))})},p=function(e){oirc.indicator.start();$("#adminContent").text("Loading...");oirc.network.getJSON("admin.php?get="+encodeURIComponent(e),function(t){$("#adminContent").empty();if(t.denied!==undefined&&t.denied){$("#adminContent").append($("<b>").text("ERROR: Permission denied"));return}switch(e){case"index":s(t);break;case"themes":i(t.themes);break;case"channels":a(t.channels,t.nets);break;case"hotlinks":r(t.hotlinks);break;case"smileys":c(t.smileys);break;case"networks":o(t.networks);break;case"sql":$.extend(t.sql,{passwd:""});n(e,"SQL",t.sql);break;case"ws":n(e,"WebSockets",t.websockets);break;case"misc":n(e,"Misc",t.misc);break;case"ex":n(e,"Experimental",t.ex);break;case"releaseNotes":$("#adminContent").append($("<h2>").text("Release notes version "+t.version),$("<span>").attr("id","releaseNotes").text("Loading..."));$.getJSON(oirc.OMNOMIRCSERVER+"/getReleaseNotes.php?version="+t.version+"&jsoncallback=?").done(function(e){$("#releaseNotes").html(e.notes)});break}window.location.hash="#"+e;oirc.indicator.stop()})};$("#adminNav a").click(function(e){e.preventDefault();p($(this).data("page"))});oirc.settings.fetch(function(){oirc.network.getJSON("config.php?nologinerrors&admincfg",function(t){e=t;var n=window.location.hash;if(n.split("#")[1]!==undefined){n=n.split("#")[1]}else if(n==""){n="index"}oirc.page.changeLinks();p(n)})});$("#adminContent").height($(window).height()-50);$(window).resize(function(){if(!(navigator.userAgent.match(/(iPod|iPhone|iPad)/i)&&navigator.userAgent.match(/AppleWebKit/i))){$("#adminContent").height($(window).height()-50)}})})();