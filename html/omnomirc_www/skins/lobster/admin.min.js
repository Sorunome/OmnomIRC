/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2017 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";$(function(){var c=new OmnomIRC,a=[],s=function(e,t,n){c.network.post("admin.php?set="+e,{data:JSON.stringify(t)},function(e){var t="";0<e.errors.length?$.map(e.errors,function(e){t+="ERROR: "+e+"\n"}):t=e.message,alert(t),void 0!==n&&n()})},i=function(e,t,n,a){$("#adminContent").append('<div style="font-weight:bold">'+t+" Settings</div>",p(n,a),"<br>",$("<button>").text("submit").click(function(){s(e,n)}))},p=function(i,e){var a=function(e,t){if(void 0===t&&(t=i),1==(e=e.split(".")).length)return t[e[0]];var n=e.shift();return a(e.join("."),t[n])},r=function(e,t,n){if(void 0===n&&(n=i,"boolean"==typeof t?($('[data-var="'+e+'"]').each(function(){this.checked=t}),t?$('[data-varbox="'+e+'"]').show():$('[data-varbox="'+e+'"]').hide()):($('[data-var="'+e+'"]').val(t),$('[data-varbox="'+e+'"]').hide(),$('[data-varbox="'+e+'"][data-valbox="'+t+'"]').show())),1!=(e=e.split(".")).length){var a=e.shift();r(e.join("."),t,n[a])}else n[e[0]]=t};return $("<span>").css("display","inline-block").append($.map(e,function(t){var n,e=$("<span>");switch(t.type){case"text":e=$("<input>").attr("type","text").val(a(t.var)).change(function(){r(t.var,this.value)});break;case"number":e=$("<input>").attr("type","number").val(a(t.var)).change(function(){r(t.var,parseInt(this.value,10))});break;case"checkbox":(e=$("<input>").attr("type","checkbox").change(function(){r(t.var,this.checked)}))[0].checked=a(t.var),t.pattern&&(n=p(i,t.pattern).attr("data-varbox",t.var),e[0].checked||n.hide());break;case"dropdown":n=$("<span>"),e=$("<select>").append($.map(t.options,function(e){return e.pattern&&n.append(p(i,e.pattern).attr("data-varbox",t.var).attr("data-valbox",e.val)),$("<option>").val(e.val).text(e.name)})).val(a(t.var)).change(function(){r(t.var,this.value)}),n.children().hide(),n.find('[data-valbox="'+a(t.var)+'"]').show();break;case"newline":return"<br>";case"info":return[$("<b>").text(t.name),"<br>"];case"more":return n=p(i,t.pattern).css({border:"1px solid black",padding:5}).hide(),[$("<b>").text(t.name),"&nbsp;",$("<a>").text("show/hide").click(function(e){e.preventDefault(),n.toggle()}),"<br>",n,"<br>"]}return e.attr("data-var",t.var),[t.name+":&nbsp;",e,"<br>",n||"",n?"<br>":""]}))},r=function(a){$("#adminContent").append('<div style="font-weight:bold">Theme Settings</div>',$("<span>").append($.map(a,function(t,n){return[$("<span>").text(t.name)," ",$("<a>").text("edit").click(function(e){e.preventDefault(),a[n].lastModified=-1,$(this).parent().replaceWith($("<span>").append($("<a>").text("Back").click(function(e){e.preventDefault(),$("#adminContent").empty(),r(a)}),"<br><br>Name:",$("<input>").attr("type","text").val(t.name).change(function(){a[n].name=this.value}),$.map([{name:"Background",type:"bg"},{name:"Alternative background",type:"bg2"},{name:"Border",type:"border"},{name:"Text",type:"text"},{name:"Links",type:"link"},{name:"Tab links",type:"tablink",use:"Links"},{name:"Buttons",type:"btn",use:"Alternative background"},{name:"Button Hover",type:"btnhover",use:"Alternative background"},{name:"Input bar",type:"form",use:"Background"},{name:"Popup background",type:"popupbg",use:"Alternative background"},{name:"Popup border",type:"popupborder",use:"Border"}],function(e){return["<br>",void 0!==e.use?$("<span>").append("Use instead of ",e.use,$("<input>").attr("type","checkbox").attr(t["use"+e.type]?"checked":"false","checked").change(function(){a[n]["use"+e.type]=this.checked})):"",e.name,":",$("<input>").attr("type","color").val(t.colors[e.type]).change(function(){a[n].colors instanceof Array&&(a[n].colors={}),a[n].colors[e.type]=this.value})]}),"<br>Extra style sheet:",$("<input>").attr("type","text").val(t.sheet).change(function(){a[n].sheet=this.value})))}),"<br>"]}),"<br>",$("<a>").text("add Theme").click(function(e){e.preventDefault();var t=prompt("new theme name");""!==t&&null!==t&&(a.push({name:t,colors:{},lastModified:-1}),$("#adminContent").empty(),r(a))})),"<br>",$("<button>").text("submit").click(function(){s("themes",a)}))},l=function(o,i){var c=function(n,r,e){$(e).empty().append($.map(n.networks,function(e,t){return[$("<div>").css({display:"inline-block",border:"1px solid black",margin:5}).append($("<b>").text(i[e.id].name)," ",$("<a>").text("remove").click(function(e){e.preventDefault(),o[r].networks.splice(t,1),n=o[r],c(n,r,$(this).parent().parent())}),"<br>Name:",$("<input>").attr("type","text").val(e.name).change(function(){o[r].networks[t].name=this.value}),1==i[e.id].type?["<br>Hidden:",$("<input>").attr("type","checkbox").attr(e.hidden?"checked":"false","checked").change(function(){o[r].networks[t].hidden=this.checked}),"<br>Order:",$("<input>").attr("type","number").val(e.order).change(function(){o[r].networks[t].order=parseInt($(this).val(),10)})]:""),"<br>"]}),$("<select>").append($("<option>").text("Add to network...").val(-1),$.map(i,function(e){if(0!==e.type)return $("<option>").text(e.name).val(e.id)})).change(function(){var a=parseInt($(this).val(),10),i=0;if($.each(o,function(n,e){$.each(e.networks,function(e,t){t.id==a&&t.order>i&&-1!=i&&(i=t.order),t.id==a&&n==r&&(i=-1)})}),-1==i)return alert("Network already exists!"),void $(this).val(-1);o[r].networks.push({id:a,name:0<n.networks.length?n.networks[0].name:n.alias,hidden:!1,order:i+1}),n=o[r],c(n,r,$(this).parent())}))};$("#adminContent").append('<div style="font-weight:bold">Channel Settings</div>',$("<div>").append($.map(o,function(n,a){return $("<div>").css({display:"inline-block",border:"1px solid black","vertical-align":"top"}).append($("<b>").text(n.alias)," (",$("<a>").text("delete").click(function(e){e.preventDefault(),confirm("Are you sure you want to delete channel "+n.alias+"?\nThis will also delete all data (messages etc) associated with that channel!")&&(o.splice(a,1),$("#adminContent").empty(),l(o,i))}),")<br>Enabled:",$("<input>").attr("type","checkbox").attr(n.enabled?"checked":"false","checked").change(function(){o[a].enabled=this.checked}),"<br>",$("<div>").css({display:"inline-block",border:"1px solid black"}).append($("<input>").attr("type","text").val(0<n.networks.length?n.networks[0].name:n.alias).change(function(){var t=this;$.each(n.networks,function(e){o[a].networks[e].name=$(t).val()})}),"<br>",$("<a>").text("Show advanced settings").click(function(e){e.preventDefault(),c(n,a,$(this).parent())})))}),$("<button>").text("New Channel").click(function(e){e.preventDefault();var t=prompt("New Channel alias"),n=[],a=0;""!==t&&null!==t&&(n=$.map(i,function(n){var a=0;if(1==n.type&&$.each(o,function(e,t){$.each(t.networks,function(e,t){t.id==n.id&&t.order>a&&-1!=a&&(a=t.order)})}),0!==n.type)return{id:n.id,name:"",hidden:!1,order:a+1}}),$.each(o,function(e,t){t.id>a&&(a=t.id)}),o.push({id:a+1,alias:t,enabled:!0,networks:n}),$("#adminContent").empty(),l(o,i))})),"<br>",$("<button>").text("submit").click(function(){s("channels",o)}))},o=function(i){var r=function(n,a){n.empty().append($.map(i[a],function(e,t){if("inner"!=t)return["<br>",$("<span>").text(t).html(),":",$("<input>").attr("type","text").css("width",120).val(i[a][t]).change(function(){i[a][t]=this.value}),$("<a>").text("x").click(function(e){e.preventDefault(),"inner"!=t&&(delete i[a][t],r(n,a))})]}),"<br>",$("<button>").text("New Attribute").click(function(e){e.preventDefault();var t=prompt("new attribute name");""!==t&&null!==t&&(i[a][t]="",r(n,a))}))};$("#adminContent").append('<div style="font-weight:bold">Hotlinks Settings</div>',$.map(i,function(e,n){var t=$("<div>");return r(t,n),$("<div>").css({display:"inline-block",border:"1px solid black","vertical-align":"top"}).append($("<input>").attr("type","text").css("width",160).val(i[n].inner).change(function(){i[n].inner=this.value}),"<br>",$("<a>").text("<").click(function(e){if(e.preventDefault(),0!=n){var t=i[n-1];i[n-1]=i[n],i[n]=t,$("#adminContent").empty(),o(i)}}),"&nbsp;&nbsp;",$("<a>").text("x").click(function(e){e.preventDefault(),confirm("Are you sure you want to remove this hotlink?")&&(i.splice(n,1),$("#adminContent").empty(),o(i))}),"&nbsp;&nbsp;",$("<a>").text(">").click(function(e){if(e.preventDefault(),n!=i.length-1){var t=i[n+1];i[n+1]=i[n],i[n]=t,$("#adminContent").empty(),o(i)}}),"<br>",t)}),$("<button>").text("New Hotlink").click(function(e){e.preventDefault();var t=prompt("new hotlink name");""!==t&&null!==t&&(i.push({inner:t}),$("#adminContent").empty(),o(i))}),"<br><br>",$("<button>").text("submit").click(function(){s("hotlinks",i)}))},d=function(r){var o=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},c=$("<div>"),e=$("<div>").append($.map(r,function(e,n){var a=$("<img>"),i=r[n].code;return a.attr("src",e.pic).css({"margin-left":5,cursor:"pointer"}).click(function(){var t=!1;c.empty().append($("<a>").text("Remove this smiley").click(function(e){e.preventDefault(),confirm("Are you sure you want to remove this smiley?")&&(r.splice(n,1),$("#adminContent").empty(),d(r))}),"<br>","Picture URL:",$("<input>").attr("type","text").val(r[n].pic).change(function(){r[n].pic=this.value,a.attr("src",this.value)}),"<br>","Code:",$("<input>").attr("type","text").val(r[n].code).change(function(e){if(r[n].code=this.value,!t){if(window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),(r[n].regex!=o(i)||'<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>'!=r[n].replace)&&!confirm("Also change regex/replace? They have been manually changed in the advanced settings!"))return;r[n].regex=o(this.value),r[n].replace='<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>',i=this.value}}),"<br>","Show in menu:",$("<input>").attr("type","checkbox").attr(r[n].inMenu?"checked":"false","checked").change(function(){r[n].inMenu=this.checked}),"<br>","Alt (mouseover):",$("<input>").attr("type","text").val(r[n].alt).change(function(){r[n].alt=this.value}),"<br>",$("<a>").text("Show advanced settings").click(function(e){e.preventDefault(),t=!0,$(this).replaceWith($("<span>").append("Regex:",$("<input>").attr("type","text").val(r[n].regex).change(function(e){r[n].regex=this.value}),"<br>","Replace:",$("<input>").attr("type","text").val(r[n].replace).change(function(e){r[n].replace=this.value})))}))})}));$("#adminContent").append('<div style="font-weight:bold">Smiley Settings</div>',c,"<br>",e,"<br>",$("<button>").text("New Smiley").click(function(e){e.preventDefault();var t=prompt("New image location"),n=prompt("New smiley code");""!==t&&null!==t&&""!==n&&null!==n&&(r.push({pic:t,alt:n,code:n,inMenu:!0,regex:o(n),replace:'<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>'}),$("#adminContent").empty(),d(r))}),"<br><br>",$("<button>").text("submit").click(function(){s("smileys",r)}))},u=function(r,o){$("#adminContent").append('<div style="font-weight:bold">Network Settings</div>',$("<div>").append($.map(r,function(a,i){if("server"!=a.type)return[$("<span>").text(a.name)," ",$("<a>").text("edit").click(function(e){e.preventDefault();var t=$("<b>").text("Unkown network type, perhaps the bot isn't running?");switch(a.type){case 0:t.text("Server Network");break;case 1:t=$("<span>").append($("<b>").text("OmnomIRC network"),"<br>Theme:",$("<span>").text("loading...").on("now",function(){var t=this;c.network.getJSON("admin.php?get=themes",function(e){$(t).replaceWith($("<select>").append($("<option>").val(-1).text("default"),$.map(e.themes,function(e,t){return $("<option>").val(t).text(e.name)})).val(a.config.theme?a.config.theme:0).change(function(){a.config.theme=parseInt(this.value,10)}))})}).trigger("now"),"<br>",$("<button>").text("Use Current settings as defaults").click(function(){a.config.defaults=c.options.getAll(),alert("Defaults set")}),"<br>",$("<select>").append($("<option>").val(0).text("Deny Guest Access"),$("<option>").val(1).text("Guests are read-only"),$("<option>").val(2).text("Guests may chat")).val(a.config.guests?a.config.guests:0).change(function(e){a.config.guests=parseInt(this.value,10)}),"<br>Extra Channels Message:<br>",$("<textarea>").text(a.config.extraChanMsg?a.config.extraChanMsg:"").change(function(){a.config.extraChanMsg=this.value}),"<br>",$("<a>").text("Show advanced settings").click(function(e){e.preventDefault(),$(this).replaceWith($("<span>").append("<br>checkLogin hook:",$("<span>").text("loading...").on("now",function(){var n=this;c.network.getJSON("admin.php?get=checkLogin&i="+i.toString(10),function(e){var t="";!1===e.success?t="ERROR: couldn't reach checkLogin server, perhaps the changed URL needs to be saved?":!1===e.auth&&(t="ERROR: couldn't identify with checkLogin server, perhaps sigKey is false?"),""===t?$(n).replaceWith($("<select>").append($.map(e.checkLogin.hooks,function(e){return $("<option>").val(e).text(e)})).val(e.checkLogin.hook).change(function(){a.config.checkLoginHook=this.value})):$(n).replaceWith($("<span>").append(t))})}).trigger("now"),"<br>checkLogin:",$("<input>").attr("type","text").val(a.config.checkLogin).change(function(){a.config.checkLogin=this.value}),"<br>checkLogin absolute path, if on same server (empty for skip):",$("<input>").attr("type","text").val(a.config.checkLoginAbs).change(function(){a.config.checkLoginAbs=this.value}),"<br>Same-page links (comma-seperated):",$("<input>").attr("type","text").val(a.config.spLinks.join(",")).change(function(){a.config.spLinks=this.value.split(",")})))}));break;default:o[a.type]&&(t=$("<span>").append($("<b>").text(o[a.type].name+" Network")," (",$("<a>").text("restart").click(function(e){e.preventDefault(),confirm("Are you sure you want to restart the network "+a.name+"?")&&c.network.getJSON("admin.php?set=restartNetwork&nid="+encodeURIComponent(a.id),function(e){})}),")<br>",p(a.config,o[a.type].editPattern)))}$(this).parent().replaceWith($("<div>").append($("<a>").text("back").click(function(e){$("#adminContent").empty(),u(r,o)}),"<br><br>",$("<span>").append($("<span>").css("font-weight","bold").text(a.name),"&nbsp;",$("<a>").text("edit").click(function(e){e.preventDefault(),$(this).parent().replaceWith($("<input>").attr("type","text").val(a.name).change(function(){a.name=this.value}))})),"<br>Enabled:",$("<input>").attr("type","checkbox").attr(a.enabled?"checked":"false","checked").change(function(){a.enabled=this.checked}),"<br>Normal:",$("<input>").attr("type","text").val(a.normal).change(function(){r[i].normal=this.value}),"<br>Userlist:",$("<input>").attr("type","text").val(a.userlist).change(function(){r[i].userlist=this.value}),"<br>IRC:",$("<input>").attr("type","number").val(a.irc.color).css("width",50).change(function(){a.irc.color=parseInt($(this).val(),10)}),$("<input>").attr("type","text").val(a.irc.prefix).css("width",50).change(function(){a.irc.prefix=this.value}),"<br>",t))}),"<br>"]}),$("<select>").append($("<option>").val(-1).text("Add Network..."),$.map(o,function(e){return $("<option>").val(e.id).text(e.name)})).change(function(){var e,n,t=prompt("New Network Name"),a=null;if(""!==t&&null!==t){var i=$(this).val();(e="1"===i?{checkLogin:"link to checkLogin file",checkLoginAbs:"",spLinks:[],theme:-(i=1),defaults:{},guests:0}:!!o[i]&&o[i].defaultCfg)&&(n=0,$.each(r,function(e,t){t.id>n&&(n=t.id)}),a={enabled:!0,id:n+1,type:i,normal:"NICK",userlist:"("+t[0].toUpperCase()+")NICK",irc:{color:-1,prefix:"("+t[0].toUpperCase()+")"},name:t,config:e},r.push(a),$("#adminContent").empty(),u(r,o))}else alert("Invalid network type"),$(this).val(-1)})),"<br>",$("<button>").text("submit").click(function(){s("networks",r)}))},h=function(t){$("#adminContent").text("Loading..."),c.network.getJSON("admin.php?get="+encodeURIComponent(t),function(e){if($("#adminContent").empty(),void 0!==e.denied&&e.denied)$("#adminContent").append($("<b>").text("ERROR: Permission denied"));else{switch(t){case"index":n=e,$("#adminContent").append("OmnomIRC Version: "+n.version+"<br>",$("<span>").attr("id","fetchingUpdates").text("checking for updates..."),"<br>",$("<button>").text("Back up config").click(function(){s("backupConfig",{})}),$("<div>").attr("id","fetchingNews").text("fetching news...")),$.getJSON(c.OMNOMIRCSERVER+"/getNewestVersion.php?version="+n.version+(a.betaUpdates?"&experimental":"")+"&jsoncallback=?").done(function(t){t.latest?$("#fetchingUpdates").empty().text("No new updates available"):$("#fetchingUpdates").empty().append("New updates available! ("+t.version+") ",n.updaterReady?$("<a>").text("Click here to apply the update").attr("href","updater.php"+(void 0!==document.URL.split("network=")[1]?"?network="+document.URL.split("network=")[1].split("&")[0].split("#")[0]:"")):$("<a>").text("Click here to download the updater script").click(function(e){e.preventDefault(),s("getUpdater",{path:t.updater},function(){h("index")})}))}),$.getJSON(c.OMNOMIRCSERVER+"/getNews.php?jsoncallback=?").done(function(e){$("#fetchingNews").empty().css({height:300,border:"1px solid black",overflow:"auto",width:"70%"}).append($("<table>").css("width","100%").append($("<tr>").append($("<th>").css("width",150).text("date"),$("<th>").text("news")),$.map(e.news,function(e){return $("<tr>").append($("<td>").css({width:"auto",border:"1px solid black"}).text(new Date(1e3*e.time).toLocaleString()),$("<td>").css({width:"auto",border:"1px solid black"}).html(e.message))})))});break;case"themes":r(e.themes);break;case"channels":l(e.channels,e.nets);break;case"hotlinks":o(e.hotlinks);break;case"smileys":d(e.smileys);break;case"networks":u(e.networks,e.networkTypes);break;case"sql":i(t,"SQL",e.sql,e.pattern);break;case"ws":i(t,"WebSockets",e.websockets,e.pattern);break;case"misc":i(t,"Misc",e.misc,e.pattern);break;case"ex":i(t,"Experimental",e.ex,e.pattern);break;case"releaseNotes":$("#adminContent").append($("<h2>").text("Release notes version "+e.version),$("<span>").attr("id","releaseNotes").text("Loading...")),$.getJSON(c.OMNOMIRCSERVER+"/getReleaseNotes.php?version="+e.version+"&jsoncallback=?").done(function(e){$("#releaseNotes").html(e.notes)})}var n;window.location.hash="#"+t}})};c.error.init(),c.onerror=c.error.addError,c.onwarning=c.error.addWarning,c.settings.fetch(function(){$("#adminNav a").click(function(e){e.preventDefault(),h($(this).data("page"))}),$("#adminContent").height($(window).height()-50),$(window).resize(function(){navigator.userAgent.match(/(iPod|iPhone|iPad)/i)&&navigator.userAgent.match(/AppleWebKit/i)||$("#adminContent").height($(window).height()-50)}),c.network.getJSON("config.php?nologinerrors&admincfg",function(e){a=e;var t=window.location.hash;void 0!==t.split("#")[1]?t=t.split("#")[1]:""==t&&(t="index"),c.page.changeLinks(),h(t)})})});