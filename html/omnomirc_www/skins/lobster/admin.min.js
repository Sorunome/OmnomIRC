/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2016 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";$(function(){var e=new OmnomIRC,t=[],n=function(t,n,a){e.network.post("admin.php?set="+t,{data:JSON.stringify(n)},function(e){var t="";e.errors.length>0?$.map(e.errors,function(e){t+="ERROR: "+e+"\n"}):t=e.message,alert(t),void 0!==a&&a()})},a=function(e,t,a,r){$("#adminContent").append('<div style="font-weight:bold">'+t+" Settings</div>",i(a,r),"<br>",$("<button>").text("submit").click(function(){n(e,a)}))},i=function(e,t){var n=function(t,a){if(void 0===a&&(a=e),t=t.split("."),1==t.length)return a[t[0]];var i=t.shift();return n(t.join("."),a[i])},a=function(t,n,i){if(void 0===i&&(i=e,"boolean"==typeof n?($('[data-var="'+t+'"]').each(function(){this.checked=n}),n?$('[data-varbox="'+t+'"]').show():$('[data-varbox="'+t+'"]').hide()):($('[data-var="'+t+'"]').val(n),$('[data-varbox="'+t+'"]').hide(),$('[data-varbox="'+t+'"][data-valbox="'+n+'"]').show())),t=t.split("."),1==t.length)return void(i[t[0]]=n);var r=t.shift();a(t.join("."),n,i[r])};return $("<span>").css("display","inline-block").append($.map(t,function(t){var r,o=$("<span>");switch(t.type){case"text":o=$("<input>").attr("type","text").val(n(t["var"])).change(function(){a(t["var"],this.value)});break;case"number":o=$("<input>").attr("type","number").val(n(t["var"])).change(function(){a(t["var"],parseInt(this.value,10))});break;case"checkbox":o=$("<input>").attr("type","checkbox").change(function(){a(t["var"],this.checked)}),o[0].checked=n(t["var"]),t.pattern&&(r=i(e,t.pattern).attr("data-varbox",t["var"]),o[0].checked||r.hide());break;case"dropdown":r=$("<span>"),o=$("<select>").append($.map(t.options,function(n){return n.pattern&&r.append(i(e,n.pattern).attr("data-varbox",t["var"]).attr("data-valbox",n.val)),$("<option>").val(n.val).text(n.name)})).val(n(t["var"])).change(function(){a(t["var"],this.value)}),r.children().hide(),r.find('[data-valbox="'+n(t["var"])+'"]').show();break;case"newline":return"<br>";case"info":return[$("<b>").text(t.name),"<br>"];case"more":return r=i(e,t.pattern).css({border:"1px solid black",padding:5}).hide(),[$("<b>").text(t.name),"&nbsp;",$("<a>").text("show/hide").click(function(e){e.preventDefault(),r.toggle()}),"<br>",r,"<br>"]}return o.attr("data-var",t["var"]),[t.name+":&nbsp;",o,"<br>",r?r:""]}))},r=function(e){$("#adminContent").append('<div style="font-weight:bold">Theme Settings</div>',$("<span>").append($.map(e,function(t,n){return[$("<span>").text(t.name)," ",$("<a>").text("edit").click(function(a){a.preventDefault(),e[n].lastModified=-1,$(this).parent().replaceWith($("<span>").append($("<a>").text("Back").click(function(t){t.preventDefault(),$("#adminContent").empty(),r(e)}),"<br><br>Name:",$("<input>").attr("type","text").val(t.name).change(function(){e[n].name=this.value}),$.map([{name:"Background",type:"bg"},{name:"Alternative background",type:"bg2"},{name:"Border",type:"border"},{name:"Text",type:"text"},{name:"Links",type:"link"},{name:"Tab links",type:"tablink",use:"Links"},{name:"Buttons",type:"btn",use:"Alternative background"},{name:"Button Hover",type:"btnhover",use:"Alternative background"},{name:"Input bar",type:"form",use:"Background"},{name:"Popup background",type:"popupbg",use:"Alternative background"},{name:"Popup border",type:"popupborder",use:"Border"}],function(a){return["<br>",void 0!==a.use?$("<span>").append("Use instead of ",a.use,$("<input>").attr("type","checkbox").attr(t["use"+a.type]?"checked":"false","checked").change(function(){e[n]["use"+a.type]=this.checked})):"",a.name,":",$("<input>").attr("type","color").val(t.colors[a.type]).change(function(){e[n].colors instanceof Array&&(e[n].colors={}),e[n].colors[a.type]=this.value})]}),"<br>Extra style sheet:",$("<input>").attr("type","text").val(t.sheet).change(function(){e[n].sheet=this.value})))}),"<br>"]}),"<br>",$("<a>").text("add Theme").click(function(t){t.preventDefault();var n=prompt("new theme name");""!==n&&null!==n&&(e.push({name:n,colors:{},lastModified:-1}),$("#adminContent").empty(),r(e))})),"<br>",$("<button>").text("submit").click(function(){n("themes",e)}))},o=function(e,t){var a=function(n,i,r){$(r).empty().append($.map(n.networks,function(r,o){return[$("<div>").css({display:"inline-block",border:"1px solid black",margin:5}).append($("<b>").text(t[r.id].name)," ",$("<a>").text("remove").click(function(t){t.preventDefault(),e[i].networks.splice(o,1),n=e[i],a(n,i,$(this).parent().parent())}),"<br>Name:",$("<input>").attr("type","text").val(r.name).change(function(){e[i].networks[o].name=this.value}),1==t[r.id].type?["<br>Hidden:",$("<input>").attr("type","checkbox").attr(r.hidden?"checked":"false","checked").change(function(){e[i].networks[o].hidden=this.checked}),"<br>Order:",$("<input>").attr("type","number").val(r.order).change(function(){e[i].networks[o].order=parseInt($(this).val(),10)})]:""),"<br>"]}),$("<select>").append($("<option>").text("Add to network...").val(-1),$.map(t,function(e){if(0!==e.type)return $("<option>").text(e.name).val(e.id)})).change(function(){var t=parseInt($(this).val(),10),r=0;return $.each(e,function(e,n){$.each(n.networks,function(n,a){a.id==t&&a.order>r&&r!=-1&&(r=a.order),a.id==t&&e==i&&(r=-1)})}),r==-1?(alert("Network already exists!"),void $(this).val(-1)):(e[i].networks.push({id:t,name:n.networks.length>0?n.networks[0].name:n.alias,hidden:!1,order:r+1}),n=e[i],void a(n,i,$(this).parent()))}))};$("#adminContent").append('<div style="font-weight:bold">Channel Settings</div>',$("<div>").append($.map(e,function(n,i){return $("<div>").css({display:"inline-block",border:"1px solid black","vertical-align":"top"}).append($("<b>").text(n.alias)," (",$("<a>").text("delete").click(function(a){a.preventDefault(),confirm("Are you sure you want to delete channel "+n.alias+"?\nThis will also delete all data (messages etc) associated with that channel!")&&(e.splice(i,1),$("#adminContent").empty(),o(e,t))}),")<br>Enabled:",$("<input>").attr("type","checkbox").attr(n.enabled?"checked":"false","checked").change(function(){e[i].enabled=this.checked}),"<br>",$("<div>").css({display:"inline-block",border:"1px solid black"}).append($("<input>").attr("type","text").val(n.networks.length>0?n.networks[0].name:n.alias).change(function(){var t=this;$.each(n.networks,function(n){e[i].networks[n].name=$(t).val()})}),"<br>",$("<a>").text("Show advanced settings").click(function(e){e.preventDefault(),a(n,i,$(this).parent())})))}),$("<button>").text("New Channel").click(function(n){n.preventDefault();var a=prompt("New Channel alias"),i=[],r=0;""!==a&&null!==a&&(i=$.map(t,function(t){var n=0;if(1==t.type&&$.each(e,function(e,a){$.each(a.networks,function(e,a){a.id==t.id&&a.order>n&&n!=-1&&(n=a.order)})}),0!==t.type)return{id:t.id,name:"",hidden:!1,order:n+1}}),$.each(e,function(e,t){t.id>r&&(r=t.id)}),e.push({id:r+1,alias:a,enabled:!0,networks:i}),$("#adminContent").empty(),o(e,t))})),"<br>",$("<button>").text("submit").click(function(){n("channels",e)}))},c=function(e){var t=function(n,a){n.empty().append($.map(e[a],function(i,r){if("inner"!=r)return["<br>",$("<span>").text(r).html(),":",$("<input>").attr("type","text").css("width",120).val(e[a][r]).change(function(){e[a][r]=this.value}),$("<a>").text("x").click(function(i){i.preventDefault(),"inner"!=r&&(delete e[a][r],t(n,a))})]}),"<br>",$("<button>").text("New Attribute").click(function(i){i.preventDefault();var r=prompt("new attribute name");""!==r&&null!==r&&(e[a][r]="",t(n,a))}))};$("#adminContent").append('<div style="font-weight:bold">Hotlinks Settings</div>',$.map(e,function(n,a){var i=$("<div>");return t(i,a),$("<div>").css({display:"inline-block",border:"1px solid black","vertical-align":"top"}).append($("<input>").attr("type","text").css("width",160).val(e[a].inner).change(function(){e[a].inner=this.value}),"<br>",$("<a>").text("<").click(function(t){if(t.preventDefault(),0!=a){var n=e[a-1];e[a-1]=e[a],e[a]=n,$("#adminContent").empty(),c(e)}}),"&nbsp;&nbsp;",$("<a>").text("x").click(function(t){t.preventDefault(),confirm("Are you sure you want to remove this hotlink?")&&(e.splice(a,1),$("#adminContent").empty(),c(e))}),"&nbsp;&nbsp;",$("<a>").text(">").click(function(t){if(t.preventDefault(),a!=e.length-1){var n=e[a+1];e[a+1]=e[a],e[a]=n,$("#adminContent").empty(),c(e)}}),"<br>",i)}),$("<button>").text("New Hotlink").click(function(t){t.preventDefault();var n=prompt("new hotlink name");""!==n&&null!==n&&(e.push({inner:n}),$("#adminContent").empty(),c(e))}),"<br><br>",$("<button>").text("submit").click(function(){n("hotlinks",e)}))},s=function(e){var t=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},a=$("<div>"),i=$("<div>").append($.map(e,function(n,i){var r=$("<img>"),o=e[i].code;return r.attr("src",n.pic).css({"margin-left":5,cursor:"pointer"}).click(function(){var n=!1;a.empty().append($("<a>").text("Remove this smiley").click(function(t){t.preventDefault(),confirm("Are you sure you want to remove this smiley?")&&(e.splice(i,1),$("#adminContent").empty(),s(e))}),"<br>","Picture URL:",$("<input>").attr("type","text").val(e[i].pic).change(function(){e[i].pic=this.value,r.attr("src",this.value)}),"<br>","Code:",$("<input>").attr("type","text").val(e[i].code).change(function(a){if(e[i].code=this.value,!n){if(window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),(e[i].regex!=t(o)||'<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>'!=e[i].replace)&&!confirm("Also change regex/replace? They have been manually changed in the advanced settings!"))return;e[i].regex=t(this.value),e[i].replace='<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>',o=this.value}}),"<br>","Show in menu:",$("<input>").attr("type","checkbox").attr(e[i].inMenu?"checked":"false","checked").change(function(){e[i].inMenu=this.checked}),"<br>","Alt (mouseover):",$("<input>").attr("type","text").val(e[i].alt).change(function(){e[i].alt=this.value}),"<br>",$("<a>").text("Show advanced settings").click(function(t){t.preventDefault(),n=!0,$(this).replaceWith($("<span>").append("Regex:",$("<input>").attr("type","text").val(e[i].regex).change(function(t){e[i].regex=this.value}),"<br>","Replace:",$("<input>").attr("type","text").val(e[i].replace).change(function(t){e[i].replace=this.value})))}))})}));$("#adminContent").append('<div style="font-weight:bold">Smiley Settings</div>',a,"<br>",i,"<br>",$("<button>").text("New Smiley").click(function(n){n.preventDefault();var a=prompt("New image location"),i=prompt("New smiley code");""!==a&&null!==a&&""!==i&&null!==i&&(e.push({pic:a,alt:i,code:i,inMenu:!0,regex:t(i),replace:'<img src="PIC" alt="ALT" title="ALT" ADDSTUFF>'}),$("#adminContent").empty(),s(e))}),"<br><br>",$("<button>").text("submit").click(function(){n("smileys",e)}))},p=function(t,a){$("#adminContent").append('<div style="font-weight:bold">Network Settings</div>',$("<div>").append($.map(t,function(n,r){if(0!==n.type)return[$("<span>").text(n.name)," ",$("<a>").text("edit").click(function(o){o.preventDefault();var c=$("<b>").text("Unkown network type, perhaps the bot isn't running?");switch(n.type){case 0:c.text("Server Network");break;case 1:c=$("<span>").append($("<b>").text("OmnomIRC network"),"<br>Theme:",$("<span>").text("loading...").on("now",function(){var t=this;e.network.getJSON("admin.php?get=themes",function(e){$(t).replaceWith($("<select>").append($("<option>").val(-1).text("default"),$.map(e.themes,function(e,t){return $("<option>").val(t).text(e.name)})).val(n.config.theme?n.config.theme:0).change(function(){n.config.theme=parseInt(this.value,10)}))})}).trigger("now"),"<br>",$("<button>").text("Use Current settings as defaults").click(function(){n.config.defaults=e.options.getAll(),alert("Defaults set")}),"<br>",$("<select>").append($("<option>").val(0).text("Deny Guest Access"),$("<option>").val(1).text("Guests are read-only"),$("<option>").val(2).text("Guests may chat")).val(n.config.guests?n.config.guests:0).change(function(e){n.config.guests=parseInt(this.value,10)}),"<br>Extra Channels Message:<br>",$("<textarea>").text(n.config.extraChanMsg?n.config.extraChanMsg:"").change(function(){n.config.extraChanMsg=this.value}),"<br>",$("<a>").text("Show advanced settings").click(function(t){t.preventDefault(),$(this).replaceWith($("<span>").append("<br>checkLogin hook:",$("<span>").text("loading...").on("now",function(){var t=this;e.network.getJSON("admin.php?get=checkLogin&i="+r.toString(10),function(e){var a="";return e.success===!1?a="ERROR: couldn't reach checkLogin server, perhaps the changed URL needs to be saved?":e.auth===!1&&(a="ERROR: couldn't identify with checkLogin server, perhaps sigKey is false?"),""!==a?void $(t).replaceWith($("<span>").append(a)):void $(t).replaceWith($("<select>").append($.map(e.checkLogin.hooks,function(e){return $("<option>").val(e).text(e)})).val(e.checkLogin.hook).change(function(){n.config.checkLoginHook=this.value}))})}).trigger("now"),"<br>checkLogin:",$("<input>").attr("type","text").val(n.config.checkLogin).change(function(){n.config.checkLogin=this.value}),"<br>checkLogin absolute path, if on same server (empty for skip):",$("<input>").attr("type","text").val(n.config.checkLoginAbs).change(function(){n.config.checkLoginAbs=this.value}),"<br>Same-page links (comma-seperated):",$("<input>").attr("type","text").val(n.config.spLinks.join(",")).change(function(){n.config.spLinks=this.value.split(",")})))}));break;default:a[n.type]&&(c=$("<span>").append($("<b>").text(a[n.type].name+" Network")," (",$("<a>").text("restart").click(function(t){t.preventDefault(),confirm("Are you sure you want to restart the network "+n.name+"?")&&e.network.getJSON("admin.php?set=restartNetwork&nid="+encodeURIComponent(n.id),function(e){})}),")<br>",i(n.config,a[n.type].editPattern)))}$(this).parent().replaceWith($("<div>").append($("<a>").text("back").click(function(e){$("#adminContent").empty(),p(t,a)}),"<br><br>",$("<span>").append($("<span>").css("font-weight","bold").text(n.name),"&nbsp;",$("<a>").text("edit").click(function(e){e.preventDefault(),$(this).parent().replaceWith($("<input>").attr("type","text").val(n.name).change(function(){n.name=this.value}))})),"<br>Enabled:",$("<input>").attr("type","checkbox").attr(n.enabled?"checked":"false","checked").change(function(){n.enabled=this.checked}),"<br>Normal:",$("<input>").attr("type","text").val(n.normal).change(function(){t[r].normal=this.value}),"<br>Userlist:",$("<input>").attr("type","text").val(n.userlist).change(function(){t[r].userlist=this.value}),"<br>IRC:",$("<input>").attr("type","number").val(n.irc.color).css("width",50).change(function(){n.irc.color=parseInt($(this).val(),10)}),$("<input>").attr("type","text").val(n.irc.prefix).css("width",50).change(function(){n.irc.prefix=this.value}),"<br>",c))}),"<br>"]}),$("<select>").append($("<option>").val(-1).text("Add Network..."),$.map(a,function(e){return $("<option>").val(e.id).text(e.name)})).change(function(){var e,n,i=prompt("New Network Name"),r=null;if(""!==i&&null!==i){var o=parseInt($(this).val(),10);switch(o){case 1:e={checkLogin:"link to checkLogin file",checkLoginAbs:"",spLinks:[],theme:-1,defaults:{},guests:0};break;default:e=!!a[o]&&a[o].defaultCfg}e&&(n=0,$.each(t,function(e,t){t.id>n&&(n=t.id)}),r={enabled:!0,id:n+1,type:o,normal:"NICK",userlist:"("+i[0].toUpperCase()+")NICK",irc:{color:-1,prefix:"("+i[0].toUpperCase()+")"},name:i,config:e},t.push(r),$("#adminContent").empty(),p(t,a))}else alert("Invalid network type"),$(this).val(-1)})),"<br>",$("<button>").text("submit").click(function(){n("networks",t)}))},l=function(a){$("#adminContent").append("OmnomIRC Version: "+a.version+"<br>",$("<span>").attr("id","fetchingUpdates").text("checking for updates..."),"<br>",$("<button>").text("Back up config").click(function(){n("backupConfig",{})}),$("<div>").attr("id","fetchingNews").text("fetching news...")),$.getJSON(e.OMNOMIRCSERVER+"/getNewestVersion.php?version="+a.version+(t.betaUpdates?"&experimental":"")+"&jsoncallback=?").done(function(e){e.latest?$("#fetchingUpdates").empty().text("No new updates available"):$("#fetchingUpdates").empty().append("New updates available! ("+e.version+") ",a.updaterReady?$("<a>").text("Click here to apply the update").attr("href","updater.php"+(void 0!==document.URL.split("network=")[1]?"?network="+document.URL.split("network=")[1].split("&")[0].split("#")[0]:"")):$("<a>").text("Click here to download the updater script").click(function(t){t.preventDefault(),n("getUpdater",{path:e.updater},function(){d("index")})}))}),$.getJSON(e.OMNOMIRCSERVER+"/getNews.php?jsoncallback=?").done(function(e){$("#fetchingNews").empty().css({height:300,border:"1px solid black",overflow:"auto",width:"70%"}).append($("<table>").css("width","100%").append($("<tr>").append($("<th>").css("width",150).text("date"),$("<th>").text("news")),$.map(e.news,function(e){return $("<tr>").append($("<td>").css({width:"auto",border:"1px solid black"}).text(new Date(1e3*e.time).toLocaleString()),$("<td>").css({width:"auto",border:"1px solid black"}).html(e.message))})))})},d=function(t){$("#adminContent").text("Loading..."),e.network.getJSON("admin.php?get="+encodeURIComponent(t),function(n){if($("#adminContent").empty(),void 0!==n.denied&&n.denied)return void $("#adminContent").append($("<b>").text("ERROR: Permission denied"));switch(t){case"index":l(n);break;case"themes":r(n.themes);break;case"channels":o(n.channels,n.nets);break;case"hotlinks":c(n.hotlinks);break;case"smileys":s(n.smileys);break;case"networks":p(n.networks,n.networkTypes);break;case"sql":a(t,"SQL",n.sql,n.pattern);break;case"ws":a(t,"WebSockets",n.websockets,n.pattern);break;case"misc":a(t,"Misc",n.misc,n.pattern);break;case"ex":a(t,"Experimental",n.ex,n.pattern);break;case"releaseNotes":$("#adminContent").append($("<h2>").text("Release notes version "+n.version),$("<span>").attr("id","releaseNotes").text("Loading...")),$.getJSON(e.OMNOMIRCSERVER+"/getReleaseNotes.php?version="+n.version+"&jsoncallback=?").done(function(e){$("#releaseNotes").html(e.notes)})}window.location.hash="#"+t})};e.error.init(),e.onerror=e.error.addError,e.onwarning=e.error.addWarning,e.settings.fetch(function(){$("#adminNav a").click(function(e){e.preventDefault(),d($(this).data("page"))}),$("#adminContent").height($(window).height()-50),$(window).resize(function(){navigator.userAgent.match(/(iPod|iPhone|iPad)/i)&&navigator.userAgent.match(/AppleWebKit/i)||$("#adminContent").height($(window).height()-50)}),e.network.getJSON("config.php?nologinerrors&admincfg",function(n){t=n;var a=window.location.hash;void 0!==a.split("#")[1]?a=a.split("#")[1]:""==a&&(a="index"),e.page.changeLinks(),d(a)})})});