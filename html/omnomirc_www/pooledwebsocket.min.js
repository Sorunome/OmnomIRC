(function(e,n){var o={handler:null,worker:null,queue:[],events:{},postMessage:function(e,n){var r=[JSON.stringify(e),n];console.info("postMessage: "+JSON.stringify(r));o.queue.push(r);if(o.handler){o.queue.forEach(function(e){o.handler.apply(o,e)});o.queue=[]}},open:function(e,n){o.postMessage({action:"open",url:e,protocols:n})},on:function(e,n,r){o.events[n]||(o.events[n]=[]);o.events[n].push(r)}},r=function(e){o.handler=function(e){return window.postMessage.call(window,e,location.origin)};o.detach=function(e){};window.addEventListener("message",function(e){if(e.origin==location.origin){o.onmessage(e)}});e&&console.error(e);console.info("Reverting to non-pooled")};o.onmessage=function(e){if(e.data){var n=JSON.parse(e.data);switch(n.action){case"event":console.info("Event: "+n.event+" "+JSON.stringify(n.arguments));o.events[n.event]&&o.events[n.event].forEach(function(e){e.apply({},n.arguments)});break;case"property":o.onmessage({data:JSON.stringify({action:"event",event:"property",arguments:[n.name,n.value]})});break}}};e.PooledWebSocket=function(e,n){var t={},s={},i={},a={open:[],message:[],error:[],close:[]},c={open:[],message:[],error:[],close:[]},u="websocketworker.min.js";if(e.split("/").length>=4){u+="?"+e.split("/").splice(3).join("/")}console.info("Using workerpath "+u);if("SharedWorker"in window){console.info("Using shared worker for pool");var f=new SharedWorker(u);o.worker=f;o.handler=function(){return f.port.postMessage.apply(f.port,arguments)};o.detach=function(e){o.postMessage({action:"detach",url:e})};f.port.onmessage=function(e){o.onmessage(e)};f.onerror=function(e){console.error(e)};f.port.start()}else if("serviceWorker"in navigator){console.info("Using service worker for pool");(function(){var e={postMessage:function(){n.push(arguments)}},n=[];o.worker=e;o.handler=function(){return e.postMessage.apply(e,arguments)};o.detach=function(e){};navigator.serviceWorker.oncontrollerchange=function(n){e=reg.active||reg.waiting||reg.installing||navigator.serviceWorker};navigator.serviceWorker.onmessage=function(e){o.onmessage(e)};navigator.serviceWorker.register(u,{}).then(function(r){console.info("Service worker registered");e=r.active||r.waiting||r.installing||navigator.serviceWorker.controller;o.worker=e;while(n.length){e.postMessage.apply(e,n.shift())}e.onstatechange=function(n){if(n.target.state!="activated"){console.info("Using new service worker");e=n.target}}}).catch(r)})()}else if("Worker"in window){console.info("Using shared worker for pool");var f=new Worker(u);o.worker=f;o.handler=function(){return f.postMessage.apply(f,arguments)};o.detach=function(e){};f.onmessage=function(e){o.onmessage(e)};f.onerror=function(e){console.error(e)}}else{return new WebSocket(e,n)}Object.defineProperties(t,{readyState:{get:function(){return s["readyState"]}},extensions:{get:function(){return s["extensions"]}},protocol:{get:function(){return s["protocol"]}},url:{get:function(){return s["url"]}},onopen:{get:function(){return i.onopen},set:function(e){i.onopen=e;t.runQueue("open")}},onmessage:{get:function(){return i.onmessage},set:function(e){i.onmessage=e;t.runQueue("message")}},onerror:{get:function(){return i.onerror},set:function(e){i.onerror=e;t.runQueue("error")}},onclose:{get:function(){return i.onclose},set:function(e){i.onclose=e;t.runQueue("close")}},events:{get:function(){return a}},pool:{get:function(){return o}}});t.runQueue=function(e){if(c[e]){c[e].forEach(function(n){a[e].forEach(function(e){e.apply(t,n)});i["on"+e]&&i["on"+e].apply(t,n)});if(a[e].length>0||i["on"+e]){c[e]=[]}}return t};t.fire=function(e,n){c[e].push(n);t.runQueue(e)};t.on=function(e,n){a[e]||(a[e]=[]);a[e].push(n);t.runQueue(e);return t};t.off=function(e,n){if(a[e]&&a[e].indexOf(n)!=-1){a[e].splice(a[e].indexOf(n),1)}return t};t.addEventListener=t.on;t.send=function(n){o.postMessage({action:"send",url:e,data:n})};t.detach=function(){o.detach(e)};t.close=function(){o.postMessage({action:"close",url:e})};t.reconnect=function(){t.close();o.open(e,n)};t.open=function(){if(t.readyState==3){o.open(e,n)}else{throw new Error("PooledWebSocket is already open")}};o.open(e,n);o.on(e,"open",function(){t.fire("open",arguments)});o.on(e,"message",function(){t.fire("message",arguments)});o.on(e,"property",function(e,n){s[e]=n});o.on(e,"error",function(){t.fire("error",arguments)});o.on(e,"close",function(){t.fire("close",arguments)});return t}})(window);