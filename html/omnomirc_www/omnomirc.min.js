/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2017 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";function OmnomIRC(){var r,o,e,s,l,i,t,c,n,a,d,g,h,f,p,m,w,v,k,b,C,S="https://omnomirc.omnimaga.org",y="",x=!1,P=function(e){return void 0!==document.URL.split(e+"=")[1]?document.URL.split(e+"=")[1].split("&")[0].split("#")[0]:""},N=function(e,t){if(void 0===t&&(t=!1),!t||"highlight"!=e.type){if(!t&&"highlight"!=e.type&&"internal"!=e.type&&e.chan==I.get("chan")){var n=I.get("lines");n.push(e),200<n.length&&n.shift(),I.set("lines",n),-1!=["part","quit","join","nick"].indexOf(e.type)&&I.set("users",A.getUsers())}null!==e.name&&-1!=e.network&&(t||j.isNew(e.curline))?(j.setCurline(e.curline),!1!==r.onmessageraw?r.onmessageraw(e,t):J.addLine(e,t)):j.setCurline(e.curline)}},O={identGuest:(C={hostname:"",nick:"",signature:"",numHigh:4,uid:-1,net:"",networks:{},pmIdent:!1,guestLevel:0,isGuest:!0,identGuest:function(t,e,n,s){void 0===s&&(s=n,n=!1),console.log("trying login"),L.getJSON("misc.php?identName="+base64.encode(t)+"&nick="+base64.encode(t)+"&signature="+base64.encode(e)+"&id=-1&network="+C.net,function(e){e.success&&(n?(R.set("guestName",t),R.set("guestSig",e.signature)):(R.set("guestName",""),R.set("guestSig","")),C.setIdent(t,e.signature,-1),j.identify()),void 0!==s&&s(e)},!0,!1)},logout:function(){C.setIdent("","",-1),R.remove("guestName"),R.remove("guestSig"),I.remove("config"),I.remove("checkLogin"),j.identify()},login:function(e,t,n){void 0===n&&(n=-1),C.setIdent(e,t,n),j.identify()},fetch:function(s,o){var e=function(e){if(!o){try{sessionStorage.setItem("defaultNetwork",e.defaultNetwork)}catch(e){}I.set("config",e),C.hostname=e.hostname,D.setChans(e.channels),J.setSmileys(e.smileys),r.onsmileychange(e.smileys),J.setSpLinks(e.spLinks),C.guestLevel=e.guests,C.networks={},$.each(e.networks,function(e,t){C.networks[t.id]=t}),C.net=e.network,R.setPrefix(C.net),E.setDefaults(e.defaults),E.setExtraChanMsg(e.extraChanMsg),j.setData(e.websockets.use,e.websockets.host,e.websockets.port,e.websockets.ssl)}var t=I.get("checkLogin");if(t&&!o){C.nick=t.nick,C.signature=t.signature,C.uid=t.uid,C.pmIdent="["+C.net.toString()+","+C.uid.toString()+"]",C.isGuest=""===e.signature;var n=P("uid");return""!==n&&n!=C.uid?(I.remove("config"),I.remove("checkLogin"),void C.fetch(s,o)):void(void 0!==s&&s())}C.loggedIn()&&C.isGuest?C.identGuest(C.nick,function(e){e.success&&(C.signature=e.signature),void 0!==s&&s()}):L.getJSON(e.checkLoginUrl+"&network="+C.net.toString()+"&jsoncallback=?",function(e){I.set("checkLogin",{nick:e.nick,signature:e.signature,uid:e.uid}),C.nick=e.nick,C.signature=e.signature,C.uid=e.uid,C.pmIdent="["+C.net.toString()+","+C.uid.toString()+"]",C.isGuest=""===e.signature,void 0!==s&&s()},!0,!1)};if(void 0===o&&(o=!1),o&&C.loggedIn()&&C.isGuest)return console.log("i am silly"),void C.identGuest(C.nick,function(e){e.success&&(C.signature=e.signature),void 0!==s&&s()});if(!o){var t=I.get("config");if(t)return void e(t)}I.determinePrefix(),L.getJSON("config.php?js&network="+P("network")+(o?"&clonly":""),e,!0,!1)},setIdent:function(e,t,n){C.nick=e,C.signature=t,C.uid=n,I.set("checkLogin",{nick:e,signature:t,uid:n})},getUrlParams:function(){return"nick="+base64.encode(C.nick)+"&signature="+base64.encode(C.signature)+"&time="+(+new Date).toString()+"&id="+C.uid+"&network="+C.net+"&noLoginErrors"},getNetwork:function(e){return void 0!==C.networks[e]?C.networks[e]:{id:-1,normal:"NICK",userlist:"NICK",name:"Invalid network",type:-1}},getIdentParams:function(){return{nick:C.nick,signature:C.signature,time:(+new Date).toString(),id:C.uid,network:C.net}},loggedIn:function(){return""!==C.signature},getWholePmIdent:function(e,t){var n="["+t.toString()+","+e.toString()+"]";return t<C.net?n+C.pmIdent:C.net<t?C.pmIdent+n:e<C.uid?n+C.pmIdent:C.pmIdent+n}}).identGuest,fetch:C.fetch,getUrlParams:C.getUrlParams,getIdentParams:C.getIdentParams,getNetwork:C.getNetwork,nick:function(){return C.nick},net:function(){return C.net},loggedIn:C.loggedIn,guestLevel:function(){return C.guestLevel},getPmIdent:function(){return C.pmIdent},isGuest:function(){return C.isGuest},numHigh:function(){return C.numHigh},getWholePmIdent:C.getWholePmIdent,logout:C.logout,login:C.login},R={setPrefix:(b={prefix:P("network"),setPrefix:function(e){b.prefix=e?e.toString():""},getCookie:function(e){var t,n,s,o=document.cookie.split(";");for(t=0;t<o.length;t++)if(n=o[t].substr(0,o[t].indexOf("=")),s=o[t].substr(o[t].indexOf("=")+1),(n=n.replace(/^\s+|\s+$/g,""))==e)return unescape(s)},setCookie:function(e,t,n){var s=new Date,o=escape(t);s.setDate(s.getDate()+n),o+=null===n?"":"; expires="+s.toUTCString(),document.cookie=e+"="+o},haveSupport:null,support:function(){if(null===b.haveSupport)try{localStorage.setItem("test",1),b.haveSupport=1==localStorage.getItem("test"),localStorage.removeItem("test"),b.haveSupport=!0}catch(e){b.haveSupport=!1}return b.haveSupport},get:function(e){var t;e=b.prefix+e,t=b.support()?localStorage.getItem(e):b.getCookie(e);try{return JSON.parse(t)}catch(e){return}},set:function(e,t){e=b.prefix+e,t=JSON.stringify(t),b.support()?localStorage.setItem(e,t):b.setCookie(e,t)},remove:function(e,t){e=b.prefix+e,b.support()?localStorage.removeItem(e):b.setCookie(e,"",-1)}}).setPrefix,get:b.get,set:b.set,remove:b.remove},I={determinePrefix:(k={prefix:P("network"),setPrefix:function(e){e&&(k.prefix=e.toString())},determinePrefix:function(){k.haveSupport=null},haveSupport:null,support:function(){if(null===k.haveSupport)try{sessionStorage.setItem("test",1),k.haveSupport=1==sessionStorage.getItem("test"),sessionStorage.removeItem("test"),k.haveSupport&&""==k.prefix&&k.setPrefix(sessionStorage.getItem("defaultNetwork"))}catch(e){k.haveSupport=!1}return k.haveSupport},get:function(e){if(k.support())try{return JSON.parse(sessionStorage.getItem(k.prefix+e))}catch(e){return}},set:function(e,t){k.support()&&sessionStorage.setItem(k.prefix+e,JSON.stringify(t))},remove:function(e){k.support()&&sessionStorage.removeItem(k.prefix+e)}}).determinePrefix,get:k.get,set:k.set,remove:k.remove},L={getJSON:(v={didRelog:!1,removeSig:function(t){try{var e=t.split("signature="),n=e[1].split("&");return n[0]="---",e[1]=n.join("&"),e.join("signature=")}catch(e){return-1!==t.indexOf("signature")?"omited due to security reasons":t}},addError:function(e,t){e=v.removeSig(e),r.onerror(e,t)},addWarning:function(e,t){e=v.removeSig(e),r.onwarning(e,t)},checkCallback:function(e,t,n,s){2!=e.relog&&(void 0!==e.errors&&$.map(e.errors,function(e){void 0!==e.type?v.addError(s,e):v.addError(s,{type:"misc",message:e})}),void 0!==e.warnings&&$.map(e.warnings,function(e){void 0!==e.type?v.addWarning(s,e):v.addWarning(s,{type:"misc",message:e})})),void 0!==e.relog&&0!=e.relog?1==e.relog?(O.fetch(void 0,!0),t(e)):2!=e.relog||v.didRelog?t(e):(v.didRelog=!0,O.fetch(function(){n()},!0)):(void 0!==e.relog&&(v.didRelog=!1),t(e))},getJSON:function(t,n,s,o){null==s&&(s=!0),null==o&&(o=!0),-1==t.indexOf("?")&&o&&(t+="?");var i=t+(o?"&"+O.getUrlParams():"");return $.ajax({url:i,dataType:"json",async:s}).done(function(e){v.checkCallback(e,n,function(){v.getJSON(t,n,s,o)},i)})},post:function(t,n,s,o,i){null==o&&(o=!0),null==i&&(i=!0),-1==t.indexOf("?")&&i&&(t+="?");var r=t+(i?"&"+O.getUrlParams():"");return $.ajax({type:"POST",url:r,async:o,data:n}).done(function(e){v.checkCallback(e,s,function(){v.post(t,n,s,o,i)},r)})}}).getJSON,post:v.post},E={set:(w={extraChanMsg:"",allOptions:{highBold:{disp:"Highlight Bold",default:!0},highRed:{disp:"Highlight Red",default:!0},colordNames:{disp:"Colored Names",default:0,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){w.set("colordNames",this.value)}).append($.map(["none","calc","server"],function(e,t){return $("<option>").attr(w.get("colordNames")==t?"selected":"false","selected").val(t).text(e)})))}},curChan:{hidden:!0,default:0},extraChans:{disp:"Show extra Channels",default:!1,before:function(){return""!==w.extraChanMsg&&alert(w.extraChanMsg),!0}},ding:{disp:"Ding on Highlight",default:!1},smileys:{disp:"Show Smileys",default:!0},charsHigh:{disp:"Number chars for Highlighting",default:4,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){w.set("charsHigh",this.value)}).append($.map([1,2,3,4,5,6,7,8,9,10],function(e){return $("<option>").attr(w.get("charsHigh")==e?"selected":"false","selected").val(e).text(e)})))}},oircJoinPart:{disp:"Show OmnomIRC join/part messages",default:!1},textDeco:{disp:"Enable simple text decorations",default:!1},statusBar:{disp:"Show Updates in Browser Status Bar",default:!0},browserNotifications:{disp:"Browser Notifications",default:!1,before:function(){return _.request(),!1}},wysiwyg:{disp:"Use WYSIWYG editor",default:!1}},set:function(e,t){if(void 0!==w.allOptions[e]){w.allOptions[e].value=t;var n=R.get("options")||{};n[e]=t,R.set("options",n)}},get:function(e){if(void 0!==w.allOptions[e])return w.allOptions[e].value},setExtraChanMsg:function(e){w.extraChanMsg=e},setDefaults:function(s){var o=R.get("options");$.each(w.allOptions,function(e,t){var n=t.default;o&&void 0!==o[e]?n=o[e]:s&&void 0!==s[e]&&(n=s[e]),w.allOptions[e].value=n})},getAll:function(e){if(e)return w.allOptions;var n={};return $.each(w.allOptions,function(e,t){void 0!==t.hidden&&t.hidden||(n[e]=t.value)}),n},setAll:function(e){w.allOptions=e}}).set,get:w.get,setDefaults:w.setDefaults,setExtraChanMsg:w.setExtraChanMsg,getAll:w.getAll,setAll:w.setAll},T={init:(m={id:Math.random().toString(36)+(new Date).getTime().toString(),update:function(){R.set("browserTab",m.id),R.set("newInstant",!1)},init:function(){R.set("browserTab",m.id),$(window).focus(function(){m.update()}).unload(function(){m.kill()})},current:function(){return R.get("newInstant")&&m.update(),m.id==R.get("browserTab")},kill:function(){R.set("newInstant",!0),$(window).off("focus").off("unload")}}).init,current:m.current,kill:m.kill},j={joinChan:(p={ws:{socket:!1,connected:!1,use:!0,sendBuffer:[],allowLines:!1,enabled:!1,host:"",port:0,ssl:!0,tryFallback:!0,didRelog:!1,fallback:function(){if(console.log("trying fallback..."),p.ws.tryFallback){try{p.ws.tryFallback=!1,p.ws.socket.close()}catch(e){}p.ws.use=!1,p.old.lastSuccess=(new Date).getTime(),p.old.start()}},identify:function(){p.ws.send($.extend({action:"ident"},O.getIdentParams())),p.ws.send({action:"charsHigh",chars:E.get("charsHigh")})},init:function(){if(!("WebSocket"in window&&p.ws.enabled))return p.ws.use=!1;try{var t=window.location.pathname.split("/");t.pop(),1<t.length&&""===t[t.length-1]&&t.pop(),t.push("ws"),t.push(O.net()),p.ws.socket=new PooledWebSocket((p.ws.ssl?"wss://":"ws://")+p.ws.host+":"+p.ws.port.toString()+t.join("/"))}catch(e){return console.log(p.ws.socket),console.log((p.ws.ssl?"wss://":"ws://")+p.ws.host+":"+p.ws.port.toString()+t.join("/")),console.log(e),void p.ws.fallback()}return p.ws.socket.onopen=function(e){p.ws.connected=!0;for(var t=0;t<p.ws.sendBuffer.length;t++)p.ws.send(p.ws.sendBuffer[t]);p.ws.sendBuffer=[]},p.ws.socket.onmessage=function(e){try{var t=JSON.parse(e.data);console.log(t),p.ws.allowLines&&(void 0!==t.line&&(N(t.line)&&(p.ws.tryFallback=!1,delete p.ws.socket),console.log("Added line!")),void 0!==t.users&&A.setUsers(t.users)),void 0!==t.relog&&0!=t.relog&&t.relog<3&&(p.ws.didRelog||(p.ws.didRelog=!0,O.fetch(function(){O.loggedIn()&&(p.ws.identify(),p.ws.didRelog=!1)},!0)))}catch(e){console.log("ERROR!"),console.log(e)}},p.ws.socket.onclose=function(e){console.log("CLOOOOOOOOOSE"),console.log(e),p.ws.use=!1,p.ws.fallback()},p.ws.socket.onerror=function(e){console.log("ERRRORRRR"),console.log(e),delete p.ws.socket,p.ws.use=!1,p.ws.fallback()},p.ws.identify(),$(window).on("beforeunload",function(){p.partChan(D.current().handler),delete p.ws.socket}),!0},send:function(e){p.ws.connected?p.ws.socket.send(JSON.stringify(e)):p.ws.sendBuffer.push(e)}},old:{inRequest:!1,handler:!1,lastSuccess:(new Date).getTime(),fnCallback:void 0,chan:"",sendRequest:function(){p.old.chan&&(p.old.handler=L.getJSON("Update.php?high="+E.get("charsHigh").toString()+"&channel="+p.old.chan+"&lineNum="+p.curline.toString(),function(e){p.old.handler=!1,p.old.lastSuccess=(new Date).getTime(),void 0!==e.lines&&$.map(e.lines,function(e){N(e)}),null!=e.errors&&1<=e.errors.length||!0!==e.banned&&p.old.setTimer()}).fail(function(){if(p.old.handler=!1,null!=p.fnCallback)return p.fnCallback(),void(p.fnCallback=void 0);(new Date).getTime()>=p.old.lastSuccess+3e5?B.internal('<span style="color:#C73232;">OmnomIRC has lost connection to server. Please refresh to reconnect.</span>'):p.old.inRequest?p.old.setTimer():p.old.lastSuccess=(new Date).getTime()}))},setTimer:function(){p.old.inRequest&&D.current().loaded&&!1===p.old.handler?setTimeout(function(){p.old.sendRequest()},G.isBlurred()?2500:200):p.old.stop()},start:function(){p.old.inRequest||(p.old.inRequest=!0,p.old.setTimer())},stop:function(e){p.old.inRequest?(p.old.inRequest=!1,p.old.handler?(p.fnCallback=e,p.old.handler.abort()):void 0!==e&&e()):void 0!==e&&e()},send:function(e,t,n){L.getJSON("message.php?message="+base64.encode(e)+"&channel="+t,function(e){void 0!==n&&n(e)})}},curline:0,joinChan:function(e){p.ws.use&&p.ws.send({action:"joinchan",chan:e}),parseInt(e,10)!=e&&(e=base64.encode(e)),p.old.chan=e},partChan:function(e){p.ws.use&&p.ws.send({action:"partchan",chan:e})},stop:function(e){p.ws.use?(p.ws.allowLines=!1,e()):p.old.stop(e)},kill:function(){p.ws.use?(p.ws.socket.onclose=function(){},p.ws.socket.close()):p.old.stop()},start:function(){p.ws.use?p.ws.allowLines=!0:p.old.start()},setCurline:function(e){console.log("Curline: "+e),e>p.curline&&(p.curline=e)},send:function(e,t,n){p.ws.use?(p.ws.send({action:"message",channel:t,message:e}),void 0!==n&&n()):(parseInt(t,10)!=t&&(t=base64.encode(t)),p.old.send(e,t,n))},setData:function(e,t,n,s){p.ws.enabled=e,p.ws.host=t,p.ws.port=n,p.ws.ssl=s},init:function(){p.ws.enabled?p.ws.init():(p.ws.use=!1,p.old.lastSuccess=(new Date).getTime())},identify:function(){p.ws.enabled&&p.ws.identify()},postfetch:function(){p.ws.use&&p.ws.send({action:"postfetch",channel:D.current().handler,curline:p.curline})},isNew:function(e){return 0==e||e>p.curline}}).joinChan,partChan:p.partChan,start:p.start,stop:p.stop,kill:p.kill,setCurline:p.setCurline,send:p.send,setData:p.setData,init:p.init,identify:p.identify,postfetch:p.postfetch,isNew:p.isNew},D=(h=function(t){var e=void 0!==f.chans[t],n={i:t,name:e?f.chans[t].chan.toLowerCase():"",handler:e?f.getHandler(t):-1,handlerB64:e?f.getHandler(t,!0):-1,loaded:!1,load:function(e){return void 0===e.lines?(e.message?B.internal(e.message):B.internal('<span style="color:#C73232;"><b>ERROR:</b> couldn\'t join channel</span>'),!1):(E.set("curChan",t),e.banned?(B.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),!1):(A.setUsers(e.users),$.each(e.lines,function(e,t){N(t,!0)}),n.loaded=!0))},unload:function(){n.loaded&&j.partChan(n.handler)},part:function(){f.part(f.i)},reloadUserlist:function(){e&&L.getJSON("Load.php?userlist&channel="+n.handlerB64,function(e){e.banned?B.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'):e.users&&A.setUsers(e.users)})},reload:function(){r.onchanneljoin(n.name)},setI:function(e){n.i=e},is:function(e){return e==n.i}};return{name:n.name,handler:n.handler,handlerB64:n.handlerB64,load:n.load,part:n.part,reload:n.reload,unload:n.unload,loaded:function(){return n.loaded},setI:n.setI,is:n.is,reloadUserlist:n.reloadUserlist}},{init:(f={current:!1,chans:[],save:function(){R.set("channels",f.chans)},loadSettings:function(){try{var e=R.get("channels"),t=$.map(f.chans,function(e){if(e.ex&&E.get("extraChans")||!e.ex)return e}),o=[];null!==e&&e!=[]&&(f.chans=$.merge($.map(e,function(n){if(-1!=n.id&&"*"!=n.id.toString().substr(0,1)){var s=!1;if($.each(f.chans,function(e,t){if(t.id==n.id)return o.push(n),s=!0,n.chan=t.chan,!1}),!s)return}return n}),$.map(t,function(n){var s=!1;if($.each(o,function(e,t){if(t.id==n.id)return s=!0,n.chan=t.chan,!1}),!s)return n})),save())}catch(e){}r.onchannelchange(f.chans)},init:function(){f.current=h(-1),f.loadSettings()},addChan:function(n,e){var s=!0;return void 0===e&&(e=-1),n=n.toLowerCase(),$.each(f.chans,function(e,t){t.chan==n&&(s=e)}),!0===s?"#"==n[0]?(B.internal('<span style="color:#C73232;">Join Error: Cannot join new channels starting with #.</span>'),-1):(f.chans.push({chan:n,high:!1,ex:!1,id:e,order:-1}),f.save(),r.onchannelchange(f.chans),f.chans.length-1):s},getHandler:function(e,t){return-1!=f.chans[e].id?"number"!=typeof f.chans[e].id&&t?base64.encode(f.chans[e].id):f.chans[e].id.toString():t?base64.encode(f.chans[e].chan):f.chans[e].chan},requestHandler:!1,load:function(s,t){console.log("loading channel");var o=function(e){if(f.current.load(e))return f.chans[s].high=!1,f.save(),j.joinChan(f.getHandler(s)),j.start(),H.load(),U.read(),j.postfetch(),void t(!0,e);t(!1,{})};void 0===t&&(t=function(){}),void 0!==f.chans[s]?j.stop(function(){if(!1!==f.requestHandler&&f.requestHandler.abort(),I.get("chan")==f.getHandler(s)){E.set("curChan",s),f.current=h(s);for(var e={},t=["chan","banned","admin","users","ignores","lines"],n=0;n<t.length;n++)e[t[n]]=I.get(t[n]);return console.log(e),void o(e)}f.requestHandler=L.getJSON("Load.php?count=125&channel="+f.getHandler(s,!0),function(e){E.set("curChan",s),f.current=h(s),I.set("chan",f.current.handler),I.set("banned",e.banned),I.set("admin",e.admin),I.set("users",e.users),I.set("ignores",e.ignores),I.set("lines",e.lines),o(e)})}):t(!1,{})},join:function(e){return(e=e.trim())?("@"!=e[0]&&"#"!=e[0]&&(e="@"+e),f.addChan(e)):-1},joinPm:function(n,e,s){void 0===s&&(s=function(){});var t=function(e,t){"*"!=(e=e.trim()).substr(0,1)&&(e="*"+n),"*"!=(t=t.trim()).substr(0,1)&&(t="*"+t),s(f.addChan(e,t))};if(""==e){if("@"==n.substr(0,1)||"#"==n.substr(0,1))return B.internal('<span style="color:#C73232;">Query Error: Cannot query a channel. Use /join instead.</span>'),void s(-1);L.getJSON("misc.php?openpm="+base64.encode(n),function(e){e.channick?t(e.channick,e.chanid):(B.internal('<span style="color:#C73232;">Query Error: User not found.</span>'),s(-1))})}else t(n,e)},part:function(n){if(parseInt(n,10)==n&&(n=parseInt(n,10)),"number"!=typeof n&&(n&&"@"!=n[0]&&"#"!=n[0]&&"*"!=n[0]&&(n="@"+n),$.each(f.chans,function(e,t){if(t.chan==n)return n=e,!1})),"number"!=typeof n||void 0===f.chans[n])return B.internal('<span style="color:#C73232;"> Part Error: can\'t part '+n+". (You are not in it.)</span>"),!1;if("#"==f.chans[n].chan[0])return B.internal('<span style="color:#C73232;"> Part Error: can\'t part '+f.chans[n].chan+". (IRC channel.)</span>"),!1;var e=f.chans[n].chanId,t=!1;return f.current.is(n)&&(t=!0),-1==e&&(e=f.chans[n]),j.partChan(f.getHandler(n)),f.chans.splice(n,1),f.save(),r.onchannelchange(f.chans),t&&r.onchanneljoin(f.chans[n-1].chan),!0},getList:function(){return f.chans},setChans:function(e){f.chans=e,f.current&&(f.save(),r.onchannelchange(f.chans))},getNames:function(){return $.map(f.chans,function(e){return e.chan})},highlight:function(n){$.each(f.chans,function(e,t){if(n==t.id||t.chan.toLowerCase()==n.toString().toLowerCase())return f.chans[e].high=!0,!1}),f.save(),r.onchannelchange(f.chans)}}).init,load:f.load,join:f.join,joinPm:f.joinPm,part:f.part,getList:f.getList,getHandler:f.getHandler,current:function(){return f.current},setChans:f.setChans,getNames:f.getNames,highlight:f.highlight}),A={add:(g={users:[],draw:function(){g.users.sort(function(e,t){var n=e.nick.toLowerCase(),s=t.nick.toLowerCase();return n==s?e==t?0:e<t?-1:1:n<s?-1:1}),r.onuserchange(g.users)},exists:function(e){var n=!1;return $.each(g.users,function(e,t){if(t.nick.toLowerCase()==u.nick.toLowerCase()&&t.network==u.network)return n=!0,!1}),n},add:function(n){if(""!==D.current().handler){var s=!0;$.each(g.users,function(e,t){if(t.nick==n.nick&&t.network==n.network)return s=!1}),s&&(g.users.push(n),g.draw())}},remove:function(n){""!==D.current().handler&&($.each(g.users,function(e,t){if(t.nick==n.nick&&t.network==n.network)return g.users.splice(e,1),!1}),g.draw())},setUsers:function(e){g.users=e,I.set("users",g.users),g.draw()},getNames:function(){return $.map(g.users,function(e){return e.nick})}}).add,remove:g.remove,setUsers:g.setUsers,getNames:g.getNames,getUsers:function(e){return g.users}},W={parse:function(e){var t=e.split(" ")[0].toLowerCase(),n=e.substr(t.length+1).toLowerCase().trim();switch(t){case"j":case"join":return O.isGuest()?B.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t join as guest</span>'):r.onchanneljoin(n),!0;case"q":case"query":return O.isGuest()?B.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t query as guest</span>'):r.onchanneljoin("*"+n),!0;case"win":case"w":case"window":var s=D.getList()[parseInt(n,10)];return void 0!==s&&r.onchanneljoin(s.chan),!0;case"p":case"part":return""!==n?r.onchannelpart(n):r.onchannelpart(D.current().name),!0;case"help":return B.internal('<span style="color:#2A8C2A;">Commands: me, ignore, unignore, ignorelist, join, part, query, msg, window</span>'),B.internal('<span style="color:#2A8C2A;">For full help go here: <a href="http://ourl.ca/19926" target="_top">http://ourl.ca/19926</a></span>'),!0;case"ponies":return $.getScript("https://juju2143.ca/mousefly.js",function(){Derpy()}),!0;case"minty":return $.getJSON(S+"/minty.php").done(function(e){B.internal('<span style="font-size:5px;line-height:0;font-family:monospace;">'+e.minty+"</span>")}),!0;default:return!1}}},B={internal:(d={sending:!1,send_real:function(t,e,n,s){s&&t(),d.sending?setTimeout(function(){s?d.send_real(function(){},e,n,s):d.send_real(t,e,n,s)},1e3):(d.sending=!0,j.send(e,n,function(e){void 0!==e&&void 0!==e.lines&&$.map(e.lines,function(e){N(e)}),d.sending=!1,d.val(""),s||t()}))},send:function(e,t,n){var s=!0;"string"==typeof e&&(t=e,e=void 0),void 0===e&&(e=function(){}),"boolean"==typeof t&&(s=t,t=void 0),void 0===t&&(t=B.val()),t?(U.add(t),""!==t&&E.get("textDeco")&&(">"==t[0]&&(t="3"+t),t=t.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),void 0===n&&(n=D.current().handler),"/"==t[0]&&W.parse(t.substr(1))?(d.val(""),e()):d.send_real(e,t,n,s)):e()},internal:function(e){N({curline:0,type:"internal",time:Math.floor((new Date).getTime()/1e3),name:"",message:e,name2:"",chan:D.current().handler})},val:function(e){if(void 0===e)return!1===r.ongetval?x.is("input")?x.val():x.text():r.ongetval();!1===r.onsetval?x.is("input")?x.val(e):x.text(e):r.onsetval(e)}}).internal,send:d.send,val:d.val},H={init:(a={tabWord:"",tabCount:0,isInTab:!1,startPos:0,startChar:"",endPos:0,endChar:"",endPos0:0,tabAppendStr:"",searchArray:[],node:!1,wysiwyg:!1,getCurrentWord:function(){var e=a.wysiwyg?(a.node=window.getSelection().anchorNode).nodeValue:x[0].value;if(a.isInTab)return a.tabWord;for(a.startPos=a.wysiwyg?window.getSelection().anchorOffset:x[0].selectionStart,a.startChar=e.charAt(a.startPos);" "!=a.startChar&&0<--a.startPos;)a.startChar=e.charAt(a.startPos);for(" "==a.startChar&&a.startPos++,a.endPos=a.wysiwyg?window.getSelection().anchorOffset:x[0].selectionStart,a.endChar=e.charAt(a.endPos);" "!=a.endChar&&++a.endPos<=e.length;)a.endChar=e.charAt(a.endPos);return a.endPos0=a.endPos,a.tabWord=e.substr(a.startPos,a.endPos-a.startPos).trim(),a.tabWord},getTabComplete:function(){var e,t=a.wysiwyg?a.node.nodeValue:x[0].value;null!==t&&(e=a.search(a.getCurrentWord(),a.tabCount),a.isInTab||(a.tabAppendStr=" ",0===a.startPos&&(a.tabAppendStr=": ")),e==a.getCurrentWord()&&(a.tabCount=0,e=a.search(a.getCurrentWord(),a.tabCount)),t=t.substr(0,a.startPos)+e+a.tabAppendStr+t.substr(a.endPos+1),a.wysiwyg?(window.getSelection().anchorNode.nodeValue=t,window.getSelection().getRangeAt(0).setEnd(a.node,a.startPos+e.length+a.tabAppendStr.length),window.getSelection().getRangeAt(0).setStart(a.node,a.startPos+e.length+a.tabAppendStr.length)):x[0].value=t,a.endPos=a.endPos0+e.length+a.tabAppendStr.length)},search:function(n,s){var o=!1;return s||(s=0),$.each(a.searchArray,function(e,t){0===t.toLowerCase().indexOf(n.toLowerCase())&&s--<=0&&!1===o&&(o=t)}),!1!==o?o:n},init:function(){a.wysiwyg=!x.is("input"),x.keydown(function(e){9==e.keyCode?e.ctrlKey||(e.preventDefault(),a.getTabComplete(),a.isInTab=!0,a.tabCount++,setTimeout(1,1)):(a.tabWord="",a.tabCount=0,a.isInTab=!1)})},load:function(){a.searchArray=$.merge(A.getNames(),D.getNames())}}).init,load:a.load},U={init:(n={messages:[],counter:0,current:"",init:function(){x.keydown(function(e){38!=e.keyCode&&40!=e.keyCode||(e.preventDefault(),n.counter==n.messages.length&&(n.current=B.val()),0!==n.messages.length&&(38==e.keyCode?(0!==n.counter&&n.counter--,B.val(n.messages[n.counter])):(n.counter!=n.messages.length&&n.counter++,n.counter==n.messages.length?B.val(n.current):B.val(n.messages[n.counter]))))})},add:function(e){n.messages.push(e),20<n.messages.length&&n.messages.shift(),n.counter=n.messages.length,r.ls.set("oldMessages-"+r.channels.current().handlerB64,n.messages)},read:function(){n.messages=r.ls.get("oldMessages-"+r.channels.current().handlerB64),n.messages||(n.messages=[]),console.log(n.messages),n.counter=n.messages.length}}).init,add:n.add,read:n.read},F={init:(c={menuOpen:!1,msgVal:"",$textDecoForm:!1,hideMenu:function(){c.$textDecoForm.css("display","none"),c.menuOpen=!1},reverseParse:function(i){if(-1===i.indexOf("<"))return $("<span>").html(i).text();var r=!1,a=!1,c=!1,l="-1",u="-1";return i=(i=i.replace(/<img([^>]*?)>/gi,function(e,t){var n=t.match(/data-code="([^"]*)"/);return n?n[1]:""})).replace(/<span([^>]*?)>([^<]*?)<\/span>/gi,function(e,t,n){if(!t)return n;i="",-1==t.indexOf("bold")==r&&(r=!r,i+=""),-1==t.indexOf("italic")==a&&(a=!a,i+=""),-1==t.indexOf("underline")==c&&(c=!c,i+="");var s=t.match(/fg-(\d+)/),o=t.match(/bg-(\d+)/);return s||(s="-1"),o||(o="-1"),o==u&&s==l||(("-1"!=l&&"-1"==s||"-1"!=u&&"-1"==o)&&(i="",r&&(i+=""),a&&(i+=""),c&&(i+="")),i+="","-1"!=(l=s)&&(i+=l),"-1"!=(u=o)&&(i+=","+u)),i+n}),$("<span>").html(i).text()},getCaretCharacterOffsetWithin:function(e){var t=window.getSelection();if(0<t.rangeCount){var n,s=t.getRangeAt(0),o=s.cloneRange(),i=0,r=document.createRange();o.selectNodeContents(e),o.setEnd(s.endContainer,s.endOffset),n=o.commonAncestorContainer.getElementsByTagName("img");for(var a=0;a<n.length;a++){var c=n[a];c.dataset.code&&(r.selectNode(c),1!=o.compareBoundaryPoints(Range.START_TO_START,r)&&-1!=o.compareBoundaryPoints(Range.END_TO_END,r)&&(i+=c.dataset.code.length))}return o.toString().length+i}return 0},getWholeSelection:function(e){var t,n=window.getSelection(),s=n.getRangeAt(0),o=s.cloneRange(),i=c.getCaretCharacterOffsetWithin(e);return s.collapse(!0),n.removeAllRanges(),n.addRange(s),t=c.getCaretCharacterOffsetWithin(e),n.removeAllRanges(),n.addRange(o),[t,i]},setCaretCharacterOffsetWithin:function(e,t,n,s,o){void 0===n&&(n=0),void 0===s&&(s=document.createRange()),void 0===o&&(o=!1);for(var i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];if(3==r.nodeType){if(r.length>=t){var a=window.getSelection();if(o||(s.setStart(r,t),o=!0,t+=n),o&&r.length>=t)return s.setEnd(r,t),a.removeAllRanges(),a.addRange(s),-1}t-=r.length}else if(1==r.nodeType){if("IMG"==r.tagName&&r.dataset.code){if(r.dataset.code.length>=t){a=window.getSelection();if(o||(s.setStartAfter(r),o=!0,t+=n),o&&r.dataset.code.length>=t)return s.setEndAfter(r),a.removeAllRanges(),a.addRange(s),-1}t-=r.dataset.code.length}else if((t=c.setCaretCharacterOffsetWithin(r,t,n,s,o))<0)return-1}else if((t=c.setCaretCharacterOffsetWithin(r,t,n,s,o))<0)return-1}return t},surroundSelection:function(e,t){var n=window.getSelection();if(0<n.rangeCount){var s=n.getRangeAt(0),o=s.startContainer,i=s.startOffset,r=document.createTextNode(e),a=document.createTextNode(t),c=s.cloneRange();c.collapse(!1),c.insertNode(a),c.setStart(o,i),c.collapse(!0),c.insertNode(r),s.setStartAfter(r),s.setEndBefore(a),n.removeAllRanges(),n.addRange(s)}},updateContent:function(e,t){void 0===e&&(e=t=c.getCaretCharacterOffsetWithin(x[0])),c.msgVal=c.reverseParse(x.html()),x.html(J.parse(c.msgVal)),c.setCaretCharacterOffsetWithin(x[0],e,t-e)},init:function(){if(c.support()){var e=x.attr("id"),t=$("<span>").attr({contenteditable:"true",accesskey:"i",id:e}).css({display:"inline-block",height:"1em",padding:"0.3em 0.2em 0.2em 0.3em",fontSize:"1.2em",verticalAlign:"top",whiteSpace:"nowrap",backgroundColor:x.css("backgroundColor")});for(var n in["Top","Bottom","Left","Right"])for(var s in["Style","Width","Color"])t.css("border"+n+s,x.css("border"+n+s));x.replaceWith(t),(x=t).on("update",c.updateContent),c.$textDecoForm=$("<div>").css({position:"absolute",bottom:"3em"}).attr("id",y+"textDecoForm").append($("<button>").css("font-weight","bold").text("B").click(function(e){e.preventDefault();var t=c.getWholeSelection(x[0]);c.surroundSelection("",""),c.updateContent(t[0],t[1])}),"&nbsp;",$("<button>").css("font-style","italic").text("I").click(function(e){e.preventDefault();var t=c.getWholeSelection(x[0]);c.surroundSelection("",""),c.updateContent(t[0],t[1])}),"&nbsp;",$("<button>").css("text-decoration","underline").text("U").click(function(e){e.preventDefault();var t=c.getWholeSelection(x[0]);c.surroundSelection("",""),c.updateContent(t[0],t[1])}),"<br>",$.map([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],function(n){return[n%4==0?"<br>":"",$("<span>").css({display:"inline-block",height:"1em",width:"2em"}).addClass(y+"colorbutton").addClass(y+"bg-"+n).click(function(e){e.preventDefault();var t=c.getWholeSelection(x[0]);c.surroundSelection(""+n,""),c.updateContent(t[0],t[1])})]})).hide().insertBefore(x),r.onsetval=function(e){c.msgVal=e,x.html(J.parse(e))},r.ongetval=function(){return c.msgVal},x.on("input",function(e){c.updateContent()}),x.mouseup(function(e){window.getSelection().isCollapsed||(e.preventDefault(),c.$textDecoForm.show().css("left",Math.max(e.pageX-52,0)),c.menuOpen=!0)}),$(document).mousedown(function(e){!$(e.target).closest(c.$textDecoForm).length&&c.menuOpen&&c.hideMenu()})}},support:function(){return"contentEditable"in document.documentElement&&E.get("wysiwyg")}}).init,getMsg:c.getMsg,support:c.support,updateContent:c.updateContent},M={set:(t={text:"",started:!1,start:function(){E.get("statusBar")?t.started||(setInterval(function(){if(window.status=t.text,parent)try{parent.window.status=t.text}catch(e){}},500),t.started=!0):t.started=!0},set:function(e){t.text=e,t.started||t.start()}}).set},_={request:(i={support_webkit:void 0!==window.webkitNotifications&&null!==window.webkitNotifications&&window.webkitNotifications,support:function(){return"undefined"!=typeof Notification&&Notification&&"denied"!=Notification.permission},show:function(e){var t;i.support_webkit?(t=window.webkitNotifications.createNotification("omni.png","OmnomIRC Highlight",e)).show():i.support()&&((t=new Notification("OmnomIRC Highlight",{icon:"omni.png",body:e})).onshow=function(){setTimeout(t.close,3e4)})},request:function(){i.support_webkit?window.webkitNotifications.requestPermission(function(){0===window.webkitNotifications.checkPermission()&&(i.show("Notifications Enabled!"),r.options.set("browserNotifications",!0),document.location.reload())}):i.support()?Notification.requestPermission(function(e){Notification.permission!==e&&(Notification.permission=e),"granted"===e&&(i.show("Notifications Enabled!"),r.options.set("browserNotifications",!0),document.location.reload())}):alert("Your browser doesn't support notifications")},sound:!1,make:function(e,t){var n=T.current();n&&(E.get("browserNotifications")&&i.show(e),E.get("ding")&&i.sound&&i.sound.play()),i.startFlash(),r.onnotification(e,t,n)},doFlash:!1,intervalHandler:!1,originalTitle:"",target:top.postMessage?top:top.document.postMessage?top.document:void 0,startFlash:function(){if(!i.doFlash)if(i.doFlash=!0,top==window){var e=!1;i.originalTitle=document.title,i.intervalHandler=setInterval(function(){document.title=(e?"[ @] ":"[@ ] ")+i.originalTitle,e=!e},500)}else void 0!==i.target&&i.target.postMessage("startFlash","*")},stopFlash:function(e){void 0===e&&(e=!1),i.doFlash&&(top==window?i.intervalHandler&&(clearInterval(i.intervalHandler),i.intervalHandler=!1,document.title=i.originalTitle):void 0!==i.target&&i.target.postMessage("stopFlash","*"),i.doFlash=!1,e||r.ls.set("stopFlash",Math.random().toString(36)+(new Date).getTime().toString()))},init:function(){$(window).on("storage",function(e){e.originalEvent.key==O.net()+"stopFlash"&&i.stopFlash(!0)}).unload(function(){i.stopFlash(!0)}).focus(function(){i.stopFlash()}),i.sound||(i.sound=new Audio("beep.mp3"))}}).request,make:i.make,init:i.init},J={setSmileys:(l={smileys_a:[],cacheServerNicks:{},spLinks:[],name:function(e,t,n){void 0===n&&(n=-1),e="\0"==e?"":e;var s=encodeURIComponent(e),o=0,i=0,r=e=$("<span>").text(e).html(),a=O.getNetwork(t),c=!0;switch(E.get("colordNames")){case"1":for(;e[i];)o+=e.charCodeAt(i++);r=$("<span>").append($("<span>").addClass(y+"uName-"+[19,20,22,24,25,26,27,28,29][o%9].toString()).html(e)).html();break;case"2":void 0!==a&&void 0!==a.checkLogin&&-1!=n?(r=I.get("nick"+t.toString()+":"+n.toString()))||(c=!1,void 0===l.cacheServerNicks[t.toString()+":"+n.toString()]&&L.getJSON(a.checkLogin+"?c="+n.toString(10)+"&n="+s,function(e){l.cacheServerNicks[t.toString()+":"+n.toString()]=e.nick},!1,!1),r=l.cacheServerNicks[t.toString()+":"+n.toString()],I.set("nick"+t.toString()+":"+n.toString(),r)):r=e;break;default:r=e}return void 0!==a&&c&&(r=a.normal.split("NICKENCODE").join(s).split("NICK").join(r).split("USERID").join(n.toString(10))),void 0!==a?'<span title="'+a.name+'">'+r+"</span>":'<span title="Unknown Network">'+r+"</span>"},smileys:function(n){return n?(/^[\w\s\d\.,!?]*$/.test(n)||$.each(l.smileys_a,function(e,t){n=n.replace(RegExp(t.regex,"g"),t.replace)}),n):""},links:function(t){if(!t||null==t)return"";var n="(?:(?!&lt;|&gt;|\\s|||<|>|\\)|\\]).)";return t=t.replace(RegExp("(|)","g"),""),$.map(l.spLinks,function(e){e=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t=t.replace(RegExp("(^|[\\s>])((?:(?:f|ht)tps?://(?:www\\.)?)"+e+n+"*)","g"),"$1$2").replace(RegExp("(^|[\\s>])("+e+n+"*)","g"),"$1$2")}),t.replace(RegExp('(^|[^a-zA-Z0-9_"])((?:(?:f|ht)tps?://)'+n+"+)","g"),'$1<a target="_blank" href="$2">$2</a>').replace(RegExp("(^|[^a-zA-Z0-9_/])(www\\."+n+"+)","g"),'$1<a target="_blank" href="http://$2">$2</a>').replace(RegExp("(^|.)("+n+"+)","g"),'$1<a target="_top" href="$2">$2</a>').replace(RegExp("(^|.)("+n+"+)","g"),'$1<a target="_top" href="http://$2">$2</a>')},colors:function(e){var t,n,s,o=[],i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};if(!e)return"";for(o=e.split(RegExp("([])")),e="<span>",n=0;n<o.length;n++){switch(s=!0,o[n]){case"":(t=o[n+1].replace(/^([0-9]{1,2}),([0-9]{1,2})(.*)/,"$1:$2"))==o[n+1]?(t=o[n+1].replace(/^([0-9]{1,2}).*/,"$1:"))!=o[n+1]?(i.fg=t.split(":")[0],o[n+1]=o[n+1].substr(t.length-1)):(i.fg="-1",i.bg="-1"):(i.fg=t.split(":")[0],i.bg=t.split(":")[1],t==o[n+1]?o[n+1]="":o[n+1]=o[n+1].substr(t.length));break;case"":i.bold=!i.bold;break;case"":i.italic=!i.italic;break;case"":t=i.fg,i.fg=i.bg,i.bg=t,"-1"==i.fg&&(i.fg="0"),"-1"==i.bg&&(i.bg="1");break;case"":i.underline=!i.underline;break;case"":i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};break;default:s=!1}e+=s?'</span><span class="'+y+"fg-"+i.fg+" "+y+"bg-"+i.bg+'" style="'+(i.bold?"font-weight:bold;":"")+(i.underline?"text-decoration:underline;":"")+(i.italic?"font-style:italic;":"")+'">':o[n]}return e=(e+="</span>").replace(/(\x03|\x02|\x1F|\x09|\x0F)/g,"")},highlight:function(e){var t="";return E.get("highRed")||(t+="background:none;padding:none;border:none;"),E.get("highBold")&&(t+="font-weight:bold;"),'<span class="highlight" style="'+t+'">'+e+"</span>"},parse:function(e,t){return null!=t&&t||(t=!1),e="\0"==e?"":e,e=$("<span>").text(e).html(),E.get("smileys")&&!1===t&&(e=l.smileys(e)),e=l.colors(e),e=l.links(e)},setSmileys:function(e){l.smileys_a=[],$.each(e,function(e,t){l.smileys_a.push({regex:t.regex,replace:t.replace.split("ADDSTUFF").join('data-code="'+t.code+'"').split("PIC").join(t.pic).split("ALT").join(t.alt)})})},setSpLinks:function(e){l.spLinks=e},parseTextDecorations:function(e){return""!==e&&E.get("textDeco")&&(">"==e[0]&&(e="3"+e),e=e.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),e},addLine:function(s,e){if(e||"highlight"==s.type||s.chan.toString().toLowerCase()==D.current().handler.toLowerCase()||s.name2===O.getPmIdent()){var t=l.name(s.name,s.network,s.uid),o=l.parse(s.message),n="*",i=o;switch(""!=O.nick()&&0<=["message","action","pm","pmaction"].indexOf(s.type)&&"*"!=s.name.toLowerCase()&&0<=o.toLowerCase().indexOf(O.nick().toLowerCase().substr(0,E.get("charsHigh")))&&(i=o=J.highlight(o),!e&&G.isBlurred()&&_.make("("+D.current().name+") <"+s.name+"> "+s.message,s.chan)),s.type){case"reload":return void(e||D.current().reload());case"reload_userlist":return void(e||D.current().reloadUserlist());case"relog":return void(e||O.fetch(void 0,!0));case"refresh":return void(e||location.reload(!0));case"join":if(i=[t," has joined "+D.current().name],e||A.add({nick:s.name,network:s.network}),1==O.getNetwork(s.network).type&&!E.get("oircJoinPart"))return;break;case"part":if(i=[t," has left "+D.current().name+" (",o,")"],e||A.remove({nick:s.name,network:s.network}),1==O.getNetwork(s.network).type&&!E.get("oircJoinPart"))return;break;case"quit":if(i=[t," has quit IRC (",o,")"],e||A.remove({nick:s.name,network:s.network}),1==O.getNetwork(s.network).type&&!E.get("oircJoinPart"))return;break;case"kick":i=[t," has kicked ",J.name(s.name2,s.network)," from "+D.current().name+" (",o,")"],e||A.remove({nick:s.name2,network:s.network});break;case"message":n=t;break;case"action":i=[t," ",o];break;case"mode":"string"==typeof o&&(o=s.message.split(" "),$.each(o,function(e,t){var n=$("<span>").html(t).text();-1==n.indexOf("+")&&-1==n.indexOf("-")&&(o[e]=J.name(t,s.network))}),o=o.join(" ")),i=[t," set "+D.current().name+" mode ",o];break;case"nick":i=[t," has changed nicks to ",J.name(s.name2,s.network)],e||(A.add({nick:s.name2,network:s.network}),A.remove({nick:s.name,network:s.network}));break;case"topic":if(r.ontopicchange(J.parse(s.message,!0)),""===s.name&&0===s.network&&e)return;i=[t," has changed the topic to ",J.parse(s.message,!0)];break;case"pm":if(s.chan==D.current().handler)n=t,s.type="message";else{if(e)return;if(s.name.toLowerCase()==O.nick().toLowerCase())return void D.joinPm(s.chan,O.getWholePmIdent(s.uid,s.network));n=["(PM)",t],D.joinPm(s.name,O.getWholePmIdent(s.uid,s.network)),_.make("(PM) <"+s.name+"> "+s.message,s.chan)}break;case"pmaction":if(s.chan==D.current().handler)i=[t," ",o],s.type="action";else{if(e)return;if(s.name.toLowerCase()==O.nick().toLowerCase())return void D.joinPm(s.chan,O.getWholePmIdent(s.uid,s.network));i=["(PM)",t," ",o],D.joinPm(s.name,O.getWholePmIdent(s.uid,s.network)),notofication.make("* (PM)"+s.name+" "+s.message,s.chan),s.type="pm"}break;case"highlight":return void("*"!=s.name.toLowerCase()&&_.make("("+s.chan+") <"+s.name+"> "+s.message,s.chan));case"internal":i=s.message;break;case"server":break;default:return}r.onmessage(n,i,s,e)}}}).setSmileys,setSpLinks:l.setSpLinks,parse:l.parse,parseTextDecorations:l.parseTextDecorations,name:l.name,highlight:l.highlight,addLine:l.addLine},q={addError:(s={$errors:!1,$warnings:!1,errors:[],warnings:[],$errorsPopup:!1,$warningsPopup:!1,getSinglePopupEntry:function(e){return $("<div>").css("border-bottom","1px solid black").append("Time: ",new Date(e.time).toLocaleTimeString(),"<br>File: ",$("<span>").text(e.file).html(),$.map(e.content,function(e,t){return["<br>",$("<span>").text(t).html(),": ",$("<span>").text(e).html()]}))},makePopup:function(e,t,n){return $("<div>").addClass("errorPopup").addClass(e.toLowerCase()).append($("<a>").text("Close").click(function(e){e.preventDefault(),$(this).parent().remove(),n()}),"&nbsp;",$("<b>").text(e),$("<div>").addClass("errorPopupCont").append($.map(t,function(e){return s.getSinglePopupEntry(e)}))).appendTo("body")},init:function(e,t){void 0===e&&(e=$("#errors")),void 0===t&&(t=$("#warnings")),e.click(function(){s.$errorsPopup||(s.$errorsPopup=s.makePopup("Errors",s.errors,function(){s.$errorsPopup=!1}))}),t.click(function(){s.$warningsPopup||(s.$warningsPopup=s.makePopup("Warnings",s.warnings,function(){s.$warningsPopup=!1}))}),s.$errors=e,s.$warnings=t},addError:function(e,t){s.errors.push({time:(new Date).getTime(),file:e,content:t}),s.$errors.css("display","").find(".count").text(s.errors.length),s.$errorsPopup&&s.$errorsPopup.children("div").append(s.getSinglePopupEntry(s.errors[s.errors.length-1]))},addWarning:function(e,t){s.warnings.push({time:(new Date).getTime(),file:e,content:t}),s.$warnings.css("display","").find(".count").text(s.warnings.length),s.$warningsPopup&&s.$warningsPopup.children("div").append(s.getSinglePopupEntry(s.warnings[s.warnings.length-1]))}}).addError,addWarning:s.addWarning,init:s.init},G={init:(e={isBlurred:!0,init:function(){$(window).blur(function(){e.isBlurred=!0}).focus(function(){e.isBlurred=!1})},changeLinks:function(){$('#adminLink a,a[href="."],a[href="?options"],a[href="index.php"]').each(function(){void 0!==$(this).attr("href").split("?")[1]?$(this).attr("href",$(this).attr("href")+"&network="+r.settings.net()):$(this).attr("href",$(this).attr("href")+"?network="+r.settings.net())})}}).init,changeLinks:e.changeLinks,isBlurred:function(){return e.isBlurred}},V={fetch:(o={isOpen:!1,open:function(e){o.isOpen||(o.isOpen=!0,j.stop(e))},close:function(){o.isOpen&&(o.isOpen=!1,D.current().reload())},fetch:function(t,n,s){o.isOpen&&(void 0===s&&(s=0),L.getJSON("Log.php?day="+t+"&offset="+parseInt(s,10)+"&channel="+D.current().handlerB64,function(e){e.banned?(B.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),n(!1)):($.map(e.lines,function(e){N(e,!0)}),1e3<=e.lines.length?o.fetch(t,n,s+1e3):void 0!==n&&n(!0))}))}}).fetch,open:o.open,close:o.close};this.OMNOMIRCSERVER=S,this.settings={loggedIn:O.loggedIn,fetch:O.fetch,net:O.net,getNetwork:O.getNetwork,getPmIdent:O.getPmIdent,getWholePmIdent:O.getWholePmIdent,nick:O.nick,guestLevel:O.guestLevel,identGuest:O.identGuest,logout:O.logout},this.ls={get:R.get,set:R.set},this.network={getJSON:L.getJSON,post:L.post},this.options={get:E.get,set:E.set,getAll:E.getAll},this.instant={current:T.current},this.channels={load:D.load,join:D.join,joinPm:D.joinPm,part:D.part,getList:D.getList,getHandler:D.getHandler,current:D.current,setChans:D.setChans,highlight:D.highlight},this.users={add:A.add,remove:A.remove,setUsers:A.setUsers},this.send={send:B.send,internal:B.internal,val:B.val},this.parser={parse:J.parse,name:J.name,highlight:J.highlight},this.error={addWarning:q.addWarning,addError:q.addError,init:q.init},this.page={changeLinks:G.changeLinks,isBlurred:G.isBlurred},this.logs={fetch:V.fetch,open:V.open,close:V.close},this.statusBar={set:M.set},this.initinput=function(e,t){void 0===e&&(e=$("#message")),x=e,t&&F.init(),H.init(),U.init(),x.keypress(function(e){13==e.which&&(e.preventDefault(),x.attr("disabled")||B.send(function(){x.focus()}))})},this.connect=function(e){G.init(),_.init(),O.fetch(function(){T.init(),j.init(),D.init(),e()})},this.disconnect=function(){T.kill(),j.kill()},this.setClassPrefix=function(e){y=e},this.onerror=function(){},this.onwarning=function(){},this.onmessage=function(){},this.onmessageraw=!1,this.onuserchange=function(){},this.onchannelchange=function(){},this.onchanneljoin=function(){},this.onchannelpart=function(){},this.onsmileychange=function(){},this.onsetval=!1,this.ongetval=!1,this.ontopicchange=function(){},this.onnotification=function(){},void 0!==(r=this).setOptions&&(this.options.setAll=E.setAll,this.setOptions(),delete this.options.setAll)}