/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2016 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";function OmnomIRC(){var e,t="https://omnomirc.omnimaga.org",n="",o=!1,r=function(e){return void 0!==document.URL.split(e+"=")[1]?document.URL.split(e+"=")[1].split("&")[0].split("#")[0]:""},s=function(t,n){if(void 0===n&&(n=!1),!n||"highlight"!=t.type){if(!n&&"highlight"!=t.type&&t.chan==c.get("chan")){var o=c.get("lines");o.push(t),o.length>200&&o.shift(),c.set("lines",o),["part","quit","join","nick"].indexOf(t.type)!=-1&&c.set("users",p.getUsers())}if(null===t.name||t.network==-1||!n&&!h.isNew(t.curline))return void h.setCurline(t.curline);h.setCurline(t.curline),e.onmessageraw!==!1?e.onmessageraw(t,n):y.addLine(t,n)}},i=function(){var t={hostname:"",nick:"",signature:"",numHigh:4,uid:-1,net:"",networks:{},pmIdent:!1,guestLevel:0,isGuest:!0,identGuest:function(e,n,o,r){void 0===r&&(r=o,o=!1),console.log("trying login"),l.getJSON("misc.php?identName="+base64.encode(e)+"&nick="+base64.encode(e)+"&signature="+base64.encode(n)+"&id=-1&network="+t.net,function(n){n.success&&(o?(a.set("guestName",e),a.set("guestSig",n.signature)):(a.set("guestName",""),a.set("guestSig","")),t.setIdent(e,n.signature,-1),h.identify()),void 0!==r&&r(n)},!0,!1)},logout:function(){t.setIdent("","",-1),a.remove("guestName"),a.remove("guestSig"),c.remove("config"),c.remove("checkLogin"),h.identify()},login:function(e,n,o){void 0===o&&(o=-1),t.setIdent(e,n,o),h.identify()},fetch:function(n,o){var s=function(s){if(!o){try{sessionStorage.setItem("defaultNetwork",s.defaultNetwork)}catch(i){}c.set("config",s),t.hostname=s.hostname,f.setChans(s.channels),y.setSmileys(s.smileys),e.onsmileychange(s.smileys),y.setSpLinks(s.spLinks),t.guestLevel=s.guests,t.networks={},$.each(s.networks,function(e,n){t.networks[n.id]=n}),t.net=s.network,a.setPrefix(t.net),d.setDefaults(s.defaults),d.setExtraChanMsg(s.extraChanMsg),h.setData(s.websockets.use,s.websockets.host,s.websockets.port,s.websockets.ssl)}var u=c.get("checkLogin");if(u&&!o){t.nick=u.nick,t.signature=u.signature,t.uid=u.uid,t.pmIdent="["+t.net.toString()+","+t.uid.toString()+"]",t.isGuest=""===s.signature;var g=r("uid");return""!==g&&g!=t.uid?(c.remove("config"),c.remove("checkLogin"),void t.fetch(n,o)):void(void 0!==n&&n())}t.loggedIn()&&t.isGuest?t.identGuest(t.nick,function(e){e.success&&(t.signature=e.signature),void 0!==n&&n()}):l.getJSON(s.checkLoginUrl+"&network="+t.net.toString()+"&jsoncallback=?",function(e){c.set("checkLogin",{nick:e.nick,signature:e.signature,uid:e.uid}),t.nick=e.nick,t.signature=e.signature,t.uid=e.uid,t.pmIdent="["+t.net.toString()+","+t.uid.toString()+"]",t.isGuest=""===e.signature,void 0!==n&&n()},!0,!1)};if(void 0===o&&(o=!1),o&&t.loggedIn()&&t.isGuest)return console.log("i am silly"),void t.identGuest(t.nick,function(e){e.success&&(t.signature=e.signature),void 0!==n&&n()});if(!o){var i=c.get("config");if(i)return void s(i)}c.determinePrefix(),l.getJSON("config.php?js&network="+r("network")+(o?"&clonly":""),s,!0,!1)},setIdent:function(e,n,o){t.nick=e,t.signature=n,t.uid=o,c.set("checkLogin",{nick:e,signature:n,uid:o})},getUrlParams:function(){return"nick="+base64.encode(t.nick)+"&signature="+base64.encode(t.signature)+"&time="+(+new Date).toString()+"&id="+t.uid+"&network="+t.net+"&noLoginErrors"},getNetwork:function(e){return void 0!==t.networks[e]?t.networks[e]:{id:-1,normal:"NICK",userlist:"NICK",name:"Invalid network",type:-1}},getIdentParams:function(){return{nick:t.nick,signature:t.signature,time:(+new Date).toString(),id:t.uid,network:t.net}},loggedIn:function(){return""!==t.signature},getWholePmIdent:function(e,n){var o="["+n.toString()+","+e.toString()+"]";return n<t.net?o+t.pmIdent:t.net<n?t.pmIdent+o:e<t.uid?o+t.pmIdent:t.pmIdent+o}};return{identGuest:t.identGuest,fetch:t.fetch,getUrlParams:t.getUrlParams,getIdentParams:t.getIdentParams,getNetwork:t.getNetwork,nick:function(){return t.nick},net:function(){return t.net},loggedIn:t.loggedIn,guestLevel:function(){return t.guestLevel},getPmIdent:function(){return t.pmIdent},isGuest:function(){return t.isGuest},numHigh:function(){return t.numHigh},getWholePmIdent:t.getWholePmIdent,logout:t.logout,login:t.login}}(),a=function(){var e={prefix:r("network"),setPrefix:function(t){return t?void(e.prefix=t.toString()):void(e.prefix="")},getCookie:function(e){var t,n,o,r=document.cookie.split(";");for(t=0;t<r.length;t++)if(n=r[t].substr(0,r[t].indexOf("=")),o=r[t].substr(r[t].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,""),n==e)return unescape(o)},setCookie:function(e,t,n){var o=new Date,r=escape(t);o.setDate(o.getDate()+n),r+=null===n?"":"; expires="+o.toUTCString(),document.cookie=e+"="+r},haveSupport:null,support:function(){if(null===e.haveSupport)try{localStorage.setItem("test",1),e.haveSupport=1==localStorage.getItem("test"),localStorage.removeItem("test"),e.haveSupport=!0}catch(t){e.haveSupport=!1}return e.haveSupport},get:function(t){var n;t=e.prefix+t,n=e.support()?localStorage.getItem(t):e.getCookie(t);try{return JSON.parse(n)}catch(o){return}},set:function(t,n){t=e.prefix+t,n=JSON.stringify(n),e.support()?localStorage.setItem(t,n):e.setCookie(t,n)},remove:function(t,n){t=e.prefix+t,e.support()?localStorage.removeItem(t):e.setCookie(t,"",-1)}};return{setPrefix:e.setPrefix,get:e.get,set:e.set,remove:e.remove}}(),c=function(){var e={prefix:r("network"),setPrefix:function(t){t&&(e.prefix=t.toString())},determinePrefix:function(){e.haveSupport=null},haveSupport:null,support:function(){if(null===e.haveSupport)try{sessionStorage.setItem("test",1),e.haveSupport=1==sessionStorage.getItem("test"),sessionStorage.removeItem("test"),e.haveSupport&&""==e.prefix&&e.setPrefix(sessionStorage.getItem("defaultNetwork"))}catch(t){e.haveSupport=!1}return e.haveSupport},get:function(t){if(e.support())try{return JSON.parse(sessionStorage.getItem(e.prefix+t))}catch(n){return}},set:function(t,n){e.support()&&sessionStorage.setItem(e.prefix+t,JSON.stringify(n))},remove:function(t){e.support()&&sessionStorage.removeItem(e.prefix+t)}};return{determinePrefix:e.determinePrefix,get:e.get,set:e.set,remove:e.remove}}(),l=function(){var t={didRelog:!1,removeSig:function(e){try{var t=e.split("signature="),n=t[1].split("&");return n[0]="---",t[1]=n.join("&"),t.join("signature=")}catch(o){return e.indexOf("signature")!==-1?"omited due to security reasons":e}},addError:function(n,o){n=t.removeSig(n),e.onerror(n,o)},addWarning:function(n,o){n=t.removeSig(n),e.onwarning(n,o)},checkCallback:function(e,n,o,r){2!=e.relog&&(void 0!==e.errors&&$.map(e.errors,function(e){void 0!==e.type?t.addError(r,e):t.addError(r,{type:"misc",message:e})}),void 0!==e.warnings&&$.map(e.warnings,function(e){void 0!==e.type?t.addWarning(r,e):t.addWarning(r,{type:"misc",message:e})})),void 0!==e.relog&&0!=e.relog?1==e.relog?(i.fetch(void 0,!0),n(e)):2!=e.relog||t.didRelog?n(e):(t.didRelog=!0,i.fetch(function(){o()},!0)):(void 0!==e.relog&&(t.didRelog=!1),n(e))},getJSON:function(e,n,o,r){void 0==o&&(o=!0),void 0==r&&(r=!0),e.indexOf("?")==-1&&r&&(e+="?");var s=e+(r?"&"+i.getUrlParams():"");return $.ajax({url:s,dataType:"json",async:o}).done(function(i){t.checkCallback(i,n,function(){t.getJSON(e,n,o,r)},s)})},post:function(e,n,o,r,s){void 0==r&&(r=!0),void 0==s&&(s=!0),e.indexOf("?")==-1&&s&&(e+="?");var a=e+(s?"&"+i.getUrlParams():"");return $.ajax({type:"POST",url:a,async:r,data:n}).done(function(i){t.checkCallback(i,o,function(){t.post(e,n,o,r,s)},a)})}};return{getJSON:t.getJSON,post:t.post}}(),d=function(){var e={extraChanMsg:"",allOptions:{highBold:{disp:"Highlight Bold","default":!0},highRed:{disp:"Highlight Red","default":!0},colordNames:{disp:"Colored Names","default":0,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("colordNames",this.value)}).append($.map(["none","calc","server"],function(t,n){return $("<option>").attr(e.get("colordNames")==n?"selected":"false","selected").val(n).text(t)})))}},curChan:{hidden:!0,"default":0},extraChans:{disp:"Show extra Channels","default":!1,before:function(){return""!==e.extraChanMsg&&alert(e.extraChanMsg),!0}},ding:{disp:"Ding on Highlight","default":!1},smileys:{disp:"Show Smileys","default":!0},charsHigh:{disp:"Number chars for Highlighting","default":4,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("charsHigh",this.value)}).append($.map([1,2,3,4,5,6,7,8,9,10],function(t){return $("<option>").attr(e.get("charsHigh")==t?"selected":"false","selected").val(t).text(t)})))}},oircJoinPart:{disp:"Show OmnomIRC join/part messages","default":!1},textDeco:{disp:"Enable simple text decorations","default":!1},statusBar:{disp:"Show Updates in Browser Status Bar","default":!0},browserNotifications:{disp:"Browser Notifications","default":!1,before:function(){return S.request(),!1}},wysiwyg:{disp:"Use WYSIWYG editor","default":!1}},set:function(t,n){if(void 0!==e.allOptions[t]){e.allOptions[t].value=n;var o=a.get("options")||{};o[t]=n,a.set("options",o)}},get:function(t){if(void 0!==e.allOptions[t])return e.allOptions[t].value},setExtraChanMsg:function(t){e.extraChanMsg=t},setDefaults:function(t){var n=a.get("options");$.each(e.allOptions,function(o,r){var s=r["default"];n&&void 0!==n[o]?s=n[o]:t&&void 0!==t[o]&&(s=t[o]),e.allOptions[o].value=s})},getAll:function(t){if(t)return e.allOptions;var n={};return $.each(e.allOptions,function(e,t){void 0!==t.hidden&&t.hidden||(n[e]=t.value)}),n},setAll:function(t){e.allOptions=t}};return{set:e.set,get:e.get,setDefaults:e.setDefaults,setExtraChanMsg:e.setExtraChanMsg,getAll:e.getAll,setAll:e.setAll}}(),g=function(){var e={id:Math.random().toString(36)+(new Date).getTime().toString(),update:function(){a.set("browserTab",e.id),a.set("newInstant",!1)},init:function(){a.set("browserTab",e.id),$(window).focus(function(){e.update()}).unload(function(){e.kill()})},current:function(){return a.get("newInstant")&&e.update(),e.id==a.get("browserTab")},kill:function(){a.set("newInstant",!0),$(window).off("focus").off("unload")}};return{init:e.init,current:e.current,kill:e.kill}}(),h=function(){var e={ws:{socket:!1,connected:!1,use:!0,sendBuffer:[],allowLines:!1,enabled:!1,host:"",port:0,ssl:!0,tryFallback:!0,didRelog:!1,fallback:function(){if(console.log("trying fallback..."),e.ws.tryFallback){try{e.ws.tryFallback=!1,e.ws.socket.close()}catch(t){}e.ws.use=!1,e.old.lastSuccess=(new Date).getTime(),e.old.start()}},identify:function(){e.ws.send($.extend({action:"ident"},i.getIdentParams())),e.ws.send({action:"charsHigh",chars:d.get("charsHigh")})},init:function(){if(!("WebSocket"in window&&e.ws.enabled))return e.ws.use=!1,!1;try{var t=window.location.pathname.split("/");t.pop(),t.length>1&&""===t[t.length-1]&&t.pop(),t.push("ws"),t.push(i.net()),e.ws.socket=new PooledWebSocket((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+t.join("/"))}catch(n){return console.log(e.ws.socket),console.log((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+t.join("/")),console.log(n),void e.ws.fallback()}return e.ws.socket.onopen=function(t){e.ws.connected=!0;for(var n=0;n<e.ws.sendBuffer.length;n++)e.ws.send(e.ws.sendBuffer[n]);e.ws.sendBuffer=[]},e.ws.socket.onmessage=function(t){try{var n=JSON.parse(t.data);console.log(n),e.ws.allowLines&&(void 0!==n.line&&(s(n.line)&&(e.ws.tryFallback=!1,delete e.ws.socket),console.log("Added line!")),void 0!==n.users&&p.setUsers(n.users)),void 0!==n.relog&&0!=n.relog&&n.relog<3&&(e.ws.didRelog||(e.ws.didRelog=!0,i.fetch(function(){i.loggedIn()&&(e.ws.identify(),e.ws.didRelog=!1)},!0)))}catch(t){console.log("ERROR!"),console.log(t)}},e.ws.socket.onclose=function(t){console.log("CLOOOOOOOOOSE"),console.log(t),e.ws.use=!1,e.ws.fallback()},e.ws.socket.onerror=function(t){console.log("ERRRORRRR"),console.log(t),delete e.ws.socket,e.ws.use=!1,e.ws.fallback()},e.ws.identify(),$(window).on("beforeunload",function(){e.partChan(f.current().handler),delete e.ws.socket}),!0},send:function(t){e.ws.connected?e.ws.socket.send(JSON.stringify(t)):e.ws.sendBuffer.push(t)}},old:{inRequest:!1,handler:!1,lastSuccess:(new Date).getTime(),fnCallback:void 0,chan:"",sendRequest:function(){e.old.chan&&(e.old.handler=l.getJSON("Update.php?high="+d.get("charsHigh").toString()+"&channel="+e.old.chan+"&lineNum="+e.curline.toString(),function(t){e.old.handler=!1,e.old.lastSuccess=(new Date).getTime(),void 0!==t.lines&&$.map(t.lines,function(e){s(e)}),void 0!=t.errors&&t.errors.length>=1||t.banned!==!0&&e.old.setTimer()}).fail(function(){return e.old.handler=!1,void 0!=e.fnCallback?(e.fnCallback(),void(e.fnCallback=void 0)):void((new Date).getTime()>=e.old.lastSuccess+3e5?w.internal('<span style="color:#C73232;">OmnomIRC has lost connection to server. Please refresh to reconnect.</span>'):e.old.inRequest?e.old.setTimer():e.old.lastSuccess=(new Date).getTime())}))},setTimer:function(){e.old.inRequest&&f.current().loaded&&e.old.handler===!1?setTimeout(function(){e.old.sendRequest()},P.isBlurred()?2500:200):e.old.stop()},start:function(){e.old.inRequest||(e.old.inRequest=!0,e.old.setTimer())},stop:function(t){e.old.inRequest?(e.old.inRequest=!1,e.old.handler?(e.fnCallback=t,e.old.handler.abort()):void 0!==t&&t()):void 0!==t&&t()},send:function(e,t,n){l.getJSON("message.php?message="+base64.encode(e)+"&channel="+t,function(e){void 0!==n&&n(e)})}},curline:0,joinChan:function(t){e.ws.use&&e.ws.send({action:"joinchan",chan:t}),parseInt(t,10)!=t&&(t=base64.encode(t)),e.old.chan=t},partChan:function(t){e.ws.use&&e.ws.send({action:"partchan",chan:t})},stop:function(t){e.ws.use?(e.ws.allowLines=!1,t()):e.old.stop(t)},kill:function(){e.ws.use?(e.ws.socket.onclose=function(){},e.ws.socket.close()):e.old.stop()},start:function(){e.ws.use?e.ws.allowLines=!0:e.old.start()},setCurline:function(t){console.log("Curline: "+t),t>e.curline&&(e.curline=t)},send:function(t,n,o){e.ws.use?(e.ws.send({action:"message",channel:n,message:t}),void 0!==o&&o()):(parseInt(n,10)!=n&&(n=base64.encode(n)),e.old.send(t,n,o))},setData:function(t,n,o,r){e.ws.enabled=t,e.ws.host=n,e.ws.port=o,e.ws.ssl=r},init:function(){e.ws.enabled?e.ws.init():(e.ws.use=!1,e.old.lastSuccess=(new Date).getTime())},identify:function(){e.ws.enabled&&e.ws.identify()},postfetch:function(){e.ws.use&&e.ws.send({action:"postfetch",channel:f.current().handler,curline:e.curline})},isNew:function(t){return 0==t||t>e.curline}};return{joinChan:e.joinChan,partChan:e.partChan,start:e.start,stop:e.stop,kill:e.kill,setCurline:e.setCurline,send:e.send,setData:e.setData,init:e.init,identify:e.identify,postfetch:e.postfetch,isNew:e.isNew}}(),f=function(){var t=function(t){var o=void 0!==n.chans[t],r={i:t,name:o?n.chans[t].chan.toLowerCase():"",handler:o?n.getHandler(t):-1,handlerB64:o?n.getHandler(t,!0):-1,loaded:!1,load:function(e){return void 0===e.lines?(e.message?w.internal(e.message):w.internal('<span style="color:#C73232;"><b>ERROR:</b> couldn\'t join channel</span>'),!1):(d.set("curChan",t),e.banned?(w.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),!1):(p.setUsers(e.users),$.each(e.lines,function(e,t){s(t,!0)}),r.loaded=!0,!0))},unload:function(){r.loaded&&h.partChan(r.handler)},part:function(){n.part(n.i)},reloadUserlist:function(){o&&l.getJSON("Load.php?userlist&channel="+r.handlerB64,function(e){e.banned?w.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'):e.users&&p.setUsers(e.users)})},reload:function(){e.onchanneljoin(r.name)},setI:function(e){r.i=e},is:function(e){return e==r.i}};return{name:r.name,handler:r.handler,handlerB64:r.handlerB64,load:r.load,part:r.part,reload:r.reload,unload:r.unload,loaded:function(){return r.loaded},setI:r.setI,is:r.is,reloadUserlist:r.reloadUserlist}},n={current:!1,chans:[],save:function(){a.set("channels",n.chans)},loadSettings:function(){try{var t=a.get("channels"),o=$.map(n.chans,function(e){if(e.ex&&d.get("extraChans")||!e.ex)return e}),r=[];null!==t&&t!=[]&&(n.chans=$.merge($.map(t,function(e){if(e.id!=-1&&"*"!=e.id.toString().substr(0,1)){var t=!1;if($.each(n.chans,function(n,o){if(o.id==e.id)return r.push(e),t=!0,e.chan=o.chan,!1}),!t)return}return e}),$.map(o,function(e){var t=!1;if($.each(r,function(n,o){if(o.id==e.id)return t=!0,e.chan=o.chan,!1}),!t)return e})),save())}catch(s){}e.onchannelchange(n.chans)},init:function(){n.current=t(-1),n.loadSettings()},addChan:function(t,o){var r=!0;return void 0===o&&(o=-1),t=t.toLowerCase(),$.each(n.chans,function(e,n){n.chan==t&&(r=e)}),r===!0?"#"==t[0]?(w.internal('<span style="color:#C73232;">Join Error: Cannot join new channels starting with #.</span>'),-1):(n.chans.push({chan:t,high:!1,ex:!1,id:o,order:-1}),n.save(),e.onchannelchange(n.chans),n.chans.length-1):r},getHandler:function(e,t){return n.chans[e].id!=-1?"number"!=typeof n.chans[e].id&&t?base64.encode(n.chans[e].id):n.chans[e].id.toString():t?base64.encode(n.chans[e].chan):n.chans[e].chan},requestHandler:!1,load:function(e,o){console.log("loading channel");var r=function(t){return n.current.load(t)?(n.chans[e].high=!1,n.save(),h.joinChan(n.getHandler(e)),h.start(),v.load(),k.read(),h.postfetch(),void o(!0,t)):void o(!1,{})};return void 0===o&&(o=function(){}),void 0===n.chans[e]?void o(!1,{}):void h.stop(function(){if(n.requestHandler!==!1&&n.requestHandler.abort(),c.get("chan")==n.getHandler(e)){d.set("curChan",e),n.current=t(e);for(var o={},s=["chan","banned","admin","users","ignores","lines"],i=0;i<s.length;i++)o[s[i]]=c.get(s[i]);return console.log(o),void r(o)}n.requestHandler=l.getJSON("Load.php?count=125&channel="+n.getHandler(e,!0),function(o){d.set("curChan",e),n.current=t(e),c.set("chan",n.current.handler),c.set("banned",o.banned),c.set("admin",o.admin),c.set("users",o.users),c.set("ignores",o.ignores),c.set("lines",o.lines),r(o)})})},join:function(e){return(e=e.trim())?("@"!=e[0]&&"#"!=e[0]&&(e="@"+e),n.addChan(e)):-1},joinPm:function(e,t,o){void 0===o&&(o=function(){});var r=function(t,r){t=t.trim(),"*"!=t.substr(0,1)&&(t="*"+e),r=r.trim(),"*"!=r.substr(0,1)&&(r="*"+r),o(n.addChan(t,r))};if(""==t){if("@"==e.substr(0,1)||"#"==e.substr(0,1))return w.internal('<span style="color:#C73232;">Query Error: Cannot query a channel. Use /join instead.</span>'),void o(-1);l.getJSON("misc.php?openpm="+base64.encode(e),function(e){e.channick?r(e.channick,e.chanid):(w.internal('<span style="color:#C73232;">Query Error: User not found.</span>'),o(-1))})}else r(e,t)},part:function(t){if(parseInt(t,10)==t&&(t=parseInt(t,10)),"number"!=typeof t&&(t&&"@"!=t[0]&&"#"!=t[0]&&"*"!=t[0]&&(t="@"+t),$.each(n.chans,function(e,n){if(n.chan==t)return t=e,!1})),"number"!=typeof t||void 0===n.chans[t])return w.internal('<span style="color:#C73232;"> Part Error: can\'t part '+t+". (You are not in it.)</span>"),!1;if("#"==n.chans[t].chan[0])return w.internal('<span style="color:#C73232;"> Part Error: can\'t part '+n.chans[t].chan+". (IRC channel.)</span>"),!1;var o=n.chans[t].chanId,r=!1;return n.current.is(t)&&(r=!0),o==-1&&(o=n.chans[t]),h.partChan(n.getHandler(t)),n.chans.splice(t,1),n.save(),e.onchannelchange(n.chans),r&&e.onchanneljoin(n.chans[t-1].chan),!0},getList:function(){return n.chans},setChans:function(t){n.chans=t,n.current&&(n.save(),e.onchannelchange(n.chans))},getNames:function(){return $.map(n.chans,function(e){return e.chan})},highlight:function(t){$.each(n.chans,function(e,o){if(t==o.id||o.chan.toLowerCase()==t.toString().toLowerCase())return n.chans[e].high=!0,!1}),n.save(),e.onchannelchange(n.chans)}};return{init:n.init,load:n.load,join:n.join,joinPm:n.joinPm,part:n.part,getList:n.getList,getHandler:n.getHandler,current:function(){return n.current},setChans:n.setChans,getNames:n.getNames,highlight:n.highlight}}(),p=function(){var t={users:[],draw:function(){t.users.sort(function(e,t){var n=e.nick.toLowerCase(),o=t.nick.toLowerCase();return n==o?e==t?0:e<t?-1:1:n<o?-1:1}),e.onuserchange(t.users)},exists:function(e){var n=!1;return $.each(t.users,function(e,t){if(t.nick.toLowerCase()==u.nick.toLowerCase()&&t.network==u.network)return n=!0,!1}),n},add:function(e){if(""!==f.current().handler){var n=!0;$.each(t.users,function(t,o){if(o.nick==e.nick&&o.network==e.network)return n=!1,!1}),n&&(t.users.push(e),t.draw())}},remove:function(e){""!==f.current().handler&&($.each(t.users,function(n,o){if(o.nick==e.nick&&o.network==e.network)return t.users.splice(n,1),!1}),t.draw())},setUsers:function(e){t.users=e,c.set("users",t.users),t.draw()},getNames:function(){return $.map(t.users,function(e){return e.nick})}};return{add:t.add,remove:t.remove,setUsers:t.setUsers,getNames:t.getNames,getUsers:function(e){return t.users}}}(),m=function(){var n={parse:function(n){var o=n.split(" ")[0].toLowerCase(),r=n.substr(o.length+1).toLowerCase().trim();switch(o){case"j":case"join":return i.isGuest()?w.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t join as guest</span>'):e.onchanneljoin(r),!0;case"q":case"query":return i.isGuest()?w.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t query as guest</span>'):e.onchanneljoin("*"+r),!0;case"win":case"w":case"window":var s=f.getList()[parseInt(r,10)];return void 0!==s&&e.onchanneljoin(s.chan),!0;case"p":case"part":return""!==r?e.onchannelpart(r):e.onchannelpart(f.current().name),!0;case"help":return w.internal('<span style="color:#2A8C2A;">Commands: me, ignore, unignore, ignorelist, join, part, query, msg, window</span>'),w.internal('<span style="color:#2A8C2A;">For full help go here: <a href="http://ourl.ca/19926" target="_top">http://ourl.ca/19926</a></span>'),!0;case"ponies":return $.getScript("https://juju2143.ca/mousefly.js",function(){Derpy()}),!0;case"minty":return $.getJSON(t+"/minty.php").done(function(e){w.internal('<span style="font-size:5px;line-height:0;font-family:monospace;">'+e.minty+"</span>")}),!0;default:return!1}}};return{parse:n.parse}}(),w=function(){var t={sending:!1,send:function(e,n,o){return"string"==typeof e&&(n=e,e=void 0),void 0===e&&(e=function(){}),void 0===n&&(n=w.val()),n?(k.add(n),""!==n&&d.get("textDeco")&&(">"==n[0]&&(n="3"+n),n=n.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),void 0===o&&(o=f.current().handler),void("/"==n[0]&&m.parse(n.substr(1))?e():t.sending||(t.sending=!0,h.send(n,o,function(n){void 0!==n&&void 0!==n.lines&&$.map(n.lines,function(e){s(e)}),t.sending=!1,e()})))):void e()},internal:function(e){s({curline:0,type:"internal",time:Math.floor((new Date).getTime()/1e3),name:"",message:e,name2:"",chan:f.current().handler})},val:function(t){return void 0===t?e.ongetval===!1?o.is("input")?o.val():o.text():e.ongetval():void(e.onsetval===!1?o.is("input")?o.val(t):o.text(t):e.onsetval(t))}};return{internal:t.internal,send:t.send,val:t.val}}(),v=function(){var e={tabWord:"",tabCount:0,isInTab:!1,startPos:0,startChar:"",endPos:0,endChar:"",endPos0:0,tabAppendStr:"",searchArray:[],node:!1,wysiwyg:!1,getCurrentWord:function(){var t=e.wysiwyg?(e.node=window.getSelection().anchorNode).nodeValue:o[0].value;if(e.isInTab)return e.tabWord;for(e.startPos=e.wysiwyg?window.getSelection().anchorOffset:o[0].selectionStart,e.startChar=t.charAt(e.startPos);" "!=e.startChar&&--e.startPos>0;)e.startChar=t.charAt(e.startPos);for(" "==e.startChar&&e.startPos++,e.endPos=e.wysiwyg?window.getSelection().anchorOffset:o[0].selectionStart,e.endChar=t.charAt(e.endPos);" "!=e.endChar&&++e.endPos<=t.length;)e.endChar=t.charAt(e.endPos);return e.endPos0=e.endPos,e.tabWord=t.substr(e.startPos,e.endPos-e.startPos).trim(),e.tabWord},getTabComplete:function(){var t,n=e.wysiwyg?e.node.nodeValue:o[0].value;null!==n&&(t=e.search(e.getCurrentWord(),e.tabCount),e.isInTab||(e.tabAppendStr=" ",0===e.startPos&&(e.tabAppendStr=": ")),t==e.getCurrentWord()&&(e.tabCount=0,t=e.search(e.getCurrentWord(),e.tabCount)),n=n.substr(0,e.startPos)+t+e.tabAppendStr+n.substr(e.endPos+1),e.wysiwyg?(window.getSelection().anchorNode.nodeValue=n,window.getSelection().getRangeAt(0).setEnd(e.node,e.startPos+t.length+e.tabAppendStr.length),window.getSelection().getRangeAt(0).setStart(e.node,e.startPos+t.length+e.tabAppendStr.length)):o[0].value=n,e.endPos=e.endPos0+t.length+e.tabAppendStr.length)},search:function(t,n){var o=!1;return n||(n=0),$.each(e.searchArray,function(e,r){0===r.toLowerCase().indexOf(t.toLowerCase())&&n--<=0&&o===!1&&(o=r)}),o!==!1?o:t},init:function(){e.wysiwyg=!o.is("input"),o.keydown(function(t){9==t.keyCode?t.ctrlKey||(t.preventDefault(),e.getTabComplete(),e.isInTab=!0,e.tabCount++,setTimeout(1,1)):(e.tabWord="",e.tabCount=0,e.isInTab=!1)})},load:function(){e.searchArray=$.merge(p.getNames(),f.getNames())}};return{init:e.init,load:e.load}}(),k=function(){var t={messages:[],counter:0,current:"",init:function(){o.keydown(function(e){38!=e.keyCode&&40!=e.keyCode||(e.preventDefault(),t.counter==t.messages.length&&(t.current=w.val()),0!==t.messages.length&&(38==e.keyCode?(0!==t.counter&&t.counter--,w.val(t.messages[t.counter])):(t.counter!=t.messages.length&&t.counter++,t.counter==t.messages.length?w.val(t.current):w.val(t.messages[t.counter]))))})},add:function(n){t.messages.push(n),t.messages.length>20&&t.messages.shift(),t.counter=t.messages.length,e.ls.set("oldMessages-"+e.channels.current().handlerB64,t.messages)},read:function(){t.messages=e.ls.get("oldMessages-"+e.channels.current().handlerB64),t.messages||(t.messages=[]),console.log(t.messages),t.counter=t.messages.length}};return{init:t.init,add:t.add,read:t.read}}(),b=function(){var t={menuOpen:!1,msgVal:"",$textDecoForm:!1,hideMenu:function(){t.$textDecoForm.css("display","none"),t.menuOpen=!1},reverseParse:function(e){if(e.indexOf("<")===-1)return $("<span>").html(e).text();var t=!1,n=!1,o=!1,r="-1",s="-1";return e=e.replace(/<img([^>]*?)>/gi,function(e,t){var n=t.match(/data-code="([^"]*)"/);return n?n[1]:""}),e=e.replace(/<span([^>]*?)>([^<]*?)<\/span>/gi,function(i,a,c){if(!a)return c;e="",a.indexOf("bold")==-1==t&&(t=!t,e+=""),a.indexOf("italic")==-1==n&&(n=!n,e+=""),a.indexOf("underline")==-1==o&&(o=!o,e+="");var l=a.match(/fg-(\d+)/),u=a.match(/bg-(\d+)/);return l||(l="-1"),u||(u="-1"),u==s&&l==r||(("-1"!=r&&"-1"==l||"-1"!=s&&"-1"==u)&&(e="",t&&(e+=""),n&&(e+=""),o&&(e+="")),e+="",r=l,"-1"!=r&&(e+=r),s=u,"-1"!=s&&(e+=","+s)),e+c}),$("<span>").html(e).text()},getCaretCharacterOffsetWithin:function(e){var t=window.getSelection();if(t.rangeCount>0){var n,o=t.getRangeAt(0),r=o.cloneRange(),s=0,i=document.createRange();r.selectNodeContents(e),r.setEnd(o.endContainer,o.endOffset),n=r.commonAncestorContainer.getElementsByTagName("img");for(var a=0;a<n.length;a++){var c=n[a];c.dataset.code&&(i.selectNode(c),1!=r.compareBoundaryPoints(Range.START_TO_START,i)&&r.compareBoundaryPoints(Range.END_TO_END,i)!=-1&&(s+=c.dataset.code.length))}return r.toString().length+s}return 0},getWholeSelection:function(e){var n,o=window.getSelection(),r=o.getRangeAt(0),s=r.cloneRange(),i=t.getCaretCharacterOffsetWithin(e);return r.collapse(!0),o.removeAllRanges(),o.addRange(r),n=t.getCaretCharacterOffsetWithin(e),o.removeAllRanges(),o.addRange(s),[n,i]},setCaretCharacterOffsetWithin:function(e,n,o,r,s){void 0===o&&(o=0),void 0===r&&(r=document.createRange()),void 0===s&&(s=!1);for(var i=0;i<e.childNodes.length;i++){var a=e.childNodes[i];if(3==a.nodeType){if(a.length>=n){var c=window.getSelection();if(s||(r.setStart(a,n),s=!0,n+=o),s&&a.length>=n)return r.setEnd(a,n),c.removeAllRanges(),c.addRange(r),-1}n-=a.length}else if(1==a.nodeType){if("IMG"==a.tagName&&a.dataset.code){if(a.dataset.code.length>=n){var c=window.getSelection();if(s||(r.setStartAfter(a),s=!0,n+=o),s&&a.dataset.code.length>=n)return r.setEndAfter(a),c.removeAllRanges(),c.addRange(r),-1}n-=a.dataset.code.length}else if(n=t.setCaretCharacterOffsetWithin(a,n,o,r,s),n<0)return-1}else if(n=t.setCaretCharacterOffsetWithin(a,n,o,r,s),n<0)return-1}return n},surroundSelection:function(e,t){var n=window.getSelection();if(n.rangeCount>0){var o=n.getRangeAt(0),r=o.startContainer,s=o.startOffset,i=document.createTextNode(e),a=document.createTextNode(t),c=o.cloneRange();c.collapse(!1),c.insertNode(a),c.setStart(r,s),c.collapse(!0),c.insertNode(i),o.setStartAfter(i),o.setEndBefore(a),n.removeAllRanges(),n.addRange(o)}},updateContent:function(e,n){void 0===e&&(e=n=t.getCaretCharacterOffsetWithin(o[0])),t.msgVal=t.reverseParse(o.html()),o.html(y.parse(t.msgVal)),t.setCaretCharacterOffsetWithin(o[0],e,n-e)},init:function(){if(t.support()){var r=o.attr("id"),s=$("<span>").attr({contenteditable:"true",accesskey:"i",id:r}).css({display:"inline-block",height:"1em",padding:"0.3em 0.2em 0.2em 0.3em",fontSize:"1.2em",verticalAlign:"top",whiteSpace:"nowrap",backgroundColor:o.css("backgroundColor")});for(var i in["Top","Bottom","Left","Right"])for(var a in["Style","Width","Color"])s.css("border"+i+a,o.css("border"+i+a));o.replaceWith(s),o=s,o.on("update",t.updateContent),t.$textDecoForm=$("<div>").css({position:"absolute",bottom:"3em"}).attr("id",n+"textDecoForm").append($("<button>").css("font-weight","bold").text("B").click(function(e){e.preventDefault();var n=t.getWholeSelection(o[0]);t.surroundSelection("",""),t.updateContent(n[0],n[1])}),"&nbsp;",$("<button>").css("font-style","italic").text("I").click(function(e){e.preventDefault();var n=t.getWholeSelection(o[0]);t.surroundSelection("",""),t.updateContent(n[0],n[1])}),"&nbsp;",$("<button>").css("text-decoration","underline").text("U").click(function(e){e.preventDefault();var n=t.getWholeSelection(o[0]);t.surroundSelection("",""),t.updateContent(n[0],n[1])}),"<br>",$.map([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],function(e){return[e%4==0?"<br>":"",$("<span>").css({display:"inline-block",height:"1em",width:"2em"}).addClass(n+"colorbutton").addClass(n+"bg-"+e).click(function(n){n.preventDefault();var r=t.getWholeSelection(o[0]);t.surroundSelection(""+e,""),t.updateContent(r[0],r[1])})]})).hide().insertBefore(o),e.onsetval=function(e){t.msgVal=e,o.html(y.parse(e))},e.ongetval=function(){return t.msgVal},o.on("input",function(e){t.updateContent()}),o.mouseup(function(e){var n=window.getSelection();n.isCollapsed||(e.preventDefault(),t.$textDecoForm.show().css("left",Math.max(e.pageX-52,0)),t.menuOpen=!0)}),$(document).mousedown(function(e){!$(e.target).closest(t.$textDecoForm).length&&t.menuOpen&&t.hideMenu()})}},support:function(){return"contentEditable"in document.documentElement&&d.get("wysiwyg")}};return{init:t.init,getMsg:t.getMsg,support:t.support,updateContent:t.updateContent}}(),C=function(){var e={text:"",started:!1,start:function(){return d.get("statusBar")?void(e.started||(setInterval(function(){if(window.status=e.text,parent)try{parent.window.status=e.text}catch(t){}},500),e.started=!0)):void(e.started=!0)},set:function(t){e.text=t,e.started||e.start()}};return{set:e.set}}(),S=function(){var t={support_webkit:void 0!==window.webkitNotifications&&null!==window.webkitNotifications&&window.webkitNotifications,support:function(){return"undefined"!=typeof Notification&&Notification&&"denied"!=Notification.permission},show:function(e){var n;t.support_webkit?(n=window.webkitNotifications.createNotification("omni.png","OmnomIRC Highlight",e),n.show()):t.support()&&(n=new Notification("OmnomIRC Highlight",{icon:"omni.png",body:e}),n.onshow=function(){setTimeout(n.close,3e4)})},request:function(){t.support_webkit?window.webkitNotifications.requestPermission(function(){0===window.webkitNotifications.checkPermission()&&(t.show("Notifications Enabled!"),e.options.set("browserNotifications",!0),document.location.reload())}):t.support()?Notification.requestPermission(function(n){Notification.permission!==n&&(Notification.permission=n),"granted"===n&&(t.show("Notifications Enabled!"),e.options.set("browserNotifications",!0),document.location.reload())}):alert("Your browser doesn't support notifications")},sound:!1,make:function(n,o){var r=g.current();r&&(d.get("browserNotifications")&&t.show(n),d.get("ding")&&t.sound&&t.sound.play()),t.startFlash(),e.onnotification(n,o,r)},doFlash:!1,intervalHandler:!1,originalTitle:"",target:top.postMessage?top:top.document.postMessage?top.document:void 0,startFlash:function(){if(!t.doFlash)if(t.doFlash=!0,
top==window){var e=!1;t.originalTitle=document.title,t.intervalHandler=setInterval(function(){document.title=(e?"[ @] ":"[@ ] ")+t.originalTitle,e=!e},500)}else void 0!==t.target&&t.target.postMessage("startFlash","*")},stopFlash:function(n){void 0===n&&(n=!1),t.doFlash&&(top==window?t.intervalHandler&&(clearInterval(t.intervalHandler),t.intervalHandler=!1,document.title=t.originalTitle):void 0!==t.target&&t.target.postMessage("stopFlash","*"),t.doFlash=!1,n||e.ls.set("stopFlash",Math.random().toString(36)+(new Date).getTime().toString()))},init:function(){$(window).on("storage",function(e){e.originalEvent.key==i.net()+"stopFlash"&&t.stopFlash(!0)}).unload(function(){t.stopFlash(!0)}).focus(function(){t.stopFlash()}),t.sound||(t.sound=new Audio("beep.mp3"))}};return{request:t.request,make:t.make,init:t.init}}(),y=function(){var t={smileys_a:[],cacheServerNicks:{},spLinks:[],name:function(e,o,r){void 0===r&&(r=-1),e="\0"==e?"":e;var s=encodeURIComponent(e);e=$("<span>").text(e).html();var a=[19,20,22,24,25,26,27,28,29],u=0,g=0,h=e,f=i.getNetwork(o),p=!0;switch(d.get("colordNames")){case"1":for(;e[g];)u+=e.charCodeAt(g++);h=$("<span>").append($("<span>").addClass(n+"uName-"+a[u%9].toString()).html(e)).html();break;case"2":void 0!==f&&void 0!==f.checkLogin&&r!=-1?(h=c.get("nick"+o.toString()+":"+r.toString()),h||(p=!1,void 0===t.cacheServerNicks[o.toString()+":"+r.toString()]&&l.getJSON(f.checkLogin+"?c="+r.toString(10)+"&n="+s,function(e){t.cacheServerNicks[o.toString()+":"+r.toString()]=e.nick},!1,!1),h=t.cacheServerNicks[o.toString()+":"+r.toString()],c.set("nick"+o.toString()+":"+r.toString(),h))):h=e;break;default:h=e}return void 0!==f&&p&&(h=f.normal.split("NICKENCODE").join(s).split("NICK").join(h).split("USERID").join(r.toString(10))),void 0!==f?'<span title="'+f.name+'">'+h+"</span>":'<span title="Unknown Network">'+h+"</span>"},smileys:function(e){return e?/^[\w\s\d\.,!?]*$/.test(e)?e:($.each(t.smileys_a,function(t,n){e=e.replace(RegExp(n.regex,"g"),n.replace)}),e):""},links:function(e){if(!e||null===e||void 0===e)return"";var n='[^\\s<"]';return e=e.replace(RegExp("(|)","g"),""),$.map(t.spLinks,function(t){t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=e.replace(RegExp("(^|[\\s>])((?:(?:f|ht)tps?://(?:www\\.)?)"+t+n+"*)","g"),"$1$2").replace(RegExp("(^|[\\s>])("+t+n+"*)","g"),"$1$2")}),e.replace(RegExp('(^|[^a-zA-Z0-9_"])((?:(?:f|ht)tps?://)'+n+"+)","g"),'$1<a target="_blank" href="$2">$2</a>').replace(RegExp("(^|[^a-zA-Z0-9_/])(www\\."+n+"+)","g"),'$1<a target="_blank" href="http://$2">$2</a>').replace(RegExp("(^|.)("+n+"+)","g"),'$1<a target="_top" href="$2">$2</a>').replace(RegExp("(^|.)("+n+"+)","g"),'$1<a target="_top" href="http://$2">$2</a>')},colors:function(e){var t,o,r,s=[],i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};if(!e)return"";for(s=e.split(RegExp("([])")),e="<span>",o=0;o<s.length;o++){switch(r=!0,s[o]){case"":t=s[o+1].replace(/^([0-9]{1,2}),([0-9]{1,2})(.*)/,"$1:$2"),t==s[o+1]?(t=s[o+1].replace(/^([0-9]{1,2}).*/,"$1:"),t!=s[o+1]?(i.fg=t.split(":")[0],s[o+1]=s[o+1].substr(t.length-1)):(i.fg="-1",i.bg="-1")):(i.fg=t.split(":")[0],i.bg=t.split(":")[1],t==s[o+1]?s[o+1]="":s[o+1]=s[o+1].substr(t.length));break;case"":i.bold=!i.bold;break;case"":i.italic=!i.italic;break;case"":t=i.fg,i.fg=i.bg,i.bg=t,"-1"==i.fg&&(i.fg="0"),"-1"==i.bg&&(i.bg="1");break;case"":i.underline=!i.underline;break;case"":i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};break;default:r=!1}e+=r?'</span><span class="'+n+"fg-"+i.fg+" "+n+"bg-"+i.bg+'" style="'+(i.bold?"font-weight:bold;":"")+(i.underline?"text-decoration:underline;":"")+(i.italic?"font-style:italic;":"")+'">':s[o]}return e+="</span>",e=e.replace(/(\x03|\x02|\x1F|\x09|\x0F)/g,"")},highlight:function(e){var t="";return d.get("highRed")||(t+="background:none;padding:none;border:none;"),d.get("highBold")&&(t+="font-weight:bold;"),'<span class="highlight" style="'+t+'">'+e+"</span>"},parse:function(e,n){return void 0!=n&&n||(n=!1),e="\0"==e?"":e,e=$("<span>").text(e).html(),d.get("smileys")&&n===!1&&(e=t.smileys(e)),e=t.colors(e),e=t.links(e)},setSmileys:function(e){t.smileys_a=[],$.each(e,function(e,n){t.smileys_a.push({regex:n.regex,replace:n.replace.split("ADDSTUFF").join('data-code="'+n.code+'"').split("PIC").join(n.pic).split("ALT").join(n.alt)})})},setSpLinks:function(e){t.spLinks=e},parseTextDecorations:function(e){return""!==e&&d.get("textDeco")&&(">"==e[0]&&(e="3"+e),e=e.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),e},addLine:function(n,o){if("highlight"==n.type||n.chan.toString().toLowerCase()==f.current().handler.toLowerCase()||n.name2===i.getPmIdent()){var r=t.name(n.name,n.network,n.uid),s=t.parse(n.message),a="*",c=s;switch(""!=i.nick()&&["message","action","pm","pmaction"].indexOf(n.type)>=0&&"*"!=n.name.toLowerCase()&&s.toLowerCase().indexOf(i.nick().toLowerCase().substr(0,d.get("charsHigh")))>=0&&(c=s=y.highlight(s),!o&&P.isBlurred()&&S.make("("+f.current().name+") <"+n.name+"> "+n.message,n.chan)),n.type){case"reload":return void(o||f.current().reload());case"reload_userlist":return void(o||f.current().reloadUserlist());case"relog":return void(o||i.fetch(void 0,!0));case"refresh":return void(o||location.reload(!0));case"join":if(c=[r," has joined "+f.current().name],o||p.add({nick:n.name,network:n.network}),1==i.getNetwork(n.network).type&&!d.get("oircJoinPart"))return;break;case"part":if(c=[r," has left "+f.current().name+" (",s,")"],o||p.remove({nick:n.name,network:n.network}),1==i.getNetwork(n.network).type&&!d.get("oircJoinPart"))return;break;case"quit":if(c=[r," has quit IRC (",s,")"],o||p.remove({nick:n.name,network:n.network}),1==i.getNetwork(n.network).type&&!d.get("oircJoinPart"))return;break;case"kick":c=[r," has kicked ",y.name(n.name2,n.network)," from "+f.current().name+" (",s,")"],o||p.remove({nick:n.name2,network:n.network});break;case"message":a=r;break;case"action":c=[r," ",s];break;case"mode":"string"==typeof s&&(s=n.message.split(" "),$.each(s,function(e,t){var o=$("<span>").html(t).text();o.indexOf("+")==-1&&o.indexOf("-")==-1&&(s[e]=y.name(t,n.network))}),s=s.join(" ")),c=[r," set "+f.current().name+" mode ",s];break;case"nick":c=[r," has changed nicks to ",y.name(n.name2,n.network)],o||(p.add({nick:n.name2,network:n.network}),p.remove({nick:n.name,network:n.network}));break;case"topic":if(e.ontopicchange(y.parse(n.message,!0)),""===n.name&&0===n.network&&o)return;c=[r," has changed the topic to ",y.parse(n.message,!0)];break;case"pm":if(n.chan==f.current().handler)a=r,n.type="message";else{if(o)return;if(n.name.toLowerCase()==i.nick().toLowerCase())return void f.joinPm(n.chan,i.getWholePmIdent(n.uid,n.network));a=["(PM)",r],f.joinPm(n.name,i.getWholePmIdent(n.uid,n.network)),S.make("(PM) <"+n.name+"> "+n.message,n.chan)}break;case"pmaction":if(n.chan==f.current().handler)c=[r," ",s],n.type="action";else{if(o)return;if(n.name.toLowerCase()==i.nick().toLowerCase())return void f.joinPm(n.chan,i.getWholePmIdent(n.uid,n.network));c=["(PM)",r," ",s],f.joinPm(n.name,i.getWholePmIdent(n.uid,n.network)),notofication.make("* (PM)"+n.name+" "+n.message,n.chan),n.type="pm"}break;case"highlight":return void("*"!=n.name.toLowerCase()&&S.make("("+n.chan+") <"+n.name+"> "+n.message,n.chan));case"internal":c=n.message;break;case"server":break;default:return}e.onmessage(a,c,n,o)}}};return{setSmileys:t.setSmileys,setSpLinks:t.setSpLinks,parse:t.parse,parseTextDecorations:t.parseTextDecorations,name:t.name,highlight:t.highlight,addLine:t.addLine}}(),x=function(){var e={$errors:!1,$warnings:!1,errors:[],warnings:[],$errorsPopup:!1,$warningsPopup:!1,getSinglePopupEntry:function(e){return $("<div>").css("border-bottom","1px solid black").append("Time: ",new Date(e.time).toLocaleTimeString(),"<br>File: ",$("<span>").text(e.file).html(),$.map(e.content,function(e,t){return["<br>",$("<span>").text(t).html(),": ",$("<span>").text(e).html()]}))},makePopup:function(t,n,o){return $("<div>").addClass("errorPopup").addClass(t.toLowerCase()).append($("<a>").text("Close").click(function(e){e.preventDefault(),$(this).parent().remove(),o()}),"&nbsp;",$("<b>").text(t),$("<div>").addClass("errorPopupCont").append($.map(n,function(t){return e.getSinglePopupEntry(t)}))).appendTo("body")},init:function(t,n){void 0===t&&(t=$("#errors")),void 0===n&&(n=$("#warnings")),t.click(function(){e.$errorsPopup||(e.$errorsPopup=e.makePopup("Errors",e.errors,function(){e.$errorsPopup=!1}))}),n.click(function(){e.$warningsPopup||(e.$warningsPopup=e.makePopup("Warnings",e.warnings,function(){e.$warningsPopup=!1}))}),e.$errors=t,e.$warnings=n},addError:function(t,n){e.errors.push({time:(new Date).getTime(),file:t,content:n}),e.$errors.css("display","").find(".count").text(e.errors.length),e.$errorsPopup&&e.$errorsPopup.children("div").append(e.getSinglePopupEntry(e.errors[e.errors.length-1]))},addWarning:function(t,n){e.warnings.push({time:(new Date).getTime(),file:t,content:n}),e.$warnings.css("display","").find(".count").text(e.warnings.length),e.$warningsPopup&&e.$warningsPopup.children("div").append(e.getSinglePopupEntry(e.warnings[e.warnings.length-1]))}};return{addError:e.addError,addWarning:e.addWarning,init:e.init}}(),P=function(){var t={isBlurred:!0,init:function(){$(window).blur(function(){t.isBlurred=!0}).focus(function(){t.isBlurred=!1})},changeLinks:function(){$('#adminLink a,a[href="."],a[href="?options"],a[href="index.php"]').each(function(){void 0!==$(this).attr("href").split("?")[1]?$(this).attr("href",$(this).attr("href")+"&network="+e.settings.net()):$(this).attr("href",$(this).attr("href")+"?network="+e.settings.net())})}};return{init:t.init,changeLinks:t.changeLinks,isBlurred:function(){return t.isBlurred}}}(),N=function(){var e={isOpen:!1,open:function(t){e.isOpen||(e.isOpen=!0,h.stop(t))},close:function(){e.isOpen&&(e.isOpen=!1,f.current().reload())},fetch:function(t,n,o){e.isOpen&&(void 0===o&&(o=0),l.getJSON("Log.php?day="+t+"&offset="+parseInt(o,10)+"&channel="+f.current().handlerB64,function(r){r.banned?(w.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),n(!1)):($.map(r.lines,function(e){s(e,!0)}),r.lines.length>=1e3?e.fetch(t,n,o+1e3):void 0!==n&&n(!0))}))}};return{fetch:e.fetch,open:e.open,close:e.close}}();this.OMNOMIRCSERVER=t,this.settings={loggedIn:i.loggedIn,fetch:i.fetch,net:i.net,getNetwork:i.getNetwork,getPmIdent:i.getPmIdent,getWholePmIdent:i.getWholePmIdent,nick:i.nick,guestLevel:i.guestLevel,identGuest:i.identGuest,logout:i.logout},this.ls={get:a.get,set:a.set},this.network={getJSON:l.getJSON,post:l.post},this.options={get:d.get,set:d.set,getAll:d.getAll},this.instant={current:g.current},this.channels={load:f.load,join:f.join,joinPm:f.joinPm,part:f.part,getList:f.getList,getHandler:f.getHandler,current:f.current,setChans:f.setChans,highlight:f.highlight},this.users={add:p.add,remove:p.remove,setUsers:p.setUsers},this.send={send:w.send,internal:w.internal,val:w.val},this.parser={parse:y.parse,name:y.name,highlight:y.highlight},this.error={addWarning:x.addWarning,addError:x.addError,init:x.init},this.page={changeLinks:P.changeLinks,isBlurred:P.isBlurred},this.logs={fetch:N.fetch,open:N.open,close:N.close},this.statusBar={set:C.set},this.initinput=function(e,t){void 0===e&&(e=$("#message")),o=e,t&&b.init(),v.init(),k.init(),o.keypress(function(e){13==e.which&&(e.preventDefault(),o.attr("disabled")||w.send(function(){w.val(""),o.focus()}))})},this.connect=function(e){P.init(),S.init(),i.fetch(function(){g.init(),h.init(),f.init(),e()})},this.disconnect=function(){g.kill(),h.kill()},this.setClassPrefix=function(e){n=e},this.onerror=function(){},this.onwarning=function(){},this.onmessage=function(){},this.onmessageraw=!1,this.onuserchange=function(){},this.onchannelchange=function(){},this.onchanneljoin=function(){},this.onchannelpart=function(){},this.onsmileychange=function(){},this.onsetval=!1,this.ongetval=!1,this.ontopicchange=function(){},this.onnotification=function(){},e=this,void 0!==this.setOptions&&(this.options.setAll=d.setAll,this.setOptions(),delete this.options.setAll)}