/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2016 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";var oirc=function(){var e="https://omnomirc.omnimaga.org",t=function(){var e={hostname:"",nick:"",signature:"",numHigh:4,uid:-1,checkLoginUrl:"",net:"",networks:{},pmIdent:false,fetch:function(t,a){if(a===undefined){a=false}i.getJSON("config.php?js"+(document.URL.split("network=")[1]!==undefined?"&network="+document.URL.split("network=")[1].split("&")[0].split("#")[0]:"")+(a?"&clonly":""),function(r){var o;if(!a){e.hostname=r.hostname;c.setChans(r.channels);C.setSmileys(r.smileys);m.setSmileys(r.smileys);e.networks={};$.each(r.networks,function(t,n){e.networks[n.id]=n});e.net=r.network;n.setPrefix(e.net);s.setDefaults(r.defaults);s.setExtraChanMsg(r.extraChanMsg);l.setData(r.websockets.use,r.websockets.host,r.websockets.port,r.websockets.ssl)}e.checkLoginUrl=r.checkLoginUrl;o=n.get("checklogin");if(!o||a){i.getJSON(e.checkLoginUrl+"&network="+e.net.toString()+"&jsoncallback=?",function(i){e.nick=i.nick;e.signature=i.signature;e.uid=i.uid;e.pmIdent="["+e.net.toString()+","+e.uid.toString()+"]";n.set("checklogin",{nick:e.nick,signature:e.signature,uid:e.uid});if(t!==undefined){t()}},!a,false)}else{e.nick=o.nick;e.signature=o.signature;e.uid=o.uid;e.pmIdent="["+e.net.toString()+","+e.uid.toString()+"]";if(t!==undefined){t()}}},!a,false)},getUrlParams:function(){return"nick="+base64.encode(e.nick)+"&signature="+base64.encode(e.signature)+"&time="+(+new Date).toString()+"&id="+e.uid+"&network="+e.net+(e.nick!=""?"&noLoginErrors":"")},getNetwork:function(t){if(e.networks[t]!==undefined){return e.networks[t]}return{id:-1,normal:"NICK",userlist:"NICK",name:"Invalid network",type:-1}},getIdentParams:function(){return{nick:e.nick,signature:e.signature,time:(+new Date).toString(),id:e.uid,network:e.net}},loggedIn:function(){return e.signature!==""},getWholePmIdent:function(t,n){var i="["+n.toString()+","+t.toString()+"]";if(n<e.net){return i+e.pmIdent}else if(e.net<n){return e.pmIdent+i}else if(t<e.uid){return i+e.pmIdent}else{return e.pmIdent+i}}};return{fetch:e.fetch,getUrlParams:e.getUrlParams,getIdentParams:e.getIdentParams,getNetwork:e.getNetwork,nick:function(){return e.nick},net:function(){return e.net},loggedIn:e.loggedIn,getPmIdent:function(){return e.pmIdent},getWholePmIdent:e.getWholePmIdent}}(),n=function(){var e={prefix:"",setPrefix:function(t){e.prefix=t},getCookie:function(e){var t,n,i,s=document.cookie.split(";");for(t=0;t<s.length;t++){n=s[t].substr(0,s[t].indexOf("="));i=s[t].substr(s[t].indexOf("=")+1);n=n.replace(/^\s+|\s+$/g,"");if(n==e){return unescape(i)}}},setCookie:function(e,t,n){var i=new Date,s=escape(t);i.setDate(i.getDate()+n);s+=n===null?"":"; expires="+i.toUTCString();document.cookie=e+"="+s},haveSupport:null,support:function(){if(e.haveSupport===null){try{localStorage.setItem("test",1);localStorage.removeItem("test");e.haveSupport=true}catch(t){e.haveSupport=false}}return e.haveSupport},get:function(t){var n;t=e.prefix+t;if(e.support()){n=localStorage.getItem(t)}else{n=getCookie(t)}return JSON.parse(n)},set:function(t,n){t=e.prefix+t;n=JSON.stringify(n);if(e.support()){localStorage.setItem(t,n)}else{setCookie(t,n)}}};return{setPrefix:e.setPrefix,get:e.get,set:e.set}}(),i=function(){var e={errors:[],warnings:[],errorsOpen:false,warningsOpen:false,didRelog:false,removeSig:function(e){try{var t=e.split("signature="),n=t[1].split("&");n[0]="---";t[1]=n.join("&");return t.join("signature=")}catch(i){if(e.indexOf("signature")!==-1){return"omited due to security reasons"}return e}},addError:function(t,n){t=e.removeSig(t);e.errors.push({time:(new Date).getTime(),file:t,content:n});$("#errors").css("display","").find(".count").text(e.errors.length)},addWarning:function(t,n){t=e.removeSig(t);e.warnings.push({time:(new Date).getTime(),file:t,content:n});$("#warnings").css("display","").find(".count").text(e.warnings.length)},checkCallback:function(n,i,s,a){if(n.relog!=2){if(n.errors!==undefined){$.map(n.errors,function(t){if(t.type!==undefined){e.addError(a,t)}else{e.addError(a,{type:"misc",message:t})}if(e.errorsOpen){$(".errors > .errorPopupCont").append(e.getSinglePopupEntry(errors[errors.length-1]))}})}if(n.warnings!==undefined){$.map(n.warnings,function(t){if(t.type!==undefined){e.addWarning(a,t)}else{e.addWarning(a,{type:"misc",message:t})}if(e.warningsOpen){$(".warnings > .errorPopupCont").append(e.getSinglePopupEntry(warnings[warnings.length-1]))}})}}if(n.relog!==undefined&&n.relog!=0){if(n.relog==1){t.fetch(undefined,true);i(n)}else if(n.relog==2){t.fetch(function(){s()},true)}else if(n.relog==3){if(e.didRelog){i(n)}else{t.fetch(function(){s()},true)}e.didRelog=true}}else{if(n.relog!==undefined){e.didRelog=false}i(n)}},getSinglePopupEntry:function(e){return $("<div>").css("border-bottom","1px solid black").append("Time: ",new Date(e.time).toLocaleTimeString(),"<br>File: ",$("<span>").text(e.file).html(),$.map(e.content,function(e,t){return["<br>",$("<span>").text(t).html(),": ",$("<span>").text(e).html()]}))},makePopup:function(t,n,i){return $("<div>").addClass("errorPopup").addClass(t.toLowerCase()).append($("<a>").text("Close").click(function(e){e.preventDefault();$(this).parent().remove();i()}),"&nbsp;",$("<b>").text(t),$("<div>").addClass("errorPopupCont").append($.map(n,function(t){return e.getSinglePopupEntry(t)}))).appendTo("body")},getJSON:function(n,i,s,a){if(s==undefined){s=true}if(a==undefined){a=true}var r=n+(a?"&"+t.getUrlParams():"");return $.ajax({url:r,dataType:"json",async:s}).done(function(t){e.checkCallback(t,i,function(){e.getJSON(n,i,s,a)},r)})},post:function(n,i,s,a,r){if(a==undefined){a=true}if(r==undefined){r=true}var o=n+(r?"&"+t.getUrlParams():"");return $.ajax({type:"POST",url:o,async:a,data:i}).done(function(t){e.checkCallback(t,s,function(){e.post(n,i,s,a,r)},o)})},init:function(){$("#errors > .icon").click(function(){if(!e.errorsOpen){e.errorsOpen=true;e.makePopup("Errors",e.errors,function(){e.errorsOpen=false})}});$("#warnings > .icon").click(function(){if(!e.warningsOpen){e.warningsOpen=true;e.makePopup("Warnings",e.warnings,function(){e.warningsOpen=false})}})}};return{getJSON:e.getJSON,post:e.post,init:e.init}}(),s=function(){var e={extraChanMsg:"",allOptions:{highBold:{disp:"Highlight Bold","default":true},highRed:{disp:"Highlight Red","default":true},colordNames:{disp:"Colored Names","default":0,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("colordNames",this.value)}).append($.map(["none","calc","server"],function(t,n){return $("<option>").attr(e.get("colordNames")==n?"selected":"false","selected").val(n).text(t)})))}},curChan:{hidden:true,"default":0},extraChans:{disp:"Show extra Channels","default":false,before:function(){if(e.extraChanMsg!==""){alert(e.extraChanMsg)}return true}},altLines:{disp:"Alternating Line Highlight","default":true},enable:{disp:"Enable OmnomIRC","default":true},ding:{disp:"Ding on Highlight","default":false},times:{disp:"Show Timestamps","default":true},statusBar:{disp:"Show Updates in Browser Status Bar","default":true},smileys:{disp:"Show Smileys","default":true},hideUserlist:{disp:"Hide Userlist","default":false},charsHigh:{disp:"Number chars for Highlighting","default":4,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("charsHigh",this.value)}).append($.map([1,2,3,4,5,6,7,8,9,10],function(t){return $("<option>").attr(e.get("charsHigh")==t?"selected":"false","selected").val(t).text(t)})))}},scrollBar:{disp:"Show Scrollbar","default":true},scrollWheel:{disp:"Enable Scrollwheel","default":true},browserNotifications:{disp:"Browser Notifications","default":false,before:function(){o.request();return false}},oircJoinPart:{disp:"Show OmnomIRC join/part messages","default":false},wysiwyg:{disp:"Use WYSIWYG editor (experimental)","default":false},textDeco:{disp:"Enable simple text decorations","default":false},fontSize:{disp:"Font Size","default":9,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<input>").attr({type:"number",step:1,min:1,max:42}).css("width","3em").val(e.get("fontSize")).change(function(){e.set("fontSize",parseInt(this.value,10));$("body").css("font-size",this.value+"pt")}))}}},set:function(t,i){if(e.allOptions[t]===undefined){return}e.allOptions[t].value=i;var s=n.get("options")||{};s[t]=i;n.set("options",s)},get:function(t){if(e.allOptions[t]!==undefined){return e.allOptions[t].value}},setExtraChanMsg:function(t){e.extraChanMsg=t},setDefaults:function(t){var i=n.get("options");$.each(e.allOptions,function(n,s){var a=s.default;if(i&&i[n]!==undefined){a=i[n]}else if(t&&t[n]!==undefined){a=t[n]}e.allOptions[n].value=a})},getHTML:function(){return $.merge($.map([false,true],function(t){return $("<table>").addClass("optionsTable").append($.map(e.allOptions,function(n,i){if(n.hidden){return}return(t=!t)?$("<tr>").append($.merge([$("<td>").text(n.disp)],n.handler===undefined?[$("<td>").addClass("option "+(e.get(i)?"selected":"")).text("Yes").click(function(){if(!e.get(i)){if(n.before!==undefined&&n.before()||n.before===undefined){e.set(i,true);$(this).addClass("selected").next().removeClass("selected")}}}),$("<td>").addClass("option "+(!e.get(i)?"selected":"")).text("No").click(function(){if(e.get(i)){e.set(i,false);$(this).addClass("selected").prev().removeClass("selected")}})]:n.handler())):""}))}),$("<div>").append("&nbsp;",$("<a>").text("Reset Defaults").click(function(e){e.preventDefault();n.set("options",null);n.set("checklogin",null);n.set("channels",null);document.location.reload()})))},getAll:function(){var t={};$.each(e.allOptions,function(e,n){if(n.hidden===undefined||!n.hidden){t[e]=n.value}});return t}};return{set:e.set,get:e.get,setDefaults:e.setDefaults,setExtraChanMsg:e.setExtraChanMsg,getHTML:e.getHTML,getAll:e.getAll}}(),a=function(){var e={id:Math.random().toString(36)+(new Date).getTime().toString(),update:function(){n.set("browserTab",e.id);n.set("newInstant",false)},init:function(){n.set("browserTab",e.id);$(window).focus(function(){e.update()}).unload(function(){n.set("newInstant",true)})},current:function(){if(n.get("newInstant")){e.update()}return e.id==n.get("browserTab")}};return{init:e.init,current:e.current}}(),r=function(){var e={interval:false,$elem:false,start:function(){if(e.interval===false){var t=[true,true,true,true,true,false,false,false];e.$elem=$("<div>").attr("id","indicator").css({position:"absolute",zIndex:44,margin:0,padding:0,top:0,right:0}).appendTo("body");e.interval=setInterval(function(){e.$elem.empty().append($.map(t,function(e){return $("<div>").css({padding:0,margin:0,width:3,height:3,backgroundColor:e?"black":""})}));var n=t[0],i;for(i=1;i<=7;i++){t[i-1]=t[i]}t[7]=n},50)}},stop:function(){if(e.interval!==false){clearInterval(e.interval);e.interval=false;e.$elem.remove()}}};return{start:e.start,stop:e.stop}}(),o=function(){var e={support_webkit:window.webkitNotifications!==undefined&&window.webkitNotifications!==null&&window.webkitNotifications,support:function(){return typeof Notification!="undefined"&&Notification&&Notification.permission!="denied"},show:function(t){var n;if(e.support_webkit){n=window.webkitNotifications.createNotification("omni.png","OmnomIRC Highlight",t);n.show()}else if(e.support()){n=new Notification("OmnomIRC Highlight",{icon:"omni.png",body:t});n.onshow=function(){setTimeout(n.close,3e4)}}},request:function(){if(e.support_webkit){window.webkitNotifications.requestPermission(function(){if(window.webkitNotifications.checkPermission()===0){show("Notifications Enabled!");s.set(7,true);document.location.reload()}})}else if(e.support()){Notification.requestPermission(function(e){if(Notification.permission!==e){Notification.permission=e}if(e==="granted"){show("Notifications Enabled!");s.set(7,true);document.location.reload()}})}else{alert("Your browser doesn't support notifications")}},make:function(t,n){if(a.current()){if(s.get("browserNotifications")){e.show(t)}if(s.get("ding")){$("#ding")[0].play()}if(n!=c.current().handler){c.highlight(n,true)}}else{if(n!=c.current().handler){c.highlight(n)}}e.startFlash()},doFlash:false,intervalHandler:false,originalTitle:"",target:top.postMessage?top:top.document.postMessage?top.document:undefined,startFlash:function(){if(e.doFlash){return}e.doFlash=true;if(top==window){var t=false;e.originalTitle=document.title;e.intervalHandler=setInterval(function(){document.title=(t?"[ @] ":"[@ ] ")+e.originalTitle;t=!t},500)}else{if(e.target!==undefined){e.target.postMessage("startFlash","*")}}},stopFlash:function(t){if(t===undefined){t=false}if(e.doFlash){if(top==window){if(e.intervalHandler){clearInterval(e.intervalHandler);e.intervalHandler=false;document.title=e.originalTitle}}else{if(e.target!==undefined){e.target.postMessage("stopFlash","*")}}e.doFlash=false;if(!t){n.set("stopFlash",Math.random().toString(36)+(new Date).getTime().toString())}}},init:function(){$(window).on("storage",function(n){if(n.originalEvent.key==t.net()+"stopFlash"){e.stopFlash(true)}})}};return{request:e.request,make:e.make,stopFlash:e.stopFlash,init:e.init}}(),l=function(){var e={ws:{socket:false,connected:false,use:true,sendBuffer:[],allowLines:false,enabled:false,host:"",port:0,ssl:true,tryFallback:true,didRelog:false,fallback:function(){console.log("trying fallback...");if(e.ws.tryFallback){try{e.ws.tryFallback=false;e.ws.socket.close()}catch(t){}i.getJSON("omnomirc.php?getcurline&noLoginErrors",function(t){c.current().reloadUserlist();e.setCurLine(t.curline);use=false;e.old.lastSuccess=(new Date).getTime();e.old.start()})}},identify:function(){e.ws.send($.extend({action:"ident"},t.getIdentParams()))},init:function(){if(!("WebSocket"in window)||!e.ws.enabled){e.ws.use=false;return false}try{var n=window.location.pathname.split("/");n.pop();if(n.length>1&&n[n.length-1]===""){n.pop()}n.push("ws");n.push(t.net());e.ws.socket=new PooledWebSocket((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+n.join("/"))}catch(i){console.log(e.ws.socket);console.log((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+n.join("/"));console.log(i);e.ws.fallback()}e.ws.socket.onopen=function(t){e.ws.connected=true;for(var n=0;n<e.ws.sendBuffer.length;n++){e.ws.send(e.ws.sendBuffer[n])}e.ws.sendBuffer=[]};e.ws.socket.onmessage=function(n){try{var i=JSON.parse(n.data);console.log(i);if(e.ws.allowLines&&i.line!==undefined){if(!C.addLine(i.line)){e.ws.tryFallback=false;delete e.ws.socket}}if(i.relog!==undefined&&i.relog!=0){if(!e.ws.didRelog){e.ws.didRelog=true;t.fetch(function(){if(t.loggedIn()){e.ws.identify();e.ws.didRelog=false}},true)}}}catch(n){}};e.ws.socket.onclose=function(t){console.log("CLOOOOOOOOOSE");console.log(t);e.ws.use=false;e.ws.fallback()};e.ws.socket.onerror=function(t){console.log("ERRRORRRR");console.log(t);delete e.ws.socket;e.ws.use=false;e.ws.fallback()};e.ws.identify();$(window).on("beforeunload",function(){e.partChan(c.current().handler);delete e.ws.socket});return true},send:function(t){if(e.ws.connected){e.ws.socket.send(JSON.stringify(t))}else{e.ws.sendBuffer.push(t)}}},old:{inRequest:false,handler:false,lastSuccess:(new Date).getTime(),sendRequest:function(){if(!c.current().loaded()){return}e.old.handler=i.getJSON("Update.php?high="+s.get("charsHigh").toString()+"&channel="+c.current().handlerB64+"&lineNum="+e.curLine.toString(),function(t){var n=true;if(!c.current().loaded()){return}e.old.handler=false;e.old.lastSuccess=(new Date).getTime();if(t.lines!==undefined){$.each(t.lines,function(e,t){return n=C.addLine(t)})}if(t.banned===true){n=false}if(n){e.old.setTimer()}}).fail(function(){e.old.handler=false;if((new Date).getTime()>=e.old.lastSuccess+3e5){v.internal('<span style="color:#C73232;">OmnomIRC has lost connection to server. Please refresh to reconnect.</span>')}else if(!e.old.inRequest){e.old.lastSuccess=(new Date).getTime()}else{e.old.setTimer()}})},setTimer:function(){if(c.current().loaded()&&e.old.handler===false){setTimeout(function(){e.old.sendRequest()},m.isBlurred()?2500:200)}else{e.old.stop()}},start:function(){if(!e.old.inRequest){e.old.inRequest=true;e.old.setTimer()}},stop:function(){if(e.old.inRequest){e.old.inRequest=false;try{e.old.handler.abort()}catch(t){}}},send:function(t,n){e.old.stop();i.getJSON("message.php?message="+base64.encode(t)+"&channel="+c.current().handlerB64,function(){e.old.start();if(n!==undefined){n()}})}},curLine:0,setChan:function(t){if(e.ws.use){e.ws.send({action:"joinchan",chan:t})}},partChan:function(t){if(e.ws.use){e.ws.send({action:"partchan",chan:t})}},stop:function(){if(e.ws.use){e.ws.allowLines=false}else{e.old.stop()}},start:function(){if(e.ws.use){e.ws.allowLines=true}else{e.old.start()}},setCurLine:function(t){if(t>e.curLine){e.curLine=t}},send:function(t,n){if(e.ws.use){e.ws.send({action:"message",channel:c.current().handler,message:t});if(n!==undefined){n()}}else{e.old.send(t,n)}},setData:function(t,n,i,s){e.ws.enabled=t;e.ws.host=n;e.ws.port=i;e.ws.ssl=s},init:function(){if(e.ws.enabled){e.ws.init()}else{e.ws.use=false;e.old.lastSuccess=(new Date).getTime();e.old.start()}}};return{setChan:e.setChan,partChan:e.partChan,start:e.start,stop:e.stop,setCurLine:e.setCurLine,send:e.send,setData:e.setData,init:e.init}}(),c=function(){var e=function(e,t){var n=t.chans[e]!==undefined,a={i:e,name:n?t.chans[e].chan.toLowerCase():"",handler:n?t.getHandler(e):-1,handlerB64:n?t.getHandler(e,true):-1,loaded:false,load:function(t,n){if(t.lines===undefined){if(t.message){v.internal(t.message)}else{v.internal('<span style="color:#C73232;"><b>ERROR:</b> couldn\'t join channel</span>')}return false}s.set("curChan",e);if(t.banned){v.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>');return false}if(t.admin){$("#adminLink").css("display","")}else{$("#adminLink").css("display","none")}if(t.ignores!==undefined){C.setIgnoreList(t.ignores)}d.setUsers(t.users);d.draw();$.each(t.lines,function(e,t){C.addLine(t,true)});g.down();a.loaded=true;return true},part:function(){t.part(a.i)},reloadUserlist:function(e){if(!n){return}i.getJSON("Load.php?userlist&channel="+a.handlerB64,function(e){if(!e.banned){d.setUsers(e.users);d.draw()}else{v.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>')}})},reload:function(){t.join(a.i)},setI:function(e){a.i=e},is:function(e){return e==a.i}};return{name:a.name,handler:a.handler,handlerB64:a.handlerB64,load:a.load,part:a.part,reloadUserlist:a.reloadUserlist,reload:a.reload,loaded:function(){return a.loaded},setI:a.setI,is:a.is}},a={chans:[],current:false,save:function(){n.set("channels",a.chans)},load:function(){try{var e=n.get("channels"),t=$.map(a.chans,function(e){if(e.ex&&s.get("extraChans")||!e.ex){return e}return undefined}),i=[];if(e!==null&&e!=[]){a.chans=$.merge($.map(e,function(e){if(e.id!=-1&&e.id.toString().substr(0,1)!="*"){var t=false;$.each(a.chans,function(n,s){if(s.id==e.id){i.push(e);t=true;e.chan=s.chan;return false}});if(!t){return undefined}}return e}),$.map(t,function(e){var t=false;$.each(i,function(n,i){if(i.id==e.id){t=true;e.chan=i.chan;return false}});if(t){return undefined}return e}));save()}}catch(r){}},draw:function(){var e=0,t=0,n=false,i=0,r=false,o=0,l=function(t){o=$(t).width();r=false;$(t).css({position:"absolute","z-index":100,left:e-i}).after($("<div>").attr("id","topicDragPlaceHolder").css({display:"inline-block",width:o})).addClass("dragging").find("div").css("display","block").focus();n=false},u=function(e,s){e.preventDefault();t=e.clientX;i=t-$(s).position().left;n=true},f=function(s,a){e=s.clientX;if(n&&Math.abs(e-t)>=4){n=false;l(a);s.preventDefault()}else if($(a).hasClass("dragging")){var r=e-i;$(a).css("left",r);$ne=$("#topicDragPlaceHolder").next(".chanList");$pe=$("#topicDragPlaceHolder").prev(".chanList");if($ne.length>0&&$ne.position().left<r+o/2){$ne.after($("#topicDragPlaceHolder").remove())}else if($pe.length>0){if($pe.attr("id")==$(a).attr("id")){$pe=$pe.prev()}if($pe.length>0&&$pe.position().left>r){$pe.before($("#topicDragPlaceHolder").remove())}}}},d=function(e,t){if(n){n=false}else{$(t).find("div").css("display","none");$("#topicDragPlaceHolder").replaceWith(t);a.chans=$.map($(".chanList"),function(e,t){if($(e).find("span").hasClass("curchan")){s.set("curChan",t);a.current.setI(t)}return $(e).data("json")});a.save();a.draw()}};$("#ChanList").empty().append($.map(a.chans,function(e,t){if(e.ex&&s.get("extraChans")||!e.ex){return $("<div>").data("json",e).attr("id","chan"+t.toString()).addClass("chanList"+(e.high?" highlightChan":"")).append($("<span>").addClass("chan "+(a.current.is(t)?" curchan":"")).append(e.chan.substr(0,1)!="#"?$("<span>").addClass("closeButton").css({width:9,"float":"left"}).mouseup(function(e){if(r){c.part(t)}}).text("x"):"",$("<span>").text(e.chan)).mouseup(function(){if(r){c.join(t)}}),$("<div>").css({position:"fixed",width:"100%",height:"100%","z-index":101,top:0,left:0,display:"none"}).mousemove(function(e){f(e,$(this).parent())}).mouseup(function(e){d(e,$(this).parent())}).mouseout(function(e){d(e,$(this).parent())})).mousedown(function(e){r=true;u(e,this)}).mousemove(function(e){f(e,this)}).mouseout(function(e){if(n){l(this)}}).mouseup(function(e){d(e,this)})}}))},init:function(){a.current=e(-1,a);a.load();a.draw()},getHandler:function(e,t){if(a.chans[e].id!=-1){if(typeof a.chans[e].id!="number"&&t){return base64.encode(a.chans[e].id)}return a.chans[e].id.toString()}if(t){return base64.encode(a.chans[e].chan)}return a.chans[e].chan},requestHandler:false,join:function(n,s){if(a.chans[n]===undefined){return false}r.start();l.stop();$("#message").attr("disabled","true");$("#MessageBox").empty();$(".chan").removeClass("curchan");if(a.requestHandler!==false){a.requestHandler.abort()}l.partChan(a.current.handler);a.requestHandler=i.getJSON("Load.php?count=125&channel="+a.getHandler(n,true),function(i){a.current=e(n,a);if(a.current.load(i,s)){l.setChan(a.current.handler);l.start();a.chans[n].high=false;a.save();f.load();k.read();if(t.loggedIn()){$("#message").removeAttr("disabled")}}a.requestHandler=false;$("#chan"+n.toString()).removeClass("highlightChan").find(".chan").addClass("curchan");if(s!==undefined){s()}r.stop()});return true},highlight:function(e,t){$.each(a.chans,function(t,n){if(e==n.id||n.chan.toLowerCase()==e.toString().toLowerCase()){$("#chan"+t.toString()).addClass("highlightChan");a.chans[t].high=true}});if(t!==undefined&&t){a.save()}},addChan:function(e,t,n){var i=true;if(n===undefined){n=-1}e=e.toLowerCase();$.each(a.chans,function(t,n){if(n.chan==e){i=t}});if(i===true){a.chans.push({chan:e,high:!t,ex:false,id:n,order:-1});a.save();a.draw();if(t){a.join(a.chans.length-1)}}else{a.chans[i].high|=!t;if(t){a.join(i)}}},open:function(e){var t=true;e=e.trim();if(e.substr(0,1)!="@"&&e.substr(0,1)!="#"){e="@"+e}a.addChan(e,true)},openPm:function(e,t,n){var s=true,r=function(t,i){if(n===undefined){n=false}t=t.trim();if(t.substr(0,1)!="*"){t="*"+e}i=i.trim();if(i.substr(0,1)!="*"){i="*"+i}a.addChan(t,n,i)};if(t==""){i.getJSON("Load.php?openpm="+base64.encode(e),function(e){if(e.chanid){r(e.channick,e.chanid)}else{v.internal('<span style="color:#C73232;">Query Error: User not found.</span>')}})}else{r(e,t)}},part:function(e){var t=false;if(parseInt(e,10)==e){e=parseInt(e,10)}if(typeof e!="number"){$.each(a.chans,function(t,n){if(n.chan==e){e=t}})}if(typeof e!="number"||a.chans[e]===undefined){v.internal('<span style="color:#C73232;"> Part Error: I cannot part '+e+". (You are not in it.)</span>");return}if(a.chans[e].chan.substr(0,1)=="#"){v.internal('<span style="color:#C73232;"> Part Error: I cannot part '+a.chans[e].chan+". (IRC channel.)</span>");return}if(a.current.is(e)){t=true}a.chans.splice(e,1);a.save();a.draw();if(t){a.join(e-1)}},getNames:function(){return $.map(a.chans,function(e){return e.chan})},setChans:function(e){a.chans=e}};return{highlight:a.highlight,join:a.join,current:function(){return a.current},open:a.open,openPm:a.openPm,part:a.part,getNames:a.getNames,init:a.init,setChans:a.setChans}}(),f=function(){var e={tabWord:"",tabCount:0,isInTab:false,startPos:0,startChar:"",endPos:0,endChar:"",endPos0:0,tabAppendStr:"",searchArray:[],node:false,getCurrentWord:function(){var t=!h.support()?$("#message")[0].value:(e.node=window.getSelection().anchorNode).nodeValue;if(e.isInTab){return e.tabWord}e.startPos=!h.support()?$("#message")[0].selectionStart:window.getSelection().anchorOffset;e.startChar=t.charAt(e.startPos);while(e.startChar!=" "&&--e.startPos>0){e.startChar=t.charAt(e.startPos)}if(e.startChar==" "){e.startPos++}e.endPos=!h.support()?$("#message")[0].selectionStart:window.getSelection().anchorOffset;e.endChar=t.charAt(e.endPos);while(e.endChar!=" "&&++e.endPos<=t.length){e.endChar=t.charAt(e.endPos)}e.endPos0=e.endPos;e.tabWord=t.substr(e.startPos,e.endPos-e.startPos).trim();return e.tabWord},getTabComplete:function(){var t=!h.support()?$("#message")[0].value:e.node.nodeValue,n;if(t===null){return}n=e.search(e.getCurrentWord(),e.tabCount);if(!e.isInTab){e.tabAppendStr=" ";if(e.startPos===0){e.tabAppendStr=": "}}if(n==e.getCurrentWord()){e.tabCount=0;n=e.search(e.getCurrentWord(),e.tabCount)}t=t.substr(0,e.startPos)+n+e.tabAppendStr+t.substr(e.endPos+1);if(!h.support()){$("#message")[0].value=t}else{window.getSelection().anchorNode.nodeValue=t;window.getSelection().getRangeAt(0).setEnd(e.node,e.startPos+n.length+e.tabAppendStr.length);window.getSelection().getRangeAt(0).setStart(e.node,e.startPos+n.length+e.tabAppendStr.length)}e.endPos=e.endPos0+n.length+e.tabAppendStr.length},search:function(t,n){var i=false;if(!n){n=0}$.each(e.searchArray,function(e,s){if(s.toLowerCase().indexOf(t.toLowerCase())===0&&n--<=0&&i===false){i=s}});if(i!==false){return i}return t},init:function(){$("#message").keydown(function(t){if(t.keyCode==9){if(!t.ctrlKey){t.preventDefault();e.getTabComplete();e.isInTab=true;e.tabCount++;setTimeout(1,1)}}else{e.tabWord="";e.tabCount=0;e.isInTab=false}})},load:function(){e.searchArray=$.merge(d.getNames(),c.getNames())}};return{init:e.init,load:e.load}}(),d=function(){var e={users:[],exists:function(t){var n=false;$.each(e.users,function(e,t){if(t.nick.toLowerCase()==u.nick.toLowerCase()&&t.network==u.network){n=true;return false}});return n},add:function(t){if(c.current().handler!==""){e.users.push(t);e.draw()}},remove:function(t){if(c.current().handler!==""){$.each(e.users,function(n,i){if(i.nick==t.nick&&i.network==t.network){e.users.splice(n,1);return false}});e.draw()}},draw:function(){e.users.sort(function(e,t){var n=e.nick.toLowerCase(),i=t.nick.toLowerCase();return n==i?e==t?0:e<t?-1:1:n<i?-1:1});$("#UserList").empty().append($.map(e.users,function(e){var n,s=encodeURIComponent(e.nick),a=$("<span>").text(e.nick).html();return $("<span>").attr("title",t.getNetwork(e.network).name).append(t.getNetwork(e.network).userlist.split("NICKENCODE").join(s).split("NICK").join(a),"<br>").mouseover(function(){n=i.getJSON("Load.php?userinfo&name="+base64.encode(e.nick)+"&chan="+c.current().handlerB64+"&online="+e.network.toString(),function(e){if(e.last){$("#lastSeenCont").text("Last Seen: "+new Date(e.last*1e3).toLocaleString())}else{$("#lastSeenCont").text("Last Seen: never")}$("#lastSeenCont").css("display","block")})}).mouseout(function(){try{n.abort()}catch(e){}$("#lastSeenCont").css("display","none")})}),"<br><br>")},setUsers:function(t){e.users=t},getNames:function(){return $.map(e.users,function(e){return e.nick})}};return{add:e.add,remove:e.remove,draw:e.draw,setUsers:e.setUsers,getNames:e.getNames}}(),p=function(){var e={set:function(e){$("#topic").empty().append(e)}};return{set:e.set}}(),g=function(){var e={isDown:false,is_touch:"ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0,headerOffset:0,$mBox:false,$mBoxCont:false,touchScroll:function(t,n){var i=-1;t.bind("touchstart",function(t){if($(t.target).is("a")){return}e.$mBox.css("transition","none");t.preventDefault();i=t.originalEvent.touches[0].clientY}).bind("touchmove",function(e){if($(e.target).is("a")){return}e.preventDefault();if(i==-1){return}var t=e.originalEvent.changedTouches[0].clientY;n(t-i);i=t}).bind("touchend touchcancel touchleave",function(t){if($(t.target).is("a")){return}e.$mBox.css("transition","");t.preventDefault();i=-1})},enableButtons:function(){var t=function(t,n,i){var s;$(t).mousedown(function(){s=setInterval(function(){document.getElementById(n).scrollLeft+=i},50)}).mouseup(function(){try{clearInterval(s)}catch(e){}}).mouseout(function(){try{clearInterval(s)}catch(e){}});if(e.is_touch){$(t).bind("touchstart",function(){s=setInterval(function(){document.getElementById(n).scrollLeft+=i},50)}).bind("touchend touchcancel touchleave",function(e){try{clearInterval(s)}catch(e){}})}};t("#arrowLeftChan","ChanListCont",-9);t("#arrowRightChan","ChanListCont",9);t("#arrowLeftTopic","topicCont",-9);t("#arrowRightTopic","topicCont",9)},moveWindow:function(t){var n=-parseInt(e.$mBox[0].style.top,10),i=e.$mBox.height()-e.$mBoxCont.height(),a=Math.min(i,Math.max(0,n-t));e.isDown=false;e.$mBox.css("top",-a);if(a==i){e.isDown=true}if(s.get("scrollBar")){e.reCalcBar()}},enableWheel:function(){e.$mBoxCont.bind("DOMMouseScroll mousewheel",function(t){var n=e.$mBox[0].style.top;e.moveWindow(/Firefox/i.test(navigator.userAgent)?t.originalEvent.detail*-20:t.originalEvent.wheelDelta/2);t.preventDefault();t.stopPropagation();t.cancelBubble=true});if(e.is_touch){e.touchScroll(e.$mBoxCont,function(t){e.moveWindow(t)})}},reCalcBar:function(){if($("#scrollBar").length!==0){if(e.$mBox.height()<=e.$mBoxCont.height()){$("#scrollBar").css("top",e.headerOffset)}else{$("#scrollBar").css("top",parseInt(e.$mBox[0].style.top,10)/(e.$mBoxCont.height()-e.$mBox.height())*($("body")[0].offsetHeight-$("#scrollBar")[0].offsetHeight-e.headerOffset)+e.headerOffset)}}},enableUserlist:function(){var t=function(t,n){$(e).css("top",Math.min(0,Math.max((/Opera/i.test(navigator.userAgent)?-30:0)+document.getElementById("UserListInnerCont").clientHeight-n.scrollHeight,t+parseInt($("#UserList").css("top"),10))))};$("#UserList").css("top",0).bind("DOMMouseScroll mousewheel",function(e){if(e.preventDefault){e.preventDefault()}e=e.originalEvent;t(/Firefox/i.test(navigator.userAgent)?e.detail*-20:e.wheelDelta/2,this)});if(e.is_touch){e.touchScroll($("#UserList"),function(t){e.moveUserList(t,this)})}},showBar:function(){var t=false,n=false,i=function(i){var s=0;if(r.data("isClicked")){if(!(t!==false&&i<=t)&&!(n!==false&&i>=n)){s=parseInt(r.css("top"),10)+(i-r.data("prevY"));e.$mBox.css("top",-((s-e.headerOffset)/($("body")[0].offsetHeight-r[0].offsetHeight-e.headerOffset))*(e.$mBox.height()-e.$mBoxCont.height()));e.isDown=false;if(s<e.headerOffset){if(t===false){t=i}s=e.headerOffset;e.$mBox.css("top",0)}else{t=false}if(s>$("body")[0].offsetHeight-r[0].offsetHeight){if(n===false){n=i}s=$("body")[0].offsetHeight-r[0].offsetHeight;e.$mBox.css("top",e.$mBoxCont.height()-e.$mBox.height());e.isDown=true}else{n=false}r.css("top",s)}}r.data("prevY",i)},s=function(){r.data("isClicked",true);$("#scrollArea").css("display","block");e.$mBox.css("transition","none");l=false;t=false;n=false},a=function(){r.data("isClicked",false);$("#scrollArea").css("display","none");e.$mBox.css("transition","")},r=$("<div>").attr("id","scrollBar").data({prevY:0,isClicked:false}).appendTo("body").mousemove(function(e){i(e.clientY)}).mousedown(function(e){s()}).mouseup(function(){a()}),o,l=false;r.css("top",$("body")[0].offsetHeight-r[0].offsetHeight);o=$("<div>").attr("id","scrollArea").css({display:"none",width:"100%",height:"100%",position:"absolute",cursor:"move",left:0,top:0,zIndex:100}).mousemove(function(e){i(e.clientY)}).mouseup(function(){a()}).mouseenter(function(e){if(e.originalEvent.buttons==0&&l){a()}l=true});if(e.is_touch){o.bind("touchend touchcancel touchleave",function(e){a()}).bind("touchmove",function(e){e.preventDefault();i(e.originalEvent.changedTouches[0].clientY)});r.bind("touchstart",function(e){e.preventDefault();s()}).bind("touchmove",function(e){e.preventDefault();i(e.originalEvent.changedTouches[0].clientY);
}).bind("touchend touchcancel touchleave",function(e){e.preventDefault();a(e)})}o.appendTo("body");$("<div>").attr("id","scrollBarLine").appendTo("body");$(window).trigger("resize")},showButtons:function(){var t,n,i=function(){t=setInterval(function(){e.moveWindow(9)},50)},s=function(){n=setInterval(function(){e.moveWindow(-9)},50)},a;a=$("<span>").addClass("arrowButtonHoriz3").append($("<div>").css({fontSize:"12pt",width:12,height:"12pt",top:0,position:"absolute",fontWeight:"bolder",marginTop:"10pt",marginLeft:"-10pt"}).addClass("arrowButtonHoriz2").html("&#9650;"),$("<div>").css({fontSize:"12pt",width:12,height:"9pt",top:0,position:"absolute",marginTop:"10pt",marginLeft:"-10pt"}).mousedown(function(){e.$mBox.css("transition","none");i()}).mouseout(function(){e.$mBox.css("transition","");try{clearInterval(t)}catch(n){}}).mouseup(function(){e.$mBox.css("transition","");try{clearInterval(t)}catch(n){}}));if(e.is_touch){a.bind("touchstart",function(){i()}).bind("touchend touchcancel touchleave",function(e){try{clearInterval(t)}catch(e){}})}a.appendTo("body");a=$("<span>").addClass("arrowButtonHoriz3").append($("<div>").css({fontSize:"12pt",width:12,height:"12pt",bottom:"6pt",position:"absolute",fontWeight:"bolder",marginTop:"-10pt",marginLeft:"-10pt"}).addClass("arrowButtonHoriz2").html("&#9660;"),$("<div>").css({fontSize:"12pt",width:12,height:"9pt",bottom:"9pt",position:"absolute",marginTop:"-10pt",marginLeft:"-10pt"}).mousedown(function(){e.$mBox.css("transition","none");s()}).mouseout(function(){e.$mBox.css("transition","");try{clearInterval(n)}catch(t){}}).mouseup(function(){e.$mBox.css("transition","");try{clearInterval(n)}catch(t){}}));if(e.is_touch){a.bind("touchstart",function(){s()}).bind("touchend touchcancel touchleave",function(e){try{clearInterval(n)}catch(e){}})}a.appendTo("body")},down:function(){e.$mBox.css("top",e.$mBoxCont.height()-e.$mBox.height());e.reCalcBar();e.isDown=true},up:function(){e.$mBox.css("top",0);e.reCalcBar();e.isDown=false},slide:function(){if(e.isDown){e.down()}},init:function(){e.$mBox=$("#MessageBox");e.$mBoxCont=$("#mBoxCont");e.enableButtons();e.headerOffset=$("#header").height()-2;if(s.get("scrollBar")){e.showBar()}else{e.showButtons()}if(s.get("scrollWheel")){e.enableWheel()}e.enableUserlist();$(document).add(window).add("body").add("html").scroll(function(e){e.preventDefault()})}};return{down:e.down,up:e.up,slide:e.slide,init:e.init,reCalcBar:e.reCalcBar}}(),h=function(){var e={sel:false,menuOpen:false,hideMenu:function(){$("#textDecoForm").css("display","none");e.menuOpen=false},init:function(){$("#message").mouseup(function(t){e.sel=window.getSelection();if(e.sel.isCollapsed){return}t.preventDefault();$("#textDecoForm").css({display:"block",left:Math.max(t.pageX-52,0)});e.menuOpen=true});$(document).mousedown(function(t){if(!$(t.target).closest("#textDecoForm").length&&e.menuOpen){e.hideMenu()}});$("#textDecoFormBold").click(function(){e.sel.getRangeAt(0).surroundContents($("<b>")[0])});$("#textDecoFormItalic").click(function(){e.sel.getRangeAt(0).surroundContents($("<i>")[0])});$("#textDecoFormUnderline").click(function(){e.sel.getRangeAt(0).surroundContents($("<u>")[0])})},getMsg:function(){var e=$("#message").html();e=e.split("<b>").join("").split("</b>").join("");e=e.split("<i>").join("").split("</i>").join("");e=e.split("<u>").join("").split("</u>").join("");e=e.split("&nbsp;").join(" ");e=$("<span>").html(e).text();return e},support:function(){return"contentEditable"in document.documentElement&&s.get("wysiwyg")}};return{init:e.init,getMsg:e.getMsg,support:e.support}}(),m=function(){var e={initSmileys:function(){if(s.get("smileys")){$("#smileyMenuButton").css("cursor","pointer").click(function(){if($("#smileyselect").css("display")=="block"){$("#smileyselect").css("display","none");$(this).attr("src","smileys/smiley.gif")}else{$("#smileyselect").css("display","block");$(this).attr("src","smileys/tongue.gif")}})}else{$("#smileyMenuButton").attr("src","smileys/smiley_grey.png")}},setSmileys:function(e){$("#smileyselect").empty().append($.map(e,function(e){return[e.inMenu?$("<img>").attr({src:e.pic,alt:e.alt,title:e.title}).click(function(){if(!h.support()){replaceText(" "+e.code,$("#message")[0])}else{var t=window.getSelection().getRangeAt(0);t.deleteContents();t.insertNode(document.createTextNode(" "+e.code))}}):""," "]}))},mBoxContWidthOffset:90,hide_userlist:false,show_scrollbar:true,registerToggle:function(){$("#toggleButton").click(function(e){e.preventDefault();s.set("enable",!s.get("enable"));document.location.reload()})},isBlurred:true,calcResize:function(t){var n=window.innerHeight,i=window.innerWidth,s=$("#header").outerHeight(),a=$("#footer").outerHeight(),r=Number(getComputedStyle(document.body,"").fontSize.match(/(\d*(\.\d*)?)px/)[1]);if(t){$("#scrollBarLine").css("top",parseInt($("#header").outerHeight(),10));$("#mBoxCont").css("height",n-a-s-.2*r);$("html,body").height(n);$("#message").css("width",i*(e.hide_userlist?1:.91)-12*r)}if(e.show_scrollbar){var o=i/100*e.mBoxContWidthOffset;if(t){$("#mBoxCont").css("width",o-1.9*r)}$("#scrollBarLine").css("left",o-1.4*r);if(t){$("#scrollBarLine").css("height",n-s-.1*r)}$("#scrollBar").css("left",o-1.5*r);g.reCalcBar()}g.down()},init:function(){var t=navigator.userAgent,n=t.indexOf("Mozilla/5.0")>-1&&t.indexOf("Android ")>-1&&t.indexOf("AppleWebKit")>-1&&!(t.indexOf("Chrome")>-1),i=t.match(/(iPod|iPhone|iPad)/i)&&t.match(/AppleWebKit/i),r=t.match(/AppleWebKit/i)&&t.match(/Android/i);$("body").css("font-size",s.get("fontSize").toString(10)+"pt");e.hide_userlist=s.get("hideUserlist");e.show_scrollbar=s.get("scrollBar");m.changeLinks();if(!h.support()){$("#message").replaceWith($("<input>").attr({type:"text",id:"message",accesskey:"i",maxlen:"256",autocomplete:"off"}))}else{$("#message").keydown(function(e){if(e.keyCode==13){e.preventDefault();$("#sendMessage").trigger("submit")}});h.init()}if(e.hide_userlist){e.mBoxContWidthOffset=99;$("<style>").append("#mBoxCont{width:99%;}",".arrowButtonHoriz2,.arrowButtonHoriz3 > div:nth-child(2){left:98%;left:calc(99% - 5px);left:-webkit-calc(99% - 5px);}","#UserListContainer{left:99%;transition: left 0.5s 1s;-webkit-transition: left 0.5s 1s;-o-transition-property: left;-o-transition-duration: 0.5d;-o-transition-delay: ls;}","#icons{right:95px;}").appendTo("head")}g.init();f.init();a.init();y.init();o.init();e.registerToggle();if(i){e.calcResize(true)}$(window).resize(function(){e.calcResize(!i)}).trigger("resize").blur(function(){e.isBlurred=true}).focus(function(){e.isBlurred=false;o.stopFlash()});$("#aboutButton").click(function(e){e.preventDefault();$("#about").toggle()})},load:function(){r.start();t.fetch(function(){if(s.get("enable")){e.init();e.initSmileys();v.init();k.init();c.init();l.init();if(!c.join(s.get("curChan"))){c.join(0)}}else{e.registerToggle();$("#mBoxCont").empty().append("<br>",$("<a>").css("font-size","20pt").text("OmnomIRC is disabled. Click here to enable.").click(function(e){e.preventDefault();s.set("enable",true);window.location.reload()}));$("#footer,#header").css("display","none");r.stop()}})},changeLinks:function(){$('#adminLink a,a[href="."],a[href="?options"],a[href="index.php"]').each(function(){if($(this).attr("href").split("?")[1]!==undefined){$(this).attr("href",$(this).attr("href")+"&network="+t.net())}else{$(this).attr("href",$(this).attr("href")+"?network="+t.net())}})}};return{load:e.load,isBlurred:function(){return e.isBlurred},changeLinks:e.changeLinks,setSmileys:e.setSmileys}}(),w=function(){var e={text:"",started:false,start:function(){if(!s.get("statusBar")){e.started=true;return}if(!e.started){setInterval(function(){window.status=e.text;if(parent){try{parent.window.status=e.text}catch(t){}}},500);e.started=true}},set:function(t){e.text=t;if(!e.started){e.start()}}};return{set:e.set}}(),b=function(){var t={parse:function(t){var n=t.split(" ")[0].toLowerCase(),i=t.substr(n.length+1).toLowerCase().trim();switch(n){case"j":case"join":c.open(i);return true;case"q":case"query":c.openPm(i,"",true);return true;case"win":case"w":case"window":c.join(parseInt(i,10));return true;case"p":case"part":c.part(i!==""?i:undefined);return true;case"help":v.internal('<span style="color:#2A8C2A;">Commands: me, ignore, unignore, ignorelist, join, part, query, msg, window</span>');v.internal('<span style="color:#2A8C2A;">For full help go here: <a href="http://ourl.ca/19926" target="_top">http://ourl.ca/19926</a></span>');return true;case"ponies":$.getScript("https://juju2143.ca/mousefly.js",function(){Derpy()});return true;case"minty":$.getJSON(e+"/minty.php").done(function(e){v.internal('<span style="font-size:5px;line-height:0;font-family:monospace;">'+e.minty+"</span>")});return true;default:return false}}};return{parse:t.parse}}(),k=function(){var e={messages:[],counter:0,current:"",setMsg:function(e){if(!h.support()){$("#message").val(e)}else{$("#message").html(e)}},getMsg:function(){if(!h.support()){return $("#message").val()}return $("#message").html()},init:function(){$("#message").keydown(function(t){if(t.keyCode==38||t.keyCode==40){t.preventDefault();if(e.counter==e.messages.length){e.current=e.getMsg()}if(e.messages.length!==0){if(t.keyCode==38){if(e.counter!==0){e.counter--}e.setMsg(e.messages[e.counter])}else{if(e.counter!=e.messages.length){e.counter++}if(e.counter==e.messages.length){e.setMsg(e.current)}else{e.setMsg(e.messages[e.counter])}}}}})},add:function(t){e.messages.push(t);if(e.messages.length>20){e.messages.shift()}e.counter=e.messages.length;n.set("oldMessages-"+c.current().handlerB64,e.messages)},read:function(){e.messages=n.get("oldMessages-"+c.current().handlerB64);if(!e.messages){e.messages=[]}console.log(e.messages);e.counter=e.messages.length}};return{init:e.init,add:e.add,read:e.read}}(),v=function(){var e={sending:false,sendMessage:function(t){if(t[0]=="/"&&b.parse(t.substr(1))){if(!h.support()){$("#message").val("")}else{$("#message").html("")}}else{if(!e.sending){e.sending=true;l.send(t,function(){if(!h.support()){$("#message").val("")}else{$("#message").html("")}e.sending=false})}}},internal:function(e){C.addLine({curLine:0,type:"internal",time:Math.floor((new Date).getTime()/1e3),name:"",message:e,name2:"",chan:c.current().handler})},init:function(){$("#sendMessage").submit(function(n){n.preventDefault();if(t.loggedIn()){var i="";if(!h.support()){i=$("#message").val();k.add(i)}else{k.add($("#message").html());i=h.getMsg()}console.log(i);i=C.parseTextDecorations(i);if(!$("#message").attr("disabled")&&i!==""){e.sendMessage(i);$("#message").focus()}}});if(!t.loggedIn()){$("#message").val("You need to login if you want to chat!")}}};return{internal:e.internal,init:e.init}}(),y=function(){var e={isOpen:false,year:0,month:0,day:0,months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],getLogUrlParam:function(){return base64.encode(e.year.toString(10)+"-"+e.month.toString(10)+"-"+e.day.toString(10))},updateInputVal:function(){$("#logDate").val(e.months[e.month-1]+" "+e.day.toString(10)+" "+e.year.toString(10))},displayDatePicker:function(){var t=new Date(e.year,e.month,e.day),n=["Sun","Mon","Tue","Wen","Thu","Fri","Sat"],i=new Date(e.year,e.month,0).getDate(),s=new Date(e.year,e.month-1,1).getDay(),a=0;if(e.day>i){e.day=i}e.updateInputVal();$("#logDatePicker").empty().append($("<a>").text("<").click(function(t){t.preventDefault();t.stopPropagation();e.year--;e.displayDatePicker()})," ",e.year.toString(10)," ",$("<a>").text(">").click(function(t){t.preventDefault();t.stopPropagation();e.year++;e.displayDatePicker()}),"<br>",$("<a>").text("<").click(function(t){t.preventDefault();t.stopPropagation();e.month--;if(e.month<1){e.month=12;e.year--}e.displayDatePicker()})," ",e.months[e.month-1]," ",$("<a>").text(">").click(function(t){t.preventDefault();t.stopPropagation();e.month++;if(e.month>12){e.month=1;e.year++}e.displayDatePicker()}),"<br>",$("<table>").append($("<tr>").append($.map(n,function(e){return $("<th>").text(e)})),$.map([0,1,2,3,4,5],function(){if(a>=i){return}return $("<tr>").append($.map([0,1,2,3,4,5,6],function(t){if(a==0&&t!=s||a>=i){return $("<td>").text(" ")}a++;return $("<td>").text(a).addClass("logDatePickerDay").addClass(a==e.day?"current":"").data("day",a).click(function(){$(".logDatePickerDay.current").removeClass("current");e.day=$(this).addClass("current").data("day");e.updateInputVal()})}))})));$("#logDatePicker").css("display","block")},open:function(){var t=new Date;r.start();l.stop();$("#message").attr("disabled","true");d.setUsers([]);d.draw();$("#chattingHeader").css("display","none");$("#logDatePicker").css("display","none");$("#logsHeader").css("display","block");$("#logChanIndicator").text(c.current().name);e.year=parseInt(t.getFullYear(),10);e.month=parseInt(t.getMonth()+1,10);e.day=parseInt(t.getDate(),10);e.updateInputVal();e.isOpen=true;e.fetch()},close:function(){var t;$("#chattingHeader").css("display","block");$("#logsHeader").css("display","none");e.isOpen=false;c.current().reload()},fetchPart:function(t){i.getJSON("Log.php?day="+e.getLogUrlParam()+"&offset="+parseInt(t,10)+"&channel="+c.current().handlerB64,function(n){if(!n.banned){if(n.lines.length>=1e3){e.fetchPart(t+1e3)}$.each(n.lines,function(e,t){C.addLine(t,true)});g.up();if(n.lines.length<1e3){r.stop()}}else{v.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</banned>')}})},fetch:function(){r.start();$("#MessageBox").empty();e.fetchPart(0)},toggle:function(){if(e.isOpen){e.close()}else{e.open()}},init:function(){$("#logCloseButton").click(function(t){t.preventDefault();e.close()});$("#logGoButton").click(function(t){t.preventDefault();e.fetch()});$("#logsButton").click(function(t){t.preventDefault();e.toggle()});$("#logDate").click(function(t){t.preventDefault();$(this).focusout();if($("#logDatePicker").css("display")!="block"){e.displayDatePicker();t.stopPropagation()}});$(document).click(function(t){if(e.isOpen){var n=$("#logDatePicker");if(!n.is(t.target)&&n.has(t.target).length===0){n.css("display","none")}}})}};return{init:e.init}}(),C=function(){var e={smileys:[],maxLines:200,lastMessage:0,ignores:[],cacheServerNicks:{},lineHigh:false,parseName:function(n,a,r){if(r===undefined){r=-1}n=n=="\x00"?"":n;var o=encodeURIComponent(n);n=$("<span>").text(n).html();var l=[19,20,22,24,25,26,27,28,29],c=0,u=0,f=n,d=t.getNetwork(a),p=true;switch(s.get("colordNames")){case"1":while(n[u]){c+=n.charCodeAt(u++)}f=$("<span>").append($("<span>").addClass("uName-"+l[c%9].toString()).html(n)).html();break;case"2":if(d!==undefined&&d.checkLogin!==undefined){p=false;if(e.cacheServerNicks[a.toString()+":"+r.toString()]===undefined){i.getJSON(d.checkLogin+"?c="+r.toString(10)+"&n="+o,function(t){e.cacheServerNicks[a.toString()+":"+r.toString()]=t.nick},false,false)}f=e.cacheServerNicks[a.toString()+":"+r.toString()]}else{f=n}break;default:f=n;break}if(d!==undefined&&p){f=d.normal.split("NICKENCODE").join(o).split("NICK").join(f).split("USERID").join(r.toString(10))}if(d!==undefined){return'<span title="'+d.name+'">'+f+"</span>"}return'<span title="Unknown Network">'+f+"</span>"},parseSmileys:function(t){if(!t){return""}if(/^[\w\s\d\.,!?]*$/.test(t)){return t}$.each(e.smileys,function(e,n){t=t.replace(RegExp(n.regex,"g"),n.replace)});return t},parseLinks:function(e){if(!e||e===null||e===undefined){return""}var t=["ourl.ca","omnimaga.org","www.omnimaga.org"];var n='[^\\s"]';e=e.replace(RegExp("(|)","g"),"");$.map(t,function(t){t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");e=e.replace(RegExp("(^|\\s)(((f|ht)(tp|tps)://)"+t+n+"*)","g"),"$1$2").replace(RegExp("(^|\\s)("+t+n+"*)","g"),"$1$2")});return e.replace(RegExp("(^|[^a-zA-Z0-9_]|\\d{1,2}(|,\\d{1,2}))(((f|ht)(tp|tps)://)"+n+"+)","g"),'$1<a target="_blank" href="$3">$3</a>').replace(RegExp("(^|[^a-zA-Z0-9_/])(www\\."+n+"+)","g"),'$1<a target="_blank" href="http://$2">$2</a>').replace(RegExp("(^|.)("+n+"+)","g"),'$1<a target="_top" href="$2">$2</a>').replace(RegExp("(^|.)("+n+"+)","g"),'$1<a target="_top" href="http://$2">$2</a>')},parseColors:function(e){var t=[],n,i={fg:"-1",bg:"-1",underline:false,bold:false,italic:false},s,a;if(!e){return""}t=e.split(RegExp("([])"));e="<span>";for(s=0;s<t.length;s++){a=true;switch(t[s]){case"":n=t[s+1].replace(/^([0-9]{1,2}),([0-9]{1,2})(.*)/,"$1:$2");if(n==t[s+1]){n=t[s+1].replace(/^([0-9]{1,2}).*/,"$1:");if(n!=t[s+1]){i.fg=n.split(":")[0];t[s+1]=t[s+1].substr(n.length-1)}else{i.fg="-1";i.bg="-1"}}else{i.fg=n.split(":")[0];i.bg=n.split(":")[1];if(n==t[s+1]){t[s+1]=""}else{t[s+1]=t[s+1].substr(n.length)}}break;case"":i.bold=!i.bold;break;case"":i.italic=!i.italic;break;case"":n=i.fg;i.fg=i.bg;i.bg=n;if(i.fg=="-1"){i.fg="0"}if(i.bg=="-1"){i.bg="1"}break;case"":i.underline=!i.underline;break;case"":i={fg:"-1",bg:"-1",underline:false,bold:false,italic:false};break;default:a=false}if(a){e+="</span>"+'<span class="fg-'+i.fg+" bg-"+i.bg+'" style="'+(i.bold?"font-weight:bold;":"")+(i.underline?"text-decoration:underline;":"")+(i.italic?"font-style:italic;":"")+'">'}else{e+=t[s]}}e+="</span>";e=e.replace(/(\x03|\x02|\x1F|\x09|\x0F)/g,"");return e},parseHighlight:function(e){var t="";if(!s.get("highRed")){t+="background:none;padding:none;border:none;"}if(s.get("highBold")){t+="font-weight:bold;"}return'<span class="highlight" style="'+t+'">'+e+"</span>"},parseMessage:function(t,n){if(n==undefined||!n){n=false}t=t=="\x00"?"":t;t=$("<span>").text(t).html();t=e.parseLinks(t);if(s.get("smileys")&&n===false){t=e.parseSmileys(t)}t=e.parseColors(t);return t},addLine:function(n,i){if(i===undefined){i=false}l.setCurLine(n.curLine);if(n.name==null||e.ignores.indexOf(n.name.toLowerCase())>-1||n.chan.toString().toLowerCase()!=c.current().handler.toLowerCase()&&n.name2!==t.getPmIdent()){return true}var a=$("#MessageBox"),r=e.parseName(n.name,n.network,n.uid),u=e.parseMessage(n.message),f="*",h=u,b="",k=new Date(n.time*1e3);if(n.network==-1){return true}if(t.nick()!=""&&["message","action","pm","pmaction"].indexOf(n.type)>=0&&n.name.toLowerCase()!="*"&&u.toLowerCase().indexOf(t.nick().toLowerCase().substr(0,s.get("charsHigh")))>=0){h=u=e.parseHighlight(u);if(!i&&m.isBlurred()){o.make("("+c.current().name+") <"+n.name+"> "+n.message,n.chan)}}switch(n.type){case"reload":if(!i){c.current().reload()}return true;case"reload_userlist":if(!i){c.current().reloadUserlist()}return true;case"relog":if(!i){t.fetch(undefined,true)}return true;case"refresh":if(!i){location.reload(true)}return true;break;case"join":h=[r," has joined "+c.current().name];if(!i){d.add({nick:n.name,network:n.network})}if(t.getNetwork(n.network).type==1&&!s.get("oircJoinPart")){return true}break;case"part":h=[r," has left "+c.current().name+" (",u,")"];if(!i){d.remove({nick:n.name,network:n.network})}if(t.getNetwork(n.network).type==1&&!s.get("oircJoinPart")){return true}break;case"quit":h=[r," has quit IRC (",u,")"];if(!i){d.remove({nick:n.name,network:n.network})}if(t.getNetwork(n.network).type==1&&!s.get("oircJoinPart")){return true}break;case"kick":h=[r," has kicked ",e.parseName(n.name2,n.network)," from "+c.current().name+" (",u,")"];if(!i){d.remove({nick:n.name2,network:n.network})}break;case"message":f=r;break;case"action":h=[r," ",u];break;case"mode":if(typeof u=="string"){u=n.message.split(" ");$.each(u,function(t,i){var s=$("<span>").html(i).text();if(s.indexOf("+")==-1&&s.indexOf("-")==-1){u[t]=e.parseName(i,n.network)}});u=u.join(" ")}h=[r," set "+c.current().name+" mode ",u];break;case"nick":h=[r," has changed nicks to ",e.parseName(n.name2,n.network)];if(!i){d.add({nick:n.name2,network:n.network});d.remove({nick:n.name,network:n.network})}break;case"topic":p.set(e.parseMessage(n.message,true));h=[r," has changed the topic to ",e.parseMessage(n.message,true)];break;case"pm":if(n.chan==c.current().handler){f=r;n.type="message"}else{if(!i){if(n.name.toLowerCase()==t.nick().toLowerCase()){c.openPm(n.chan,t.getWholePmIdent(n.uid,n.network));return true}else{f=["(PM)",r];c.openPm(n.name,t.getWholePmIdent(n.uid,n.network));o.make("(PM) <"+n.name+"> "+n.message,n.chan)}}else{return true}}break;case"pmaction":if(n.chan==c.current().handler){h=[r," ",u];n.type="action"}else{if(!i){if(n.name.toLowerCase()==t.nick().toLowerCase()){c.openPm(n.chan,t.getWholePmIdent(n.uid,n.network));return true}else{h=["(PM)",r," ",u];c.openPm(n.name,t.getWholePmIdent(n.uid,n.network));o.make("* (PM)"+n.name+" "+n.message,n.chan);n.type="pm"}}else{return true}}break;case"highlight":if(n.name.toLowerCase()!="*"){o.make("("+n.chan+") <"+n.name+"> "+n.message,n.chan)}return true;case"internal":h=n.message;break;case"server":break;default:return true}if(a.find("tr").length>e.maxLines&&logMode!==true){a.find("tr:first").remove()}if(f=="*"){b="* "}else{b="<"+n.name+"> "}if(s.get("times")){b="["+k.toLocaleTimeString()+"] "+b}b+=$("<span>").append(h).text();w.set(b);if(new Date(e.lastMessage).getDay()!=k.getDay()){a.append($("<tr>").addClass("dateSeperator").append($("<td>").addClass(s.get("altLines")&&(e.lineHigh=!e.lineHigh)?"lineHigh":"").attr("colspan",s.get("times")?3:2).text(k.toLocaleDateString())))}var v=$("<tr>").addClass(s.get("altLines")&&(e.lineHigh=!e.lineHigh)?"lineHigh":"").append(s.get("times")?$("<td>").addClass("irc-date").append("["+k.toLocaleTimeString()+"]"):"",$("<td>").addClass("name").append(f),$("<td>").addClass(n.type).append(h));v.find("img").load(function(e){g.slide()});a.append(v);g.slide();e.lastMessage=n.time*1e3;return true},setSmileys:function(t){var n="";e.smileys=[];$.each(t,function(t,i){e.smileys.push({regex:i.regex,replace:i.replace.split("ADDSTUFF").join(n).split("PIC").join(i.pic).split("ALT").join(i.alt)})})},setIgnoreList:function(t){e.ignores=t},parseTextDecorations:function(e){if(e!==""&&s.get("textDeco")){if(e[0]==">"){e="3"+e}e=e.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")}return e}};return{addLine:e.addLine,setSmileys:e.setSmileys,setIgnoreList:e.setIgnoreList,parseTextDecorations:e.parseTextDecorations}}();$(function(){i.init();switch($("body").attr("page")){case"options":t.fetch(function(){m.changeLinks();$("#options").height($(window).height()-75);$(window).resize(function(){if(!(navigator.userAgent.match(/(iPod|iPhone|iPad)/i)&&navigator.userAgent.match(/AppleWebKit/i))){$("#options").height($(window).height()-75)}});$("body").css("font-size",s.get("fontSize").toString(10)+"pt");$("#options").append(s.getHTML())});break;case"admin":$("head").append($("<script>").attr({type:"text/javascript",src:"admin.min.js"}));break;default:m.load()}});return{OMNOMIRCSERVER:e,page:{changeLinks:function(){m.changeLinks()}},settings:{fetch:function(e){t.fetch(e)}},indicator:{start:r.start,stop:r.stop},network:{getJSON:function(e,t,n,s){i.getJSON(e,t,n,s)},post:function(e,t,n,s,a){i.post(e,t,n,s,a)}},options:{getAll:function(){return s.getAll()}}}}();