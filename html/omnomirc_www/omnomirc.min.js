/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2016 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";function OmnomIRC(){var e,n="https://omnomirc.omnimaga.org",t="",o=!1,r=function(e){return void 0!==document.URL.split(e+"=")[1]?document.URL.split(e+"=")[1].split("&")[0].split("#")[0]:""},s=function(n,t){if(void 0===t&&(t=!1),!t||"highlight"!=n.type){if(!t&&"highlight"!=n.type&&n.chan==c.get("chan")){var o=c.get("lines");o.push(n),o.length>200&&o.shift(),c.set("lines",o),["part","quit","join","nick"].indexOf(n.type)!=-1&&c.set("users",p.getUsers())}if(null===n.name||n.network==-1||!t&&!h.isNew(n.curline))return void h.setCurline(n.curline);h.setCurline(n.curline),e.onmessageraw!==!1?e.onmessageraw(n,t):y.addLine(n,t)}},i=function(){var n={hostname:"",nick:"",signature:"",numHigh:4,uid:-1,net:"",networks:{},pmIdent:!1,guestLevel:0,isGuest:!0,identGuest:function(e,t,o,r){void 0===r&&(r=o,o=!1),console.log("trying login"),l.getJSON("misc.php?identName="+base64.encode(e)+"&nick="+base64.encode(e)+"&signature="+base64.encode(t)+"&id=-1&network="+n.net,function(t){t.success&&(o?(a.set("guestName",e),a.set("guestSig",t.signature)):(a.set("guestName",""),a.set("guestSig","")),n.setIdent(e,t.signature,-1),h.identify()),void 0!==r&&r(t)},!0,!1)},logout:function(){n.setIdent("","",-1),a.remove("guestName"),a.remove("guestSig"),c.remove("config"),c.remove("checkLogin"),h.identify()},login:function(e,t,o){void 0===o&&(o=-1),n.setIdent(e,t,o),h.identify()},fetch:function(t,o){var s=function(s){if(!o){try{sessionStorage.setItem("defaultNetwork",s.defaultNetwork)}catch(i){}c.set("config",s),n.hostname=s.hostname,f.setChans(s.channels),y.setSmileys(s.smileys),e.onsmileychange(s.smileys),y.setSpLinks(s.spLinks),n.guestLevel=s.guests,n.networks={},$.each(s.networks,function(e,t){n.networks[t.id]=t}),n.net=s.network,a.setPrefix(n.net),d.setDefaults(s.defaults),d.setExtraChanMsg(s.extraChanMsg),h.setData(s.websockets.use,s.websockets.host,s.websockets.port,s.websockets.ssl)}var u=c.get("checkLogin");if(u&&!o){n.nick=u.nick,n.signature=u.signature,n.uid=u.uid,n.pmIdent="["+n.net.toString()+","+n.uid.toString()+"]",n.isGuest=""===s.signature;var g=r("uid");return""!==g&&g!=n.uid?(c.remove("config"),c.remove("checkLogin"),void n.fetch(t,o)):void(void 0!==t&&t())}n.loggedIn()&&n.isGuest?n.identGuest(n.nick,function(e){e.success&&(n.signature=e.signature),void 0!==t&&t()}):l.getJSON(s.checkLoginUrl+"&network="+n.net.toString()+"&jsoncallback=?",function(e){c.set("checkLogin",{nick:e.nick,signature:e.signature,uid:e.uid}),n.nick=e.nick,n.signature=e.signature,n.uid=e.uid,n.pmIdent="["+n.net.toString()+","+n.uid.toString()+"]",n.isGuest=""===e.signature,void 0!==t&&t()},!0,!1)};if(void 0===o&&(o=!1),o&&n.loggedIn()&&n.isGuest)return console.log("i am silly"),void n.identGuest(n.nick,function(e){e.success&&(n.signature=e.signature),void 0!==t&&t()});if(!o){var i=c.get("config");if(i)return void s(i)}c.determinePrefix(),l.getJSON("config.php?js&network="+r("network")+(o?"&clonly":""),s,!0,!1)},setIdent:function(e,t,o){n.nick=e,n.signature=t,n.uid=o,c.set("checkLogin",{nick:e,signature:t,uid:o})},getUrlParams:function(){return"nick="+base64.encode(n.nick)+"&signature="+base64.encode(n.signature)+"&time="+(+new Date).toString()+"&id="+n.uid+"&network="+n.net+"&noLoginErrors"},getNetwork:function(e){return void 0!==n.networks[e]?n.networks[e]:{id:-1,normal:"NICK",userlist:"NICK",name:"Invalid network",type:-1}},getIdentParams:function(){return{nick:n.nick,signature:n.signature,time:(+new Date).toString(),id:n.uid,network:n.net}},loggedIn:function(){return""!==n.signature},getWholePmIdent:function(e,t){var o="["+t.toString()+","+e.toString()+"]";return t<n.net?o+n.pmIdent:n.net<t?n.pmIdent+o:e<n.uid?o+n.pmIdent:n.pmIdent+o}};return{identGuest:n.identGuest,fetch:n.fetch,getUrlParams:n.getUrlParams,getIdentParams:n.getIdentParams,getNetwork:n.getNetwork,nick:function(){return n.nick},net:function(){return n.net},loggedIn:n.loggedIn,guestLevel:function(){return n.guestLevel},getPmIdent:function(){return n.pmIdent},isGuest:function(){return n.isGuest},numHigh:function(){return n.numHigh},getWholePmIdent:n.getWholePmIdent,logout:n.logout,login:n.login}}(),a=function(){var e={prefix:r("network"),setPrefix:function(n){return n?void(e.prefix=n.toString()):void(e.prefix="")},getCookie:function(e){var n,t,o,r=document.cookie.split(";");for(n=0;n<r.length;n++)if(t=r[n].substr(0,r[n].indexOf("=")),o=r[n].substr(r[n].indexOf("=")+1),t=t.replace(/^\s+|\s+$/g,""),t==e)return unescape(o)},setCookie:function(e,n,t){var o=new Date,r=escape(n);o.setDate(o.getDate()+t),r+=null===t?"":"; expires="+o.toUTCString(),document.cookie=e+"="+r},haveSupport:null,support:function(){if(null===e.haveSupport)try{localStorage.setItem("test",1),e.haveSupport=1==localStorage.getItem("test"),localStorage.removeItem("test"),e.haveSupport=!0}catch(n){e.haveSupport=!1}return e.haveSupport},get:function(n){var t;n=e.prefix+n,t=e.support()?localStorage.getItem(n):e.getCookie(n);try{return JSON.parse(t)}catch(o){return}},set:function(n,t){n=e.prefix+n,t=JSON.stringify(t),e.support()?localStorage.setItem(n,t):e.setCookie(n,t)},remove:function(n,t){n=e.prefix+n,e.support()?localStorage.removeItem(n):e.setCookie(n,"",-1)}};return{setPrefix:e.setPrefix,get:e.get,set:e.set,remove:e.remove}}(),c=function(){var e={prefix:r("network"),setPrefix:function(n){n&&(e.prefix=n.toString())},determinePrefix:function(){e.haveSupport=null},haveSupport:null,support:function(){if(null===e.haveSupport)try{sessionStorage.setItem("test",1),e.haveSupport=1==sessionStorage.getItem("test"),sessionStorage.removeItem("test"),e.haveSupport&&""==e.prefix&&e.setPrefix(sessionStorage.getItem("defaultNetwork"))}catch(n){e.haveSupport=!1}return e.haveSupport},get:function(n){if(e.support())try{return JSON.parse(sessionStorage.getItem(e.prefix+n))}catch(t){return}},set:function(n,t){e.support()&&sessionStorage.setItem(e.prefix+n,JSON.stringify(t))},remove:function(n){e.support()&&sessionStorage.removeItem(e.prefix+n)}};return{determinePrefix:e.determinePrefix,get:e.get,set:e.set,remove:e.remove}}(),l=function(){var n={didRelog:!1,removeSig:function(e){try{var n=e.split("signature="),t=n[1].split("&");return t[0]="---",n[1]=t.join("&"),n.join("signature=")}catch(o){return e.indexOf("signature")!==-1?"omited due to security reasons":e}},addError:function(t,o){t=n.removeSig(t),e.onerror(t,o)},addWarning:function(t,o){t=n.removeSig(t),e.onwarning(t,o)},checkCallback:function(e,t,o,r){2!=e.relog&&(void 0!==e.errors&&$.map(e.errors,function(e){void 0!==e.type?n.addError(r,e):n.addError(r,{type:"misc",message:e})}),void 0!==e.warnings&&$.map(e.warnings,function(e){void 0!==e.type?n.addWarning(r,e):n.addWarning(r,{type:"misc",message:e})})),void 0!==e.relog&&0!=e.relog?1==e.relog?(i.fetch(void 0,!0),t(e)):2!=e.relog||n.didRelog?t(e):(n.didRelog=!0,i.fetch(function(){o()},!0)):(void 0!==e.relog&&(n.didRelog=!1),t(e))},getJSON:function(e,t,o,r){void 0==o&&(o=!0),void 0==r&&(r=!0),e.indexOf("?")==-1&&r&&(e+="?");var s=e+(r?"&"+i.getUrlParams():"");return $.ajax({url:s,dataType:"json",async:o}).done(function(i){n.checkCallback(i,t,function(){n.getJSON(e,t,o,r)},s)})},post:function(e,t,o,r,s){void 0==r&&(r=!0),void 0==s&&(s=!0),e.indexOf("?")==-1&&s&&(e+="?");var a=e+(s?"&"+i.getUrlParams():"");return $.ajax({type:"POST",url:a,async:r,data:t}).done(function(i){n.checkCallback(i,o,function(){n.post(e,t,o,r,s)},a)})}};return{getJSON:n.getJSON,post:n.post}}(),d=function(){var e={extraChanMsg:"",allOptions:{highBold:{disp:"Highlight Bold","default":!0},highRed:{disp:"Highlight Red","default":!0},colordNames:{disp:"Colored Names","default":0,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("colordNames",this.value)}).append($.map(["none","calc","server"],function(n,t){return $("<option>").attr(e.get("colordNames")==t?"selected":"false","selected").val(t).text(n)})))}},curChan:{hidden:!0,"default":0},extraChans:{disp:"Show extra Channels","default":!1,before:function(){return""!==e.extraChanMsg&&alert(e.extraChanMsg),!0}},ding:{disp:"Ding on Highlight","default":!1},smileys:{disp:"Show Smileys","default":!0},charsHigh:{disp:"Number chars for Highlighting","default":4,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("charsHigh",this.value)}).append($.map([1,2,3,4,5,6,7,8,9,10],function(n){return $("<option>").attr(e.get("charsHigh")==n?"selected":"false","selected").val(n).text(n)})))}},oircJoinPart:{disp:"Show OmnomIRC join/part messages","default":!1},textDeco:{disp:"Enable simple text decorations","default":!1},statusBar:{disp:"Show Updates in Browser Status Bar","default":!0},browserNotifications:{disp:"Browser Notifications","default":!1,before:function(){return S.request(),!1}},wysiwyg:{disp:"Use WYSIWYG editor","default":!1}},set:function(n,t){if(void 0!==e.allOptions[n]){e.allOptions[n].value=t;var o=a.get("options")||{};o[n]=t,a.set("options",o)}},get:function(n){if(void 0!==e.allOptions[n])return e.allOptions[n].value},setExtraChanMsg:function(n){e.extraChanMsg=n},setDefaults:function(n){var t=a.get("options");$.each(e.allOptions,function(o,r){var s=r["default"];t&&void 0!==t[o]?s=t[o]:n&&void 0!==n[o]&&(s=n[o]),e.allOptions[o].value=s})},getAll:function(n){if(n)return e.allOptions;var t={};return $.each(e.allOptions,function(e,n){void 0!==n.hidden&&n.hidden||(t[e]=n.value)}),t},setAll:function(n){e.allOptions=n}};return{set:e.set,get:e.get,setDefaults:e.setDefaults,setExtraChanMsg:e.setExtraChanMsg,getAll:e.getAll,setAll:e.setAll}}(),g=function(){var e={id:Math.random().toString(36)+(new Date).getTime().toString(),update:function(){a.set("browserTab",e.id),a.set("newInstant",!1)},init:function(){a.set("browserTab",e.id),$(window).focus(function(){e.update()}).unload(function(){e.kill()})},current:function(){return a.get("newInstant")&&e.update(),e.id==a.get("browserTab")},kill:function(){a.set("newInstant",!0),$(window).off("focus").off("unload")}};return{init:e.init,current:e.current,kill:e.kill}}(),h=function(){var e={ws:{socket:!1,connected:!1,use:!0,sendBuffer:[],allowLines:!1,enabled:!1,host:"",port:0,ssl:!0,tryFallback:!0,didRelog:!1,fallback:function(){if(console.log("trying fallback..."),e.ws.tryFallback){try{e.ws.tryFallback=!1,e.ws.socket.close()}catch(n){}e.ws.use=!1,e.old.lastSuccess=(new Date).getTime(),e.old.start()}},identify:function(){e.ws.send($.extend({action:"ident"},i.getIdentParams())),e.ws.send({action:"charsHigh",chars:d.get("charsHigh")})},init:function(){if(!("WebSocket"in window&&e.ws.enabled))return e.ws.use=!1,!1;try{var n=window.location.pathname.split("/");n.pop(),n.length>1&&""===n[n.length-1]&&n.pop(),n.push("ws"),n.push(i.net()),e.ws.socket=new PooledWebSocket((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+n.join("/"))}catch(t){return console.log(e.ws.socket),console.log((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+n.join("/")),console.log(t),void e.ws.fallback()}return e.ws.socket.onopen=function(n){e.ws.connected=!0;for(var t=0;t<e.ws.sendBuffer.length;t++)e.ws.send(e.ws.sendBuffer[t]);e.ws.sendBuffer=[]},e.ws.socket.onmessage=function(n){try{var t=JSON.parse(n.data);console.log(t),e.ws.allowLines&&(void 0!==t.line&&(s(t.line)&&(e.ws.tryFallback=!1,delete e.ws.socket),console.log("Added line!")),void 0!==t.users&&p.setUsers(t.users)),void 0!==t.relog&&0!=t.relog&&t.relog<3&&(e.ws.didRelog||(e.ws.didRelog=!0,i.fetch(function(){i.loggedIn()&&(e.ws.identify(),e.ws.didRelog=!1)},!0)))}catch(n){console.log("ERROR!"),console.log(n)}},e.ws.socket.onclose=function(n){console.log("CLOOOOOOOOOSE"),console.log(n),e.ws.use=!1,e.ws.fallback()},e.ws.socket.onerror=function(n){console.log("ERRRORRRR"),console.log(n),delete e.ws.socket,e.ws.use=!1,e.ws.fallback()},e.ws.identify(),$(window).on("beforeunload",function(){e.partChan(f.current().handler),delete e.ws.socket}),!0},send:function(n){e.ws.connected?e.ws.socket.send(JSON.stringify(n)):e.ws.sendBuffer.push(n)}},old:{inRequest:!1,handler:!1,lastSuccess:(new Date).getTime(),fnCallback:void 0,chan:"",sendRequest:function(){e.old.chan&&(e.old.handler=l.getJSON("Update.php?high="+d.get("charsHigh").toString()+"&channel="+e.old.chan+"&lineNum="+e.curline.toString(),function(n){e.old.handler=!1,e.old.lastSuccess=(new Date).getTime(),void 0!==n.lines&&$.map(n.lines,function(e){s(e)}),void 0!=n.errors&&n.errors.length>=1||n.banned!==!0&&e.old.setTimer()}).fail(function(){return e.old.handler=!1,void 0!=e.fnCallback?(e.fnCallback(),void(e.fnCallback=void 0)):void((new Date).getTime()>=e.old.lastSuccess+3e5?w.internal('<span style="color:#C73232;">OmnomIRC has lost connection to server. Please refresh to reconnect.</span>'):e.old.inRequest?e.old.setTimer():e.old.lastSuccess=(new Date).getTime())}))},setTimer:function(){e.old.inRequest&&f.current().loaded&&e.old.handler===!1?setTimeout(function(){e.old.sendRequest()},P.isBlurred()?2500:200):e.old.stop()},start:function(){e.old.inRequest||(e.old.inRequest=!0,e.old.setTimer())},stop:function(n){e.old.inRequest?(e.old.inRequest=!1,e.old.handler?(e.fnCallback=n,e.old.handler.abort()):void 0!==n&&n()):void 0!==n&&n()},send:function(e,n,t){l.getJSON("message.php?message="+base64.encode(e)+"&channel="+n,function(e){void 0!==t&&t(e)})}},curline:0,joinChan:function(n){e.ws.use&&e.ws.send({action:"joinchan",chan:n}),parseInt(n,10)!=n&&(n=base64.encode(n)),e.old.chan=n},partChan:function(n){e.ws.use&&e.ws.send({action:"partchan",chan:n})},stop:function(n){e.ws.use?(e.ws.allowLines=!1,n()):e.old.stop(n)},kill:function(){e.ws.use?(e.ws.socket.onclose=function(){},e.ws.socket.close()):e.old.stop()},start:function(){e.ws.use?e.ws.allowLines=!0:e.old.start()},setCurline:function(n){console.log("Curline: "+n),n>e.curline&&(e.curline=n)},send:function(n,t,o){e.ws.use?(e.ws.send({action:"message",channel:t,message:n}),void 0!==o&&o()):(parseInt(t,10)!=t&&(t=base64.encode(t)),e.old.send(n,t,o))},setData:function(n,t,o,r){e.ws.enabled=n,e.ws.host=t,e.ws.port=o,e.ws.ssl=r},init:function(){e.ws.enabled?e.ws.init():(e.ws.use=!1,e.old.lastSuccess=(new Date).getTime())},identify:function(){e.ws.enabled&&e.ws.identify()},postfetch:function(){e.ws.use&&e.ws.send({action:"postfetch",channel:f.current().handler,curline:e.curline})},isNew:function(n){return 0==n||n>e.curline}};return{joinChan:e.joinChan,partChan:e.partChan,start:e.start,stop:e.stop,kill:e.kill,setCurline:e.setCurline,send:e.send,setData:e.setData,init:e.init,identify:e.identify,postfetch:e.postfetch,isNew:e.isNew}}(),f=function(){var n=function(n){var o=void 0!==t.chans[n],r={i:n,name:o?t.chans[n].chan.toLowerCase():"",handler:o?t.getHandler(n):-1,handlerB64:o?t.getHandler(n,!0):-1,loaded:!1,load:function(e){return void 0===e.lines?(e.message?w.internal(e.message):w.internal('<span style="color:#C73232;"><b>ERROR:</b> couldn\'t join channel</span>'),!1):(d.set("curChan",n),e.banned?(w.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),!1):(p.setUsers(e.users),$.each(e.lines,function(e,n){s(n,!0)}),r.loaded=!0,!0))},unload:function(){r.loaded&&h.partChan(r.handler)},part:function(){t.part(t.i)},reloadUserlist:function(){o&&l.getJSON("Load.php?userlist&channel="+r.handlerB64,function(e){e.banned?w.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'):e.users&&p.setUsers(e.users)})},reload:function(){e.onchanneljoin(r.name)},setI:function(e){r.i=e},is:function(e){return e==r.i}};return{name:r.name,handler:r.handler,handlerB64:r.handlerB64,load:r.load,part:r.part,reload:r.reload,unload:r.unload,loaded:function(){return r.loaded},setI:r.setI,is:r.is,reloadUserlist:r.reloadUserlist}},t={current:!1,chans:[],save:function(){a.set("channels",t.chans)},loadSettings:function(){try{var n=a.get("channels"),o=$.map(t.chans,function(e){if(e.ex&&d.get("extraChans")||!e.ex)return e}),r=[];null!==n&&n!=[]&&(t.chans=$.merge($.map(n,function(e){if(e.id!=-1&&"*"!=e.id.toString().substr(0,1)){var n=!1;if($.each(t.chans,function(t,o){if(o.id==e.id)return r.push(e),n=!0,e.chan=o.chan,!1}),!n)return}return e}),$.map(o,function(e){var n=!1;if($.each(r,function(t,o){if(o.id==e.id)return n=!0,e.chan=o.chan,!1}),!n)return e})),save())}catch(s){}e.onchannelchange(t.chans)},init:function(){t.current=n(-1),t.loadSettings()},addChan:function(n,o){var r=!0;return void 0===o&&(o=-1),n=n.toLowerCase(),$.each(t.chans,function(e,t){t.chan==n&&(r=e)}),r===!0?"#"==n[0]?(w.internal('<span style="color:#C73232;">Join Error: Cannot join new channels starting with #.</span>'),-1):(t.chans.push({chan:n,high:!1,ex:!1,id:o,order:-1}),t.save(),e.onchannelchange(t.chans),t.chans.length-1):r},getHandler:function(e,n){return t.chans[e].id!=-1?"number"!=typeof t.chans[e].id&&n?base64.encode(t.chans[e].id):t.chans[e].id.toString():n?base64.encode(t.chans[e].chan):t.chans[e].chan},requestHandler:!1,load:function(e,o){console.log("loading channel");var r=function(n){return t.current.load(n)?(t.chans[e].high=!1,t.save(),h.joinChan(t.getHandler(e)),h.start(),v.load(),k.read(),h.postfetch(),void o(!0,n)):void o(!1,{})};return void 0===o&&(o=function(){}),void 0===t.chans[e]?void o(!1,{}):void h.stop(function(){if(t.requestHandler!==!1&&t.requestHandler.abort(),c.get("chan")==t.getHandler(e)){d.set("curChan",e),t.current=n(e);for(var o={},s=["chan","banned","admin","users","ignores","lines"],i=0;i<s.length;i++)o[s[i]]=c.get(s[i]);return console.log(o),void r(o)}t.requestHandler=l.getJSON("Load.php?count=125&channel="+t.getHandler(e,!0),function(o){d.set("curChan",e),t.current=n(e),c.set("chan",t.current.handler),c.set("banned",o.banned),c.set("admin",o.admin),c.set("users",o.users),c.set("ignores",o.ignores),c.set("lines",o.lines),r(o)})})},join:function(e){return(e=e.trim())?("@"!=e[0]&&"#"!=e[0]&&(e="@"+e),t.addChan(e)):-1},joinPm:function(e,n,o){void 0===o&&(o=function(){});var r=function(n,r){n=n.trim(),"*"!=n.substr(0,1)&&(n="*"+e),r=r.trim(),"*"!=r.substr(0,1)&&(r="*"+r),o(t.addChan(n,r))};if(""==n){if("@"==e.substr(0,1)||"#"==e.substr(0,1))return w.internal('<span style="color:#C73232;">Query Error: Cannot query a channel. Use /join instead.</span>'),void o(-1);l.getJSON("misc.php?openpm="+base64.encode(e),function(e){e.channick?r(e.channick,e.chanid):(w.internal('<span style="color:#C73232;">Query Error: User not found.</span>'),o(-1))})}else r(e,n)},part:function(n){if(parseInt(n,10)==n&&(n=parseInt(n,10)),"number"!=typeof n&&(n&&"@"!=n[0]&&"#"!=n[0]&&"*"!=n[0]&&(n="@"+n),$.each(t.chans,function(e,t){if(t.chan==n)return n=e,!1})),"number"!=typeof n||void 0===t.chans[n])return w.internal('<span style="color:#C73232;"> Part Error: can\'t part '+n+". (You are not in it.)</span>"),!1;if("#"==t.chans[n].chan[0])return w.internal('<span style="color:#C73232;"> Part Error: can\'t part '+t.chans[n].chan+". (IRC channel.)</span>"),!1;var o=t.chans[n].chanId,r=!1;return t.current.is(n)&&(r=!0),o==-1&&(o=t.chans[n]),h.partChan(t.getHandler(n)),t.chans.splice(n,1),t.save(),e.onchannelchange(t.chans),r&&e.onchanneljoin(t.chans[n-1].chan),!0},getList:function(){return t.chans},setChans:function(n){t.chans=n,t.current&&(t.save(),e.onchannelchange(t.chans))},getNames:function(){return $.map(t.chans,function(e){return e.chan})},highlight:function(n){$.each(t.chans,function(e,o){if(n==o.id||o.chan.toLowerCase()==n.toString().toLowerCase())return t.chans[e].high=!0,!1}),t.save(),e.onchannelchange(t.chans)}};return{init:t.init,load:t.load,join:t.join,joinPm:t.joinPm,part:t.part,getList:t.getList,getHandler:t.getHandler,current:function(){return t.current},setChans:t.setChans,getNames:t.getNames,highlight:t.highlight}}(),p=function(){var n={users:[],draw:function(){n.users.sort(function(e,n){var t=e.nick.toLowerCase(),o=n.nick.toLowerCase();return t==o?e==n?0:e<n?-1:1:t<o?-1:1}),e.onuserchange(n.users)},exists:function(e){var t=!1;return $.each(n.users,function(e,n){if(n.nick.toLowerCase()==u.nick.toLowerCase()&&n.network==u.network)return t=!0,!1}),t},add:function(e){if(""!==f.current().handler){var t=!0;$.each(n.users,function(n,o){if(o.nick==e.nick&&o.network==e.network)return t=!1,!1}),t&&(n.users.push(e),n.draw())}},remove:function(e){""!==f.current().handler&&($.each(n.users,function(t,o){if(o.nick==e.nick&&o.network==e.network)return n.users.splice(t,1),!1}),n.draw())},setUsers:function(e){n.users=e,c.set("users",n.users),n.draw()},getNames:function(){return $.map(n.users,function(e){return e.nick})}};return{add:n.add,remove:n.remove,setUsers:n.setUsers,getNames:n.getNames,getUsers:function(e){return n.users}}}(),m=function(){var t={parse:function(t){var o=t.split(" ")[0].toLowerCase(),r=t.substr(o.length+1).toLowerCase().trim();switch(o){case"j":case"join":return i.isGuest()?w.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t join as guest</span>'):e.onchanneljoin(r),!0;case"q":case"query":return i.isGuest()?w.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t query as guest</span>'):e.onchanneljoin("*"+r),!0;case"win":case"w":case"window":var s=f.getList()[parseInt(r,10)];return void 0!==s&&e.onchanneljoin(s.chan),!0;case"p":case"part":return""!==r?e.onchannelpart(r):e.onchannelpart(f.current().name),!0;case"help":return w.internal('<span style="color:#2A8C2A;">Commands: me, ignore, unignore, ignorelist, join, part, query, msg, window</span>'),w.internal('<span style="color:#2A8C2A;">For full help go here: <a href="http://ourl.ca/19926" target="_top">http://ourl.ca/19926</a></span>'),!0;case"ponies":return $.getScript("https://juju2143.ca/mousefly.js",function(){Derpy()}),!0;case"minty":return $.getJSON(n+"/minty.php").done(function(e){w.internal('<span style="font-size:5px;line-height:0;font-family:monospace;">'+e.minty+"</span>")}),!0;default:return!1}}};return{parse:t.parse}}(),w=function(){var n={sending:!1,send_real:function(e,t,o,r){r&&e(),n.sending?setTimeout(function(){r?n.send_real(function(){},t,o,r):n.send_real(e,t,o,r)},1e3):(n.sending=!0,h.send(t,o,function(t){void 0!==t&&void 0!==t.lines&&$.map(t.lines,function(e){s(e)}),n.sending=!1,r||e()}))},send:function(e,t,o){var r=!0;return"string"==typeof e&&(t=e,e=void 0),void 0===e&&(e=function(){}),"boolean"==typeof t&&(r=t,t=void 0),void 0===t&&(t=w.val()),t?(k.add(t),""!==t&&d.get("textDeco")&&(">"==t[0]&&(t="3"+t),t=t.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),void 0===o&&(o=f.current().handler),void("/"==t[0]&&m.parse(t.substr(1))?e():n.send_real(e,t,o,r))):void e()},internal:function(e){s({curline:0,type:"internal",time:Math.floor((new Date).getTime()/1e3),name:"",message:e,name2:"",chan:f.current().handler})},val:function(n){return void 0===n?e.ongetval===!1?o.is("input")?o.val():o.text():e.ongetval():void(e.onsetval===!1?o.is("input")?o.val(n):o.text(n):e.onsetval(n))}};return{internal:n.internal,send:n.send,val:n.val}}(),v=function(){var e={tabWord:"",tabCount:0,isInTab:!1,startPos:0,startChar:"",endPos:0,endChar:"",endPos0:0,tabAppendStr:"",searchArray:[],node:!1,wysiwyg:!1,getCurrentWord:function(){var n=e.wysiwyg?(e.node=window.getSelection().anchorNode).nodeValue:o[0].value;if(e.isInTab)return e.tabWord;for(e.startPos=e.wysiwyg?window.getSelection().anchorOffset:o[0].selectionStart,e.startChar=n.charAt(e.startPos);" "!=e.startChar&&--e.startPos>0;)e.startChar=n.charAt(e.startPos);for(" "==e.startChar&&e.startPos++,e.endPos=e.wysiwyg?window.getSelection().anchorOffset:o[0].selectionStart,e.endChar=n.charAt(e.endPos);" "!=e.endChar&&++e.endPos<=n.length;)e.endChar=n.charAt(e.endPos);return e.endPos0=e.endPos,e.tabWord=n.substr(e.startPos,e.endPos-e.startPos).trim(),e.tabWord},getTabComplete:function(){var n,t=e.wysiwyg?e.node.nodeValue:o[0].value;null!==t&&(n=e.search(e.getCurrentWord(),e.tabCount),e.isInTab||(e.tabAppendStr=" ",0===e.startPos&&(e.tabAppendStr=": ")),n==e.getCurrentWord()&&(e.tabCount=0,n=e.search(e.getCurrentWord(),e.tabCount)),t=t.substr(0,e.startPos)+n+e.tabAppendStr+t.substr(e.endPos+1),e.wysiwyg?(window.getSelection().anchorNode.nodeValue=t,window.getSelection().getRangeAt(0).setEnd(e.node,e.startPos+n.length+e.tabAppendStr.length),window.getSelection().getRangeAt(0).setStart(e.node,e.startPos+n.length+e.tabAppendStr.length)):o[0].value=t,e.endPos=e.endPos0+n.length+e.tabAppendStr.length)},search:function(n,t){var o=!1;return t||(t=0),$.each(e.searchArray,function(e,r){0===r.toLowerCase().indexOf(n.toLowerCase())&&t--<=0&&o===!1&&(o=r)}),o!==!1?o:n},init:function(){e.wysiwyg=!o.is("input"),o.keydown(function(n){9==n.keyCode?n.ctrlKey||(n.preventDefault(),e.getTabComplete(),e.isInTab=!0,e.tabCount++,setTimeout(1,1)):(e.tabWord="",e.tabCount=0,e.isInTab=!1)})},load:function(){e.searchArray=$.merge(p.getNames(),f.getNames())}};return{init:e.init,load:e.load}}(),k=function(){var n={messages:[],counter:0,current:"",init:function(){o.keydown(function(e){38!=e.keyCode&&40!=e.keyCode||(e.preventDefault(),n.counter==n.messages.length&&(n.current=w.val()),0!==n.messages.length&&(38==e.keyCode?(0!==n.counter&&n.counter--,w.val(n.messages[n.counter])):(n.counter!=n.messages.length&&n.counter++,n.counter==n.messages.length?w.val(n.current):w.val(n.messages[n.counter]))))})},add:function(t){n.messages.push(t),n.messages.length>20&&n.messages.shift(),n.counter=n.messages.length,e.ls.set("oldMessages-"+e.channels.current().handlerB64,n.messages)},read:function(){n.messages=e.ls.get("oldMessages-"+e.channels.current().handlerB64),n.messages||(n.messages=[]),console.log(n.messages),n.counter=n.messages.length}};return{init:n.init,add:n.add,read:n.read}}(),b=function(){var n={menuOpen:!1,msgVal:"",$textDecoForm:!1,hideMenu:function(){n.$textDecoForm.css("display","none"),n.menuOpen=!1},reverseParse:function(e){if(e.indexOf("<")===-1)return $("<span>").html(e).text();var n=!1,t=!1,o=!1,r="-1",s="-1";return e=e.replace(/<img([^>]*?)>/gi,function(e,n){var t=n.match(/data-code="([^"]*)"/);return t?t[1]:""}),e=e.replace(/<span([^>]*?)>([^<]*?)<\/span>/gi,function(i,a,c){if(!a)return c;e="",a.indexOf("bold")==-1==n&&(n=!n,e+=""),a.indexOf("italic")==-1==t&&(t=!t,e+=""),a.indexOf("underline")==-1==o&&(o=!o,e+="");var l=a.match(/fg-(\d+)/),u=a.match(/bg-(\d+)/);return l||(l="-1"),u||(u="-1"),u==s&&l==r||(("-1"!=r&&"-1"==l||"-1"!=s&&"-1"==u)&&(e="",n&&(e+=""),t&&(e+=""),o&&(e+="")),e+="",r=l,"-1"!=r&&(e+=r),s=u,"-1"!=s&&(e+=","+s)),e+c}),$("<span>").html(e).text()},getCaretCharacterOffsetWithin:function(e){var n=window.getSelection();if(n.rangeCount>0){var t,o=n.getRangeAt(0),r=o.cloneRange(),s=0,i=document.createRange();r.selectNodeContents(e),r.setEnd(o.endContainer,o.endOffset),t=r.commonAncestorContainer.getElementsByTagName("img");for(var a=0;a<t.length;a++){var c=t[a];c.dataset.code&&(i.selectNode(c),1!=r.compareBoundaryPoints(Range.START_TO_START,i)&&r.compareBoundaryPoints(Range.END_TO_END,i)!=-1&&(s+=c.dataset.code.length))}return r.toString().length+s}return 0},getWholeSelection:function(e){var t,o=window.getSelection(),r=o.getRangeAt(0),s=r.cloneRange(),i=n.getCaretCharacterOffsetWithin(e);return r.collapse(!0),o.removeAllRanges(),o.addRange(r),t=n.getCaretCharacterOffsetWithin(e),o.removeAllRanges(),o.addRange(s),[t,i]},setCaretCharacterOffsetWithin:function(e,t,o,r,s){void 0===o&&(o=0),void 0===r&&(r=document.createRange()),void 0===s&&(s=!1);for(var i=0;i<e.childNodes.length;i++){var a=e.childNodes[i];if(3==a.nodeType){if(a.length>=t){var c=window.getSelection();if(s||(r.setStart(a,t),s=!0,t+=o),s&&a.length>=t)return r.setEnd(a,t),c.removeAllRanges(),c.addRange(r),-1}t-=a.length}else if(1==a.nodeType){if("IMG"==a.tagName&&a.dataset.code){if(a.dataset.code.length>=t){var c=window.getSelection();if(s||(r.setStartAfter(a),s=!0,t+=o),s&&a.dataset.code.length>=t)return r.setEndAfter(a),c.removeAllRanges(),c.addRange(r),-1}t-=a.dataset.code.length}else if(t=n.setCaretCharacterOffsetWithin(a,t,o,r,s),t<0)return-1}else if(t=n.setCaretCharacterOffsetWithin(a,t,o,r,s),t<0)return-1}return t},surroundSelection:function(e,n){var t=window.getSelection();if(t.rangeCount>0){var o=t.getRangeAt(0),r=o.startContainer,s=o.startOffset,i=document.createTextNode(e),a=document.createTextNode(n),c=o.cloneRange();c.collapse(!1),c.insertNode(a),c.setStart(r,s),c.collapse(!0),c.insertNode(i),o.setStartAfter(i),o.setEndBefore(a),t.removeAllRanges(),t.addRange(o)}},updateContent:function(e,t){void 0===e&&(e=t=n.getCaretCharacterOffsetWithin(o[0])),n.msgVal=n.reverseParse(o.html()),o.html(y.parse(n.msgVal)),n.setCaretCharacterOffsetWithin(o[0],e,t-e)},init:function(){if(n.support()){var r=o.attr("id"),s=$("<span>").attr({contenteditable:"true",accesskey:"i",id:r}).css({display:"inline-block",height:"1em",padding:"0.3em 0.2em 0.2em 0.3em",fontSize:"1.2em",verticalAlign:"top",whiteSpace:"nowrap",backgroundColor:o.css("backgroundColor")});for(var i in["Top","Bottom","Left","Right"])for(var a in["Style","Width","Color"])s.css("border"+i+a,o.css("border"+i+a));o.replaceWith(s),o=s,o.on("update",n.updateContent),n.$textDecoForm=$("<div>").css({position:"absolute",bottom:"3em"}).attr("id",t+"textDecoForm").append($("<button>").css("font-weight","bold").text("B").click(function(e){e.preventDefault();var t=n.getWholeSelection(o[0]);n.surroundSelection("",""),n.updateContent(t[0],t[1])}),"&nbsp;",$("<button>").css("font-style","italic").text("I").click(function(e){e.preventDefault();var t=n.getWholeSelection(o[0]);n.surroundSelection("",""),n.updateContent(t[0],t[1])}),"&nbsp;",$("<button>").css("text-decoration","underline").text("U").click(function(e){e.preventDefault();var t=n.getWholeSelection(o[0]);n.surroundSelection("",""),n.updateContent(t[0],t[1])}),"<br>",$.map([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],function(e){return[e%4==0?"<br>":"",$("<span>").css({display:"inline-block",height:"1em",width:"2em"}).addClass(t+"colorbutton").addClass(t+"bg-"+e).click(function(t){t.preventDefault();var r=n.getWholeSelection(o[0]);n.surroundSelection(""+e,""),n.updateContent(r[0],r[1])})]})).hide().insertBefore(o),e.onsetval=function(e){n.msgVal=e,o.html(y.parse(e))},e.ongetval=function(){return n.msgVal},o.on("input",function(e){n.updateContent()}),o.mouseup(function(e){var t=window.getSelection();t.isCollapsed||(e.preventDefault(),n.$textDecoForm.show().css("left",Math.max(e.pageX-52,0)),n.menuOpen=!0)}),$(document).mousedown(function(e){!$(e.target).closest(n.$textDecoForm).length&&n.menuOpen&&n.hideMenu()})}},support:function(){return"contentEditable"in document.documentElement&&d.get("wysiwyg")}};return{init:n.init,getMsg:n.getMsg,support:n.support,updateContent:n.updateContent}}(),C=function(){var e={text:"",started:!1,start:function(){return d.get("statusBar")?void(e.started||(setInterval(function(){if(window.status=e.text,parent)try{parent.window.status=e.text}catch(n){}},500),e.started=!0)):void(e.started=!0)},set:function(n){e.text=n,e.started||e.start()}};return{set:e.set}}(),S=function(){var n={support_webkit:void 0!==window.webkitNotifications&&null!==window.webkitNotifications&&window.webkitNotifications,support:function(){return"undefined"!=typeof Notification&&Notification&&"denied"!=Notification.permission},show:function(e){var t;n.support_webkit?(t=window.webkitNotifications.createNotification("omni.png","OmnomIRC Highlight",e),t.show()):n.support()&&(t=new Notification("OmnomIRC Highlight",{icon:"omni.png",body:e}),t.onshow=function(){setTimeout(t.close,3e4)})},request:function(){n.support_webkit?window.webkitNotifications.requestPermission(function(){0===window.webkitNotifications.checkPermission()&&(n.show("Notifications Enabled!"),e.options.set("browserNotifications",!0),document.location.reload())}):n.support()?Notification.requestPermission(function(t){Notification.permission!==t&&(Notification.permission=t),"granted"===t&&(n.show("Notifications Enabled!"),e.options.set("browserNotifications",!0),document.location.reload())}):alert("Your browser doesn't support notifications")},sound:!1,make:function(t,o){var r=g.current();r&&(d.get("browserNotifications")&&n.show(t),d.get("ding")&&n.sound&&n.sound.play()),
n.startFlash(),e.onnotification(t,o,r)},doFlash:!1,intervalHandler:!1,originalTitle:"",target:top.postMessage?top:top.document.postMessage?top.document:void 0,startFlash:function(){if(!n.doFlash)if(n.doFlash=!0,top==window){var e=!1;n.originalTitle=document.title,n.intervalHandler=setInterval(function(){document.title=(e?"[ @] ":"[@ ] ")+n.originalTitle,e=!e},500)}else void 0!==n.target&&n.target.postMessage("startFlash","*")},stopFlash:function(t){void 0===t&&(t=!1),n.doFlash&&(top==window?n.intervalHandler&&(clearInterval(n.intervalHandler),n.intervalHandler=!1,document.title=n.originalTitle):void 0!==n.target&&n.target.postMessage("stopFlash","*"),n.doFlash=!1,t||e.ls.set("stopFlash",Math.random().toString(36)+(new Date).getTime().toString()))},init:function(){$(window).on("storage",function(e){e.originalEvent.key==i.net()+"stopFlash"&&n.stopFlash(!0)}).unload(function(){n.stopFlash(!0)}).focus(function(){n.stopFlash()}),n.sound||(n.sound=new Audio("beep.mp3"))}};return{request:n.request,make:n.make,init:n.init}}(),y=function(){var n={smileys_a:[],cacheServerNicks:{},spLinks:[],name:function(e,o,r){void 0===r&&(r=-1),e="\0"==e?"":e;var s=encodeURIComponent(e);e=$("<span>").text(e).html();var a=[19,20,22,24,25,26,27,28,29],u=0,g=0,h=e,f=i.getNetwork(o),p=!0;switch(d.get("colordNames")){case"1":for(;e[g];)u+=e.charCodeAt(g++);h=$("<span>").append($("<span>").addClass(t+"uName-"+a[u%9].toString()).html(e)).html();break;case"2":void 0!==f&&void 0!==f.checkLogin&&r!=-1?(h=c.get("nick"+o.toString()+":"+r.toString()),h||(p=!1,void 0===n.cacheServerNicks[o.toString()+":"+r.toString()]&&l.getJSON(f.checkLogin+"?c="+r.toString(10)+"&n="+s,function(e){n.cacheServerNicks[o.toString()+":"+r.toString()]=e.nick},!1,!1),h=n.cacheServerNicks[o.toString()+":"+r.toString()],c.set("nick"+o.toString()+":"+r.toString(),h))):h=e;break;default:h=e}return void 0!==f&&p&&(h=f.normal.split("NICKENCODE").join(s).split("NICK").join(h).split("USERID").join(r.toString(10))),void 0!==f?'<span title="'+f.name+'">'+h+"</span>":'<span title="Unknown Network">'+h+"</span>"},smileys:function(e){return e?/^[\w\s\d\.,!?]*$/.test(e)?e:($.each(n.smileys_a,function(n,t){e=e.replace(RegExp(t.regex,"g"),t.replace)}),e):""},links:function(e){if(!e||null===e||void 0===e)return"";var t='[^\\s<"]';return e=e.replace(RegExp("(|)","g"),""),$.map(n.spLinks,function(n){n=n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=e.replace(RegExp("(^|[\\s>])((?:(?:f|ht)tps?://(?:www\\.)?)"+n+t+"*)","g"),"$1$2").replace(RegExp("(^|[\\s>])("+n+t+"*)","g"),"$1$2")}),e.replace(RegExp('(^|[^a-zA-Z0-9_"])((?:(?:f|ht)tps?://)'+t+"+)","g"),'$1<a target="_blank" href="$2">$2</a>').replace(RegExp("(^|[^a-zA-Z0-9_/])(www\\."+t+"+)","g"),'$1<a target="_blank" href="http://$2">$2</a>').replace(RegExp("(^|.)("+t+"+)","g"),'$1<a target="_top" href="$2">$2</a>').replace(RegExp("(^|.)("+t+"+)","g"),'$1<a target="_top" href="http://$2">$2</a>')},colors:function(e){var n,o,r,s=[],i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};if(!e)return"";for(s=e.split(RegExp("([])")),e="<span>",o=0;o<s.length;o++){switch(r=!0,s[o]){case"":n=s[o+1].replace(/^([0-9]{1,2}),([0-9]{1,2})(.*)/,"$1:$2"),n==s[o+1]?(n=s[o+1].replace(/^([0-9]{1,2}).*/,"$1:"),n!=s[o+1]?(i.fg=n.split(":")[0],s[o+1]=s[o+1].substr(n.length-1)):(i.fg="-1",i.bg="-1")):(i.fg=n.split(":")[0],i.bg=n.split(":")[1],n==s[o+1]?s[o+1]="":s[o+1]=s[o+1].substr(n.length));break;case"":i.bold=!i.bold;break;case"":i.italic=!i.italic;break;case"":n=i.fg,i.fg=i.bg,i.bg=n,"-1"==i.fg&&(i.fg="0"),"-1"==i.bg&&(i.bg="1");break;case"":i.underline=!i.underline;break;case"":i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};break;default:r=!1}e+=r?'</span><span class="'+t+"fg-"+i.fg+" "+t+"bg-"+i.bg+'" style="'+(i.bold?"font-weight:bold;":"")+(i.underline?"text-decoration:underline;":"")+(i.italic?"font-style:italic;":"")+'">':s[o]}return e+="</span>",e=e.replace(/(\x03|\x02|\x1F|\x09|\x0F)/g,"")},highlight:function(e){var n="";return d.get("highRed")||(n+="background:none;padding:none;border:none;"),d.get("highBold")&&(n+="font-weight:bold;"),'<span class="highlight" style="'+n+'">'+e+"</span>"},parse:function(e,t){return void 0!=t&&t||(t=!1),e="\0"==e?"":e,e=$("<span>").text(e).html(),d.get("smileys")&&t===!1&&(e=n.smileys(e)),e=n.colors(e),e=n.links(e)},setSmileys:function(e){n.smileys_a=[],$.each(e,function(e,t){n.smileys_a.push({regex:t.regex,replace:t.replace.split("ADDSTUFF").join('data-code="'+t.code+'"').split("PIC").join(t.pic).split("ALT").join(t.alt)})})},setSpLinks:function(e){n.spLinks=e},parseTextDecorations:function(e){return""!==e&&d.get("textDeco")&&(">"==e[0]&&(e="3"+e),e=e.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),e},addLine:function(t,o){if(o||"highlight"==t.type||t.chan.toString().toLowerCase()==f.current().handler.toLowerCase()||t.name2===i.getPmIdent()){var r=n.name(t.name,t.network,t.uid),s=n.parse(t.message),a="*",c=s;switch(""!=i.nick()&&["message","action","pm","pmaction"].indexOf(t.type)>=0&&"*"!=t.name.toLowerCase()&&s.toLowerCase().indexOf(i.nick().toLowerCase().substr(0,d.get("charsHigh")))>=0&&(c=s=y.highlight(s),!o&&P.isBlurred()&&S.make("("+f.current().name+") <"+t.name+"> "+t.message,t.chan)),t.type){case"reload":return void(o||f.current().reload());case"reload_userlist":return void(o||f.current().reloadUserlist());case"relog":return void(o||i.fetch(void 0,!0));case"refresh":return void(o||location.reload(!0));case"join":if(c=[r," has joined "+f.current().name],o||p.add({nick:t.name,network:t.network}),1==i.getNetwork(t.network).type&&!d.get("oircJoinPart"))return;break;case"part":if(c=[r," has left "+f.current().name+" (",s,")"],o||p.remove({nick:t.name,network:t.network}),1==i.getNetwork(t.network).type&&!d.get("oircJoinPart"))return;break;case"quit":if(c=[r," has quit IRC (",s,")"],o||p.remove({nick:t.name,network:t.network}),1==i.getNetwork(t.network).type&&!d.get("oircJoinPart"))return;break;case"kick":c=[r," has kicked ",y.name(t.name2,t.network)," from "+f.current().name+" (",s,")"],o||p.remove({nick:t.name2,network:t.network});break;case"message":a=r;break;case"action":c=[r," ",s];break;case"mode":"string"==typeof s&&(s=t.message.split(" "),$.each(s,function(e,n){var o=$("<span>").html(n).text();o.indexOf("+")==-1&&o.indexOf("-")==-1&&(s[e]=y.name(n,t.network))}),s=s.join(" ")),c=[r," set "+f.current().name+" mode ",s];break;case"nick":c=[r," has changed nicks to ",y.name(t.name2,t.network)],o||(p.add({nick:t.name2,network:t.network}),p.remove({nick:t.name,network:t.network}));break;case"topic":if(e.ontopicchange(y.parse(t.message,!0)),""===t.name&&0===t.network&&o)return;c=[r," has changed the topic to ",y.parse(t.message,!0)];break;case"pm":if(t.chan==f.current().handler)a=r,t.type="message";else{if(o)return;if(t.name.toLowerCase()==i.nick().toLowerCase())return void f.joinPm(t.chan,i.getWholePmIdent(t.uid,t.network));a=["(PM)",r],f.joinPm(t.name,i.getWholePmIdent(t.uid,t.network)),S.make("(PM) <"+t.name+"> "+t.message,t.chan)}break;case"pmaction":if(t.chan==f.current().handler)c=[r," ",s],t.type="action";else{if(o)return;if(t.name.toLowerCase()==i.nick().toLowerCase())return void f.joinPm(t.chan,i.getWholePmIdent(t.uid,t.network));c=["(PM)",r," ",s],f.joinPm(t.name,i.getWholePmIdent(t.uid,t.network)),notofication.make("* (PM)"+t.name+" "+t.message,t.chan),t.type="pm"}break;case"highlight":return void("*"!=t.name.toLowerCase()&&S.make("("+t.chan+") <"+t.name+"> "+t.message,t.chan));case"internal":c=t.message;break;case"server":break;default:return}e.onmessage(a,c,t,o)}}};return{setSmileys:n.setSmileys,setSpLinks:n.setSpLinks,parse:n.parse,parseTextDecorations:n.parseTextDecorations,name:n.name,highlight:n.highlight,addLine:n.addLine}}(),x=function(){var e={$errors:!1,$warnings:!1,errors:[],warnings:[],$errorsPopup:!1,$warningsPopup:!1,getSinglePopupEntry:function(e){return $("<div>").css("border-bottom","1px solid black").append("Time: ",new Date(e.time).toLocaleTimeString(),"<br>File: ",$("<span>").text(e.file).html(),$.map(e.content,function(e,n){return["<br>",$("<span>").text(n).html(),": ",$("<span>").text(e).html()]}))},makePopup:function(n,t,o){return $("<div>").addClass("errorPopup").addClass(n.toLowerCase()).append($("<a>").text("Close").click(function(e){e.preventDefault(),$(this).parent().remove(),o()}),"&nbsp;",$("<b>").text(n),$("<div>").addClass("errorPopupCont").append($.map(t,function(n){return e.getSinglePopupEntry(n)}))).appendTo("body")},init:function(n,t){void 0===n&&(n=$("#errors")),void 0===t&&(t=$("#warnings")),n.click(function(){e.$errorsPopup||(e.$errorsPopup=e.makePopup("Errors",e.errors,function(){e.$errorsPopup=!1}))}),t.click(function(){e.$warningsPopup||(e.$warningsPopup=e.makePopup("Warnings",e.warnings,function(){e.$warningsPopup=!1}))}),e.$errors=n,e.$warnings=t},addError:function(n,t){e.errors.push({time:(new Date).getTime(),file:n,content:t}),e.$errors.css("display","").find(".count").text(e.errors.length),e.$errorsPopup&&e.$errorsPopup.children("div").append(e.getSinglePopupEntry(e.errors[e.errors.length-1]))},addWarning:function(n,t){e.warnings.push({time:(new Date).getTime(),file:n,content:t}),e.$warnings.css("display","").find(".count").text(e.warnings.length),e.$warningsPopup&&e.$warningsPopup.children("div").append(e.getSinglePopupEntry(e.warnings[e.warnings.length-1]))}};return{addError:e.addError,addWarning:e.addWarning,init:e.init}}(),P=function(){var n={isBlurred:!0,init:function(){$(window).blur(function(){n.isBlurred=!0}).focus(function(){n.isBlurred=!1})},changeLinks:function(){$('#adminLink a,a[href="."],a[href="?options"],a[href="index.php"]').each(function(){void 0!==$(this).attr("href").split("?")[1]?$(this).attr("href",$(this).attr("href")+"&network="+e.settings.net()):$(this).attr("href",$(this).attr("href")+"?network="+e.settings.net())})}};return{init:n.init,changeLinks:n.changeLinks,isBlurred:function(){return n.isBlurred}}}(),N=function(){var e={isOpen:!1,open:function(n){e.isOpen||(e.isOpen=!0,h.stop(n))},close:function(){e.isOpen&&(e.isOpen=!1,f.current().reload())},fetch:function(n,t,o){e.isOpen&&(void 0===o&&(o=0),l.getJSON("Log.php?day="+n+"&offset="+parseInt(o,10)+"&channel="+f.current().handlerB64,function(r){r.banned?(w.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),t(!1)):($.map(r.lines,function(e){s(e,!0)}),r.lines.length>=1e3?e.fetch(n,t,o+1e3):void 0!==t&&t(!0))}))}};return{fetch:e.fetch,open:e.open,close:e.close}}();this.OMNOMIRCSERVER=n,this.settings={loggedIn:i.loggedIn,fetch:i.fetch,net:i.net,getNetwork:i.getNetwork,getPmIdent:i.getPmIdent,getWholePmIdent:i.getWholePmIdent,nick:i.nick,guestLevel:i.guestLevel,identGuest:i.identGuest,logout:i.logout},this.ls={get:a.get,set:a.set},this.network={getJSON:l.getJSON,post:l.post},this.options={get:d.get,set:d.set,getAll:d.getAll},this.instant={current:g.current},this.channels={load:f.load,join:f.join,joinPm:f.joinPm,part:f.part,getList:f.getList,getHandler:f.getHandler,current:f.current,setChans:f.setChans,highlight:f.highlight},this.users={add:p.add,remove:p.remove,setUsers:p.setUsers},this.send={send:w.send,internal:w.internal,val:w.val},this.parser={parse:y.parse,name:y.name,highlight:y.highlight},this.error={addWarning:x.addWarning,addError:x.addError,init:x.init},this.page={changeLinks:P.changeLinks,isBlurred:P.isBlurred},this.logs={fetch:N.fetch,open:N.open,close:N.close},this.statusBar={set:C.set},this.initinput=function(e,n){void 0===e&&(e=$("#message")),o=e,n&&b.init(),v.init(),k.init(),o.keypress(function(e){13==e.which&&(e.preventDefault(),o.attr("disabled")||w.send(function(){w.val(""),o.focus()}))})},this.connect=function(e){P.init(),S.init(),i.fetch(function(){g.init(),h.init(),f.init(),e()})},this.disconnect=function(){g.kill(),h.kill()},this.setClassPrefix=function(e){t=e},this.onerror=function(){},this.onwarning=function(){},this.onmessage=function(){},this.onmessageraw=!1,this.onuserchange=function(){},this.onchannelchange=function(){},this.onchanneljoin=function(){},this.onchannelpart=function(){},this.onsmileychange=function(){},this.onsetval=!1,this.ongetval=!1,this.ontopicchange=function(){},this.onnotification=function(){},e=this,void 0!==this.setOptions&&(this.options.setAll=d.setAll,this.setOptions(),delete this.options.setAll)}