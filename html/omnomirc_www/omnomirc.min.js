/**
 * @license
 * OmnomIRC COPYRIGHT 2010,2011 Netham45
 *                    2012-2017 Sorunome
 *
 *  This file is part of OmnomIRC.
 *
 *  OmnomIRC is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  OmnomIRC is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OmnomIRC.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";function OmnomIRC(){var e,t="",n=!1,o=function(e){return void 0!==document.URL.split(e+"=")[1]?document.URL.split(e+"=")[1].split("&")[0].split("#")[0]:""},s=function(t,n){if(void 0===n&&(n=!1),!n||"highlight"!=t.type){if(!n&&"highlight"!=t.type&&t.chan==a.get("chan")){var o=a.get("lines");o.push(t),o.length>200&&o.shift(),a.set("lines",o),-1!=["part","quit","join","nick"].indexOf(t.type)&&a.set("users",f.getUsers())}null!==t.name&&-1!=t.network&&(n||g.isNew(t.curline))?(g.setCurline(t.curline),!1!==e.onmessageraw?e.onmessageraw(t,n):S.addLine(t,n)):g.setCurline(t.curline)}},r=function(){var t={hostname:"",nick:"",signature:"",numHigh:4,uid:-1,net:"",networks:{},pmIdent:!1,guestLevel:0,isGuest:!0,identGuest:function(e,n,o,s){void 0===s&&(s=o,o=!1),console.log("trying login"),c.getJSON("misc.php?identName="+base64.encode(e)+"&nick="+base64.encode(e)+"&signature="+base64.encode(n)+"&id=-1&network="+t.net,function(n){n.success&&(o?(i.set("guestName",e),i.set("guestSig",n.signature)):(i.set("guestName",""),i.set("guestSig","")),t.setIdent(e,n.signature,-1),g.identify()),void 0!==s&&s(n)},!0,!1)},logout:function(){t.setIdent("","",-1),i.remove("guestName"),i.remove("guestSig"),a.remove("config"),a.remove("checkLogin"),g.identify()},login:function(e,n,o){void 0===o&&(o=-1),t.setIdent(e,n,o),g.identify()},fetch:function(n,s){var r=function(r){if(!s){try{sessionStorage.setItem("defaultNetwork",r.defaultNetwork)}catch(e){}a.set("config",r),t.hostname=r.hostname,h.setChans(r.channels),S.setSmileys(r.smileys),e.onsmileychange(r.smileys),S.setSpLinks(r.spLinks),t.guestLevel=r.guests,t.networks={},$.each(r.networks,function(e,n){t.networks[n.id]=n}),t.net=r.network,i.setPrefix(t.net),l.setDefaults(r.defaults),l.setExtraChanMsg(r.extraChanMsg),g.setData(r.websockets.use,r.websockets.host,r.websockets.port,r.websockets.ssl)}var u=a.get("checkLogin");if(u&&!s){t.nick=u.nick,t.signature=u.signature,t.uid=u.uid,t.pmIdent="["+t.net.toString()+","+t.uid.toString()+"]",t.isGuest=""===r.signature;var d=o("uid");return""!==d&&d!=t.uid?(a.remove("config"),a.remove("checkLogin"),void t.fetch(n,s)):void(void 0!==n&&n())}t.loggedIn()&&t.isGuest?t.identGuest(t.nick,function(e){e.success&&(t.signature=e.signature),void 0!==n&&n()}):c.getJSON(r.checkLoginUrl+"&network="+t.net.toString()+"&jsoncallback=?",function(e){a.set("checkLogin",{nick:e.nick,signature:e.signature,uid:e.uid}),t.nick=e.nick,t.signature=e.signature,t.uid=e.uid,t.pmIdent="["+t.net.toString()+","+t.uid.toString()+"]",t.isGuest=""===e.signature,void 0!==n&&n()},!0,!1)};if(void 0===s&&(s=!1),s&&t.loggedIn()&&t.isGuest)return console.log("i am silly"),void t.identGuest(t.nick,function(e){e.success&&(t.signature=e.signature),void 0!==n&&n()});if(!s){var u=a.get("config");if(u)return void r(u)}a.determinePrefix(),c.getJSON("config.php?js&network="+o("network")+(s?"&clonly":""),r,!0,!1)},setIdent:function(e,n,o){t.nick=e,t.signature=n,t.uid=o,a.set("checkLogin",{nick:e,signature:n,uid:o})},getUrlParams:function(){return"nick="+base64.encode(t.nick)+"&signature="+base64.encode(t.signature)+"&time="+(+new Date).toString()+"&id="+t.uid+"&network="+t.net+"&noLoginErrors"},getNetwork:function(e){return void 0!==t.networks[e]?t.networks[e]:{id:-1,normal:"NICK",userlist:"NICK",name:"Invalid network",type:-1}},getIdentParams:function(){return{nick:t.nick,signature:t.signature,time:(+new Date).toString(),id:t.uid,network:t.net}},loggedIn:function(){return""!==t.signature},getWholePmIdent:function(e,n){var o="["+n.toString()+","+e.toString()+"]";return n<t.net?o+t.pmIdent:t.net<n?t.pmIdent+o:e<t.uid?o+t.pmIdent:t.pmIdent+o}};return{identGuest:t.identGuest,fetch:t.fetch,getUrlParams:t.getUrlParams,getIdentParams:t.getIdentParams,getNetwork:t.getNetwork,nick:function(){return t.nick},net:function(){return t.net},loggedIn:t.loggedIn,guestLevel:function(){return t.guestLevel},getPmIdent:function(){return t.pmIdent},isGuest:function(){return t.isGuest},numHigh:function(){return t.numHigh},getWholePmIdent:t.getWholePmIdent,logout:t.logout,login:t.login}}(),i=function(){var e={prefix:o("network"),setPrefix:function(t){e.prefix=t?t.toString():""},getCookie:function(e){var t,n,o,s=document.cookie.split(";");for(t=0;t<s.length;t++)if(n=s[t].substr(0,s[t].indexOf("=")),o=s[t].substr(s[t].indexOf("=")+1),(n=n.replace(/^\s+|\s+$/g,""))==e)return unescape(o)},setCookie:function(e,t,n){var o=new Date,s=escape(t);o.setDate(o.getDate()+n),s+=null===n?"":"; expires="+o.toUTCString(),document.cookie=e+"="+s},haveSupport:null,support:function(){if(null===e.haveSupport)try{localStorage.setItem("test",1),e.haveSupport=1==localStorage.getItem("test"),localStorage.removeItem("test"),e.haveSupport=!0}catch(t){e.haveSupport=!1}return e.haveSupport},get:function(t){var n;t=e.prefix+t,n=e.support()?localStorage.getItem(t):e.getCookie(t);try{return JSON.parse(n)}catch(e){return}},set:function(t,n){t=e.prefix+t,n=JSON.stringify(n),e.support()?localStorage.setItem(t,n):e.setCookie(t,n)},remove:function(t,n){t=e.prefix+t,e.support()?localStorage.removeItem(t):e.setCookie(t,"",-1)}};return{setPrefix:e.setPrefix,get:e.get,set:e.set,remove:e.remove}}(),a=function(){var e={prefix:o("network"),setPrefix:function(t){t&&(e.prefix=t.toString())},determinePrefix:function(){e.haveSupport=null},haveSupport:null,support:function(){if(null===e.haveSupport)try{sessionStorage.setItem("test",1),e.haveSupport=1==sessionStorage.getItem("test"),sessionStorage.removeItem("test"),e.haveSupport&&""==e.prefix&&e.setPrefix(sessionStorage.getItem("defaultNetwork"))}catch(t){e.haveSupport=!1}return e.haveSupport},get:function(t){if(e.support())try{return JSON.parse(sessionStorage.getItem(e.prefix+t))}catch(e){return}},set:function(t,n){e.support()&&sessionStorage.setItem(e.prefix+t,JSON.stringify(n))},remove:function(t){e.support()&&sessionStorage.removeItem(e.prefix+t)}};return{determinePrefix:e.determinePrefix,get:e.get,set:e.set,remove:e.remove}}(),c=function(){var t={didRelog:!1,removeSig:function(e){try{var t=e.split("signature="),n=t[1].split("&");return n[0]="---",t[1]=n.join("&"),t.join("signature=")}catch(t){return-1!==e.indexOf("signature")?"omited due to security reasons":e}},addError:function(n,o){n=t.removeSig(n),e.onerror(n,o)},addWarning:function(n,o){n=t.removeSig(n),e.onwarning(n,o)},checkCallback:function(e,n,o,s){2!=e.relog&&(void 0!==e.errors&&$.map(e.errors,function(e){void 0!==e.type?t.addError(s,e):t.addError(s,{type:"misc",message:e})}),void 0!==e.warnings&&$.map(e.warnings,function(e){void 0!==e.type?t.addWarning(s,e):t.addWarning(s,{type:"misc",message:e})})),void 0!==e.relog&&0!=e.relog?1==e.relog?(r.fetch(void 0,!0),n(e)):2!=e.relog||t.didRelog?n(e):(t.didRelog=!0,r.fetch(function(){o()},!0)):(void 0!==e.relog&&(t.didRelog=!1),n(e))},getJSON:function(e,n,o,s){void 0==o&&(o=!0),void 0==s&&(s=!0),-1==e.indexOf("?")&&s&&(e+="?");var i=e+(s?"&"+r.getUrlParams():"");return $.ajax({url:i,dataType:"json",async:o}).done(function(r){t.checkCallback(r,n,function(){t.getJSON(e,n,o,s)},i)})},post:function(e,n,o,s,i){void 0==s&&(s=!0),void 0==i&&(i=!0),-1==e.indexOf("?")&&i&&(e+="?");var a=e+(i?"&"+r.getUrlParams():"");return $.ajax({type:"POST",url:a,async:s,data:n}).done(function(r){t.checkCallback(r,o,function(){t.post(e,n,o,s,i)},a)})}};return{getJSON:t.getJSON,post:t.post}}(),l=function(){var e={extraChanMsg:"",allOptions:{highBold:{disp:"Highlight Bold",default:!0},highRed:{disp:"Highlight Red",default:!0},colordNames:{disp:"Colored Names",default:0,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("colordNames",this.value)}).append($.map(["none","calc","server"],function(t,n){return $("<option>").attr(e.get("colordNames")==n?"selected":"false","selected").val(n).text(t)})))}},curChan:{hidden:!0,default:0},extraChans:{disp:"Show extra Channels",default:!1,before:function(){return""!==e.extraChanMsg&&alert(e.extraChanMsg),!0}},ding:{disp:"Ding on Highlight",default:!1},smileys:{disp:"Show Smileys",default:!0},charsHigh:{disp:"Number chars for Highlighting",default:4,handler:function(){return $("<td>").attr("colspan",2).css("border-right","none").append($("<select>").change(function(){e.set("charsHigh",this.value)}).append($.map([1,2,3,4,5,6,7,8,9,10],function(t){return $("<option>").attr(e.get("charsHigh")==t?"selected":"false","selected").val(t).text(t)})))}},oircJoinPart:{disp:"Show OmnomIRC join/part messages",default:!1},textDeco:{disp:"Enable simple text decorations",default:!1},statusBar:{disp:"Show Updates in Browser Status Bar",default:!0},browserNotifications:{disp:"Browser Notifications",default:!1,before:function(){return C.request(),!1}},wysiwyg:{disp:"Use WYSIWYG editor",default:!1}},set:function(t,n){if(void 0!==e.allOptions[t]){e.allOptions[t].value=n;var o=i.get("options")||{};o[t]=n,i.set("options",o)}},get:function(t){if(void 0!==e.allOptions[t])return e.allOptions[t].value},setExtraChanMsg:function(t){e.extraChanMsg=t},setDefaults:function(t){var n=i.get("options");$.each(e.allOptions,function(o,s){var r=s.default;n&&void 0!==n[o]?r=n[o]:t&&void 0!==t[o]&&(r=t[o]),e.allOptions[o].value=r})},getAll:function(t){if(t)return e.allOptions;var n={};return $.each(e.allOptions,function(e,t){void 0!==t.hidden&&t.hidden||(n[e]=t.value)}),n},setAll:function(t){e.allOptions=t}};return{set:e.set,get:e.get,setDefaults:e.setDefaults,setExtraChanMsg:e.setExtraChanMsg,getAll:e.getAll,setAll:e.setAll}}(),d=function(){var e={id:Math.random().toString(36)+(new Date).getTime().toString(),update:function(){i.set("browserTab",e.id),i.set("newInstant",!1)},init:function(){i.set("browserTab",e.id),$(window).focus(function(){e.update()}).unload(function(){e.kill()})},current:function(){return i.get("newInstant")&&e.update(),e.id==i.get("browserTab")},kill:function(){i.set("newInstant",!0),$(window).off("focus").off("unload")}};return{init:e.init,current:e.current,kill:e.kill}}(),g=function(){var e={ws:{socket:!1,connected:!1,use:!0,sendBuffer:[],allowLines:!1,enabled:!1,host:"",port:0,ssl:!0,tryFallback:!0,didRelog:!1,fallback:function(){if(console.log("trying fallback..."),e.ws.tryFallback){try{e.ws.tryFallback=!1,e.ws.socket.close()}catch(e){}e.ws.use=!1,e.old.lastSuccess=(new Date).getTime(),e.old.start()}},identify:function(){e.ws.send($.extend({action:"ident"},r.getIdentParams())),e.ws.send({action:"charsHigh",chars:l.get("charsHigh")})},init:function(){if(!("WebSocket"in window&&e.ws.enabled))return e.ws.use=!1,!1;try{var t=window.location.pathname.split("/");t.pop(),t.length>1&&""===t[t.length-1]&&t.pop(),t.push("ws"),t.push(r.net()),e.ws.socket=new PooledWebSocket((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+t.join("/"))}catch(n){return console.log(e.ws.socket),console.log((e.ws.ssl?"wss://":"ws://")+e.ws.host+":"+e.ws.port.toString()+t.join("/")),console.log(n),void e.ws.fallback()}return e.ws.socket.onopen=function(t){e.ws.connected=!0;for(var n=0;n<e.ws.sendBuffer.length;n++)e.ws.send(e.ws.sendBuffer[n]);e.ws.sendBuffer=[]},e.ws.socket.onmessage=function(t){try{var n=JSON.parse(t.data);console.log(n),e.ws.allowLines&&(void 0!==n.line&&(s(n.line)&&(e.ws.tryFallback=!1,delete e.ws.socket),console.log("Added line!")),void 0!==n.users&&f.setUsers(n.users)),void 0!==n.relog&&0!=n.relog&&n.relog<3&&(e.ws.didRelog||(e.ws.didRelog=!0,r.fetch(function(){r.loggedIn()&&(e.ws.identify(),e.ws.didRelog=!1)},!0)))}catch(t){console.log("ERROR!"),console.log(t)}},e.ws.socket.onclose=function(t){console.log("CLOOOOOOOOOSE"),console.log(t),e.ws.use=!1,e.ws.fallback()},e.ws.socket.onerror=function(t){console.log("ERRRORRRR"),console.log(t),delete e.ws.socket,e.ws.use=!1,e.ws.fallback()},e.ws.identify(),$(window).on("beforeunload",function(){e.partChan(h.current().handler),delete e.ws.socket}),!0},send:function(t){e.ws.connected?e.ws.socket.send(JSON.stringify(t)):e.ws.sendBuffer.push(t)}},old:{inRequest:!1,handler:!1,lastSuccess:(new Date).getTime(),fnCallback:void 0,chan:"",sendRequest:function(){e.old.chan&&(e.old.handler=c.getJSON("Update.php?high="+l.get("charsHigh").toString()+"&channel="+e.old.chan+"&lineNum="+e.curline.toString(),function(t){e.old.handler=!1,e.old.lastSuccess=(new Date).getTime(),void 0!==t.lines&&$.map(t.lines,function(e){s(e)}),void 0!=t.errors&&t.errors.length>=1||!0!==t.banned&&e.old.setTimer()}).fail(function(){if(e.old.handler=!1,void 0!=e.fnCallback)return e.fnCallback(),void(e.fnCallback=void 0);(new Date).getTime()>=e.old.lastSuccess+3e5?m.internal('<span style="color:#C73232;">OmnomIRC has lost connection to server. Please refresh to reconnect.</span>'):e.old.inRequest?e.old.setTimer():e.old.lastSuccess=(new Date).getTime()}))},setTimer:function(){e.old.inRequest&&h.current().loaded&&!1===e.old.handler?setTimeout(function(){e.old.sendRequest()},x.isBlurred()?2500:200):e.old.stop()},start:function(){e.old.inRequest||(e.old.inRequest=!0,e.old.setTimer())},stop:function(t){e.old.inRequest?(e.old.inRequest=!1,e.old.handler?(e.fnCallback=t,e.old.handler.abort()):void 0!==t&&t()):void 0!==t&&t()},send:function(e,t,n){c.getJSON("message.php?message="+base64.encode(e)+"&channel="+t,function(e){void 0!==n&&n(e)})}},curline:0,joinChan:function(t){e.ws.use&&e.ws.send({action:"joinchan",chan:t}),parseInt(t,10)!=t&&(t=base64.encode(t)),e.old.chan=t},partChan:function(t){e.ws.use&&e.ws.send({action:"partchan",chan:t})},stop:function(t){e.ws.use?(e.ws.allowLines=!1,t()):e.old.stop(t)},kill:function(){e.ws.use?(e.ws.socket.onclose=function(){},e.ws.socket.close()):e.old.stop()},start:function(){e.ws.use?e.ws.allowLines=!0:e.old.start()},setCurline:function(t){console.log("Curline: "+t),t>e.curline&&(e.curline=t)},send:function(t,n,o){e.ws.use?(e.ws.send({action:"message",channel:n,message:t}),void 0!==o&&o()):(parseInt(n,10)!=n&&(n=base64.encode(n)),e.old.send(t,n,o))},setData:function(t,n,o,s){e.ws.enabled=t,e.ws.host=n,e.ws.port=o,e.ws.ssl=s},init:function(){e.ws.enabled?e.ws.init():(e.ws.use=!1,e.old.lastSuccess=(new Date).getTime())},identify:function(){e.ws.enabled&&e.ws.identify()},postfetch:function(){e.ws.use&&e.ws.send({action:"postfetch",channel:h.current().handler,curline:e.curline})},isNew:function(t){return 0==t||t>e.curline}};return{joinChan:e.joinChan,partChan:e.partChan,start:e.start,stop:e.stop,kill:e.kill,setCurline:e.setCurline,send:e.send,setData:e.setData,init:e.init,identify:e.identify,postfetch:e.postfetch,isNew:e.isNew}}(),h=function(){var t=function(t){var o=void 0!==n.chans[t],r={i:t,name:o?n.chans[t].chan.toLowerCase():"",handler:o?n.getHandler(t):-1,handlerB64:o?n.getHandler(t,!0):-1,loaded:!1,load:function(e){return void 0===e.lines?(e.message?m.internal(e.message):m.internal('<span style="color:#C73232;"><b>ERROR:</b> couldn\'t join channel</span>'),!1):(l.set("curChan",t),e.banned?(m.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),!1):(f.setUsers(e.users),$.each(e.lines,function(e,t){s(t,!0)}),r.loaded=!0,!0))},unload:function(){r.loaded&&g.partChan(r.handler)},part:function(){n.part(n.i)},reloadUserlist:function(){o&&c.getJSON("Load.php?userlist&channel="+r.handlerB64,function(e){e.banned?m.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'):e.users&&f.setUsers(e.users)})},reload:function(){e.onchanneljoin(r.name)},setI:function(e){r.i=e},is:function(e){return e==r.i}};return{name:r.name,handler:r.handler,handlerB64:r.handlerB64,load:r.load,part:r.part,reload:r.reload,unload:r.unload,loaded:function(){return r.loaded},setI:r.setI,is:r.is,reloadUserlist:r.reloadUserlist}},n={current:!1,chans:[],save:function(){i.set("channels",n.chans)},loadSettings:function(){try{var t=i.get("channels"),o=$.map(n.chans,function(e){if(e.ex&&l.get("extraChans")||!e.ex)return e}),s=[];null!==t&&t!=[]&&(n.chans=$.merge($.map(t,function(e){if(-1!=e.id&&"*"!=e.id.toString().substr(0,1)){var t=!1;if($.each(n.chans,function(n,o){if(o.id==e.id)return s.push(e),t=!0,e.chan=o.chan,!1}),!t)return}return e}),$.map(o,function(e){var t=!1;if($.each(s,function(n,o){if(o.id==e.id)return t=!0,e.chan=o.chan,!1}),!t)return e})),save())}catch(e){}e.onchannelchange(n.chans)},init:function(){n.current=t(-1),n.loadSettings()},addChan:function(t,o){var s=!0;return void 0===o&&(o=-1),t=t.toLowerCase(),$.each(n.chans,function(e,n){n.chan==t&&(s=e)}),!0===s?"#"==t[0]?(m.internal('<span style="color:#C73232;">Join Error: Cannot join new channels starting with #.</span>'),-1):(n.chans.push({chan:t,high:!1,ex:!1,id:o,order:-1}),n.save(),e.onchannelchange(n.chans),n.chans.length-1):s},getHandler:function(e,t){return-1!=n.chans[e].id?"number"!=typeof n.chans[e].id&&t?base64.encode(n.chans[e].id):n.chans[e].id.toString():t?base64.encode(n.chans[e].chan):n.chans[e].chan},requestHandler:!1,load:function(e,o){console.log("loading channel");var s=function(t){if(n.current.load(t))return n.chans[e].high=!1,n.save(),g.joinChan(n.getHandler(e)),g.start(),w.load(),v.read(),g.postfetch(),void o(!0,t);o(!1,{})};void 0===o&&(o=function(){}),void 0!==n.chans[e]?g.stop(function(){if(!1!==n.requestHandler&&n.requestHandler.abort(),a.get("chan")==n.getHandler(e)){l.set("curChan",e),n.current=t(e);for(var o={},r=["chan","banned","admin","users","ignores","lines"],i=0;i<r.length;i++)o[r[i]]=a.get(r[i]);return console.log(o),void s(o)}n.requestHandler=c.getJSON("Load.php?count=125&channel="+n.getHandler(e,!0),function(o){l.set("curChan",e),n.current=t(e),a.set("chan",n.current.handler),a.set("banned",o.banned),a.set("admin",o.admin),a.set("users",o.users),a.set("ignores",o.ignores),a.set("lines",o.lines),s(o)})}):o(!1,{})},join:function(e){return(e=e.trim())?("@"!=e[0]&&"#"!=e[0]&&(e="@"+e),n.addChan(e)):-1},joinPm:function(e,t,o){void 0===o&&(o=function(){});var s=function(t,s){"*"!=(t=t.trim()).substr(0,1)&&(t="*"+e),"*"!=(s=s.trim()).substr(0,1)&&(s="*"+s),o(n.addChan(t,s))};if(""==t){if("@"==e.substr(0,1)||"#"==e.substr(0,1))return m.internal('<span style="color:#C73232;">Query Error: Cannot query a channel. Use /join instead.</span>'),void o(-1);c.getJSON("misc.php?openpm="+base64.encode(e),function(e){e.channick?s(e.channick,e.chanid):(m.internal('<span style="color:#C73232;">Query Error: User not found.</span>'),o(-1))})}else s(e,t)},part:function(t){if(parseInt(t,10)==t&&(t=parseInt(t,10)),"number"!=typeof t&&(t&&"@"!=t[0]&&"#"!=t[0]&&"*"!=t[0]&&(t="@"+t),$.each(n.chans,function(e,n){if(n.chan==t)return t=e,!1})),"number"!=typeof t||void 0===n.chans[t])return m.internal('<span style="color:#C73232;"> Part Error: can\'t part '+t+". (You are not in it.)</span>"),!1;if("#"==n.chans[t].chan[0])return m.internal('<span style="color:#C73232;"> Part Error: can\'t part '+n.chans[t].chan+". (IRC channel.)</span>"),!1;var o=n.chans[t].chanId,s=!1;return n.current.is(t)&&(s=!0),-1==o&&(o=n.chans[t]),g.partChan(n.getHandler(t)),n.chans.splice(t,1),n.save(),e.onchannelchange(n.chans),s&&e.onchanneljoin(n.chans[t-1].chan),!0},getList:function(){return n.chans},setChans:function(t){n.chans=t,n.current&&(n.save(),e.onchannelchange(n.chans))},getNames:function(){return $.map(n.chans,function(e){return e.chan})},highlight:function(t){$.each(n.chans,function(e,o){if(t==o.id||o.chan.toLowerCase()==t.toString().toLowerCase())return n.chans[e].high=!0,!1}),n.save(),e.onchannelchange(n.chans)}};return{init:n.init,load:n.load,join:n.join,joinPm:n.joinPm,part:n.part,getList:n.getList,getHandler:n.getHandler,current:function(){return n.current},setChans:n.setChans,getNames:n.getNames,highlight:n.highlight}}(),f=function(){var t={users:[],draw:function(){t.users.sort(function(e,t){var n=e.nick.toLowerCase(),o=t.nick.toLowerCase();return n==o?e==t?0:e<t?-1:1:n<o?-1:1}),e.onuserchange(t.users)},exists:function(e){var n=!1;return $.each(t.users,function(e,t){if(t.nick.toLowerCase()==u.nick.toLowerCase()&&t.network==u.network)return n=!0,!1}),n},add:function(e){if(""!==h.current().handler){var n=!0;$.each(t.users,function(t,o){if(o.nick==e.nick&&o.network==e.network)return n=!1,!1}),n&&(t.users.push(e),t.draw())}},remove:function(e){""!==h.current().handler&&($.each(t.users,function(n,o){if(o.nick==e.nick&&o.network==e.network)return t.users.splice(n,1),!1}),t.draw())},setUsers:function(e){t.users=e,a.set("users",t.users),t.draw()},getNames:function(){return $.map(t.users,function(e){return e.nick})}};return{add:t.add,remove:t.remove,setUsers:t.setUsers,getNames:t.getNames,getUsers:function(e){return t.users}}}(),p={parse:{parse:function(t){var n=t.split(" ")[0].toLowerCase(),o=t.substr(n.length+1).toLowerCase().trim();switch(n){case"j":case"join":return r.isGuest()?m.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t join as guest</span>'):e.onchanneljoin(o),!0;case"q":case"query":return r.isGuest()?m.internal('<span style="color:#C73232;"><b>ERROR:</b> can\'t query as guest</span>'):e.onchanneljoin("*"+o),!0;case"win":case"w":case"window":var s=h.getList()[parseInt(o,10)];return void 0!==s&&e.onchanneljoin(s.chan),!0;case"p":case"part":return""!==o?e.onchannelpart(o):e.onchannelpart(h.current().name),!0;case"help":return m.internal('<span style="color:#2A8C2A;">Commands: me, ignore, unignore, ignorelist, join, part, query, msg, window</span>'),m.internal('<span style="color:#2A8C2A;">For full help go here: <a href="http://ourl.ca/19926" target="_top">http://ourl.ca/19926</a></span>'),!0;case"ponies":return $.getScript("https://juju2143.ca/mousefly.js",function(){Derpy()}),!0;case"minty":return $.getJSON("https://omnomirc.omnimaga.org/minty.php").done(function(e){m.internal('<span style="font-size:5px;line-height:0;font-family:monospace;">'+e.minty+"</span>")}),!0;default:return!1}}}.parse},m=function(){var t={sending:!1,send_real:function(e,n,o,r){r&&e(),t.sending?setTimeout(function(){r?t.send_real(function(){},n,o,r):t.send_real(e,n,o,r)},1e3):(t.sending=!0,g.send(n,o,function(n){void 0!==n&&void 0!==n.lines&&$.map(n.lines,function(e){s(e)}),t.sending=!1,t.val(""),r||e()}))},send:function(e,n,o){var s=!0;"string"==typeof e&&(n=e,e=void 0),void 0===e&&(e=function(){}),"boolean"==typeof n&&(s=n,n=void 0),void 0===n&&(n=m.val()),n?(v.add(n),""!==n&&l.get("textDeco")&&(">"==n[0]&&(n="3"+n),n=n.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),void 0===o&&(o=h.current().handler),"/"==n[0]&&p.parse(n.substr(1))?(t.val(""),e()):t.send_real(e,n,o,s)):e()},internal:function(e){s({curline:0,type:"internal",time:Math.floor((new Date).getTime()/1e3),name:"",message:e,name2:"",chan:h.current().handler})},val:function(t){if(void 0===t)return!1===e.ongetval?n.is("input")?n.val():n.text():e.ongetval();!1===e.onsetval?n.is("input")?n.val(t):n.text(t):e.onsetval(t)}};return{internal:t.internal,send:t.send,val:t.val}}(),w=function(){var e={tabWord:"",tabCount:0,isInTab:!1,startPos:0,startChar:"",endPos:0,endChar:"",endPos0:0,tabAppendStr:"",searchArray:[],node:!1,wysiwyg:!1,getCurrentWord:function(){var t=e.wysiwyg?(e.node=window.getSelection().anchorNode).nodeValue:n[0].value;if(e.isInTab)return e.tabWord;for(e.startPos=e.wysiwyg?window.getSelection().anchorOffset:n[0].selectionStart,e.startChar=t.charAt(e.startPos);" "!=e.startChar&&--e.startPos>0;)e.startChar=t.charAt(e.startPos);for(" "==e.startChar&&e.startPos++,e.endPos=e.wysiwyg?window.getSelection().anchorOffset:n[0].selectionStart,e.endChar=t.charAt(e.endPos);" "!=e.endChar&&++e.endPos<=t.length;)e.endChar=t.charAt(e.endPos);return e.endPos0=e.endPos,e.tabWord=t.substr(e.startPos,e.endPos-e.startPos).trim(),e.tabWord},getTabComplete:function(){var t,o=e.wysiwyg?e.node.nodeValue:n[0].value;null!==o&&(t=e.search(e.getCurrentWord(),e.tabCount),e.isInTab||(e.tabAppendStr=" ",0===e.startPos&&(e.tabAppendStr=": ")),t==e.getCurrentWord()&&(e.tabCount=0,t=e.search(e.getCurrentWord(),e.tabCount)),o=o.substr(0,e.startPos)+t+e.tabAppendStr+o.substr(e.endPos+1),e.wysiwyg?(window.getSelection().anchorNode.nodeValue=o,window.getSelection().getRangeAt(0).setEnd(e.node,e.startPos+t.length+e.tabAppendStr.length),window.getSelection().getRangeAt(0).setStart(e.node,e.startPos+t.length+e.tabAppendStr.length)):n[0].value=o,e.endPos=e.endPos0+t.length+e.tabAppendStr.length)},search:function(t,n){var o=!1;return n||(n=0),$.each(e.searchArray,function(e,s){0===s.toLowerCase().indexOf(t.toLowerCase())&&n--<=0&&!1===o&&(o=s)}),!1!==o?o:t},init:function(){e.wysiwyg=!n.is("input"),n.keydown(function(t){9==t.keyCode?t.ctrlKey||(t.preventDefault(),e.getTabComplete(),e.isInTab=!0,e.tabCount++,setTimeout(1,1)):(e.tabWord="",e.tabCount=0,e.isInTab=!1)})},load:function(){e.searchArray=$.merge(f.getNames(),h.getNames())}};return{init:e.init,load:e.load}}(),v=function(){var t={messages:[],counter:0,current:"",init:function(){n.keydown(function(e){38!=e.keyCode&&40!=e.keyCode||(e.preventDefault(),t.counter==t.messages.length&&(t.current=m.val()),0!==t.messages.length&&(38==e.keyCode?(0!==t.counter&&t.counter--,m.val(t.messages[t.counter])):(t.counter!=t.messages.length&&t.counter++,t.counter==t.messages.length?m.val(t.current):m.val(t.messages[t.counter]))))})},add:function(n){t.messages.push(n),t.messages.length>20&&t.messages.shift(),t.counter=t.messages.length,e.ls.set("oldMessages-"+e.channels.current().handlerB64,t.messages)},read:function(){t.messages=e.ls.get("oldMessages-"+e.channels.current().handlerB64),t.messages||(t.messages=[]),console.log(t.messages),t.counter=t.messages.length}};return{init:t.init,add:t.add,read:t.read}}(),k=function(){var o={menuOpen:!1,msgVal:"",$textDecoForm:!1,hideMenu:function(){o.$textDecoForm.css("display","none"),o.menuOpen=!1},reverseParse:function(e){if(-1===e.indexOf("<"))return $("<span>").html(e).text();var t=!1,n=!1,o=!1,s="-1",r="-1";return e=e.replace(/<img([^>]*?)>/gi,function(e,t){var n=t.match(/data-code="([^"]*)"/);return n?n[1]:""}),e=e.replace(/<span([^>]*?)>([^<]*?)<\/span>/gi,function(i,a,c){if(!a)return c;e="",-1==a.indexOf("bold")==t&&(t=!t,e+=""),-1==a.indexOf("italic")==n&&(n=!n,e+=""),-1==a.indexOf("underline")==o&&(o=!o,e+="");var l=a.match(/fg-(\d+)/),u=a.match(/bg-(\d+)/);return l||(l="-1"),u||(u="-1"),u==r&&l==s||(("-1"!=s&&"-1"==l||"-1"!=r&&"-1"==u)&&(e="",t&&(e+=""),n&&(e+=""),o&&(e+="")),e+="","-1"!=(s=l)&&(e+=s),"-1"!=(r=u)&&(e+=","+r)),e+c}),$("<span>").html(e).text()},getCaretCharacterOffsetWithin:function(e){var t=window.getSelection();if(t.rangeCount>0){var n,o=t.getRangeAt(0),s=o.cloneRange(),r=0,i=document.createRange();s.selectNodeContents(e),s.setEnd(o.endContainer,o.endOffset),n=s.commonAncestorContainer.getElementsByTagName("img");for(var a=0;a<n.length;a++){var c=n[a];c.dataset.code&&(i.selectNode(c),1!=s.compareBoundaryPoints(Range.START_TO_START,i)&&-1!=s.compareBoundaryPoints(Range.END_TO_END,i)&&(r+=c.dataset.code.length))}return s.toString().length+r}return 0},getWholeSelection:function(e){var t,n=window.getSelection(),s=n.getRangeAt(0),r=s.cloneRange(),i=o.getCaretCharacterOffsetWithin(e);return s.collapse(!0),n.removeAllRanges(),n.addRange(s),t=o.getCaretCharacterOffsetWithin(e),n.removeAllRanges(),n.addRange(r),[t,i]},setCaretCharacterOffsetWithin:function(e,t,n,s,r){void 0===n&&(n=0),void 0===s&&(s=document.createRange()),void 0===r&&(r=!1);for(var i=0;i<e.childNodes.length;i++){var a=e.childNodes[i];if(3==a.nodeType){if(a.length>=t){c=window.getSelection();if(r||(s.setStart(a,t),r=!0,t+=n),r&&a.length>=t)return s.setEnd(a,t),c.removeAllRanges(),c.addRange(s),-1}t-=a.length}else if(1==a.nodeType){if("IMG"==a.tagName&&a.dataset.code){if(a.dataset.code.length>=t){var c=window.getSelection();if(r||(s.setStartAfter(a),r=!0,t+=n),r&&a.dataset.code.length>=t)return s.setEndAfter(a),c.removeAllRanges(),c.addRange(s),-1}t-=a.dataset.code.length}else if((t=o.setCaretCharacterOffsetWithin(a,t,n,s,r))<0)return-1}else if((t=o.setCaretCharacterOffsetWithin(a,t,n,s,r))<0)return-1}return t},surroundSelection:function(e,t){var n=window.getSelection();if(n.rangeCount>0){var o=n.getRangeAt(0),s=o.startContainer,r=o.startOffset,i=document.createTextNode(e),a=document.createTextNode(t),c=o.cloneRange();c.collapse(!1),c.insertNode(a),c.setStart(s,r),c.collapse(!0),c.insertNode(i),o.setStartAfter(i),o.setEndBefore(a),n.removeAllRanges(),n.addRange(o)}},updateContent:function(e,t){void 0===e&&(e=t=o.getCaretCharacterOffsetWithin(n[0])),o.msgVal=o.reverseParse(n.html()),n.html(S.parse(o.msgVal)),o.setCaretCharacterOffsetWithin(n[0],e,t-e)},init:function(){if(o.support()){var s=n.attr("id"),r=$("<span>").attr({contenteditable:"true",accesskey:"i",id:s}).css({display:"inline-block",height:"1em",padding:"0.3em 0.2em 0.2em 0.3em",fontSize:"1.2em",verticalAlign:"top",whiteSpace:"nowrap",backgroundColor:n.css("backgroundColor")});for(var i in["Top","Bottom","Left","Right"])for(var a in["Style","Width","Color"])r.css("border"+i+a,n.css("border"+i+a));n.replaceWith(r),(n=r).on("update",o.updateContent),o.$textDecoForm=$("<div>").css({position:"absolute",bottom:"3em"}).attr("id",t+"textDecoForm").append($("<button>").css("font-weight","bold").text("B").click(function(e){e.preventDefault();var t=o.getWholeSelection(n[0]);o.surroundSelection("",""),o.updateContent(t[0],t[1])}),"&nbsp;",$("<button>").css("font-style","italic").text("I").click(function(e){e.preventDefault();var t=o.getWholeSelection(n[0]);o.surroundSelection("",""),o.updateContent(t[0],t[1])}),"&nbsp;",$("<button>").css("text-decoration","underline").text("U").click(function(e){e.preventDefault();var t=o.getWholeSelection(n[0]);o.surroundSelection("",""),o.updateContent(t[0],t[1])}),"<br>",$.map([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],function(e){return[e%4==0?"<br>":"",$("<span>").css({display:"inline-block",height:"1em",width:"2em"}).addClass(t+"colorbutton").addClass(t+"bg-"+e).click(function(t){t.preventDefault();var s=o.getWholeSelection(n[0]);o.surroundSelection(""+e,""),o.updateContent(s[0],s[1])})]})).hide().insertBefore(n),e.onsetval=function(e){o.msgVal=e,n.html(S.parse(e))},e.ongetval=function(){return o.msgVal},n.on("input",function(e){o.updateContent()}),n.mouseup(function(e){window.getSelection().isCollapsed||(e.preventDefault(),o.$textDecoForm.show().css("left",Math.max(e.pageX-52,0)),o.menuOpen=!0)}),$(document).mousedown(function(e){!$(e.target).closest(o.$textDecoForm).length&&o.menuOpen&&o.hideMenu()})}},support:function(){return"contentEditable"in document.documentElement&&l.get("wysiwyg")}};return{init:o.init,getMsg:o.getMsg,support:o.support,updateContent:o.updateContent}}(),b=function(){var e={text:"",started:!1,start:function(){l.get("statusBar")?e.started||(setInterval(function(){if(window.status=e.text,parent)try{parent.window.status=e.text}catch(e){}},500),e.started=!0):e.started=!0},set:function(t){e.text=t,e.started||e.start()}};return{set:e.set}}(),C=function(){var t={support_webkit:void 0!==window.webkitNotifications&&null!==window.webkitNotifications&&window.webkitNotifications,support:function(){return"undefined"!=typeof Notification&&Notification&&"denied"!=Notification.permission},show:function(e){var n;t.support_webkit?(n=window.webkitNotifications.createNotification("omni.png","OmnomIRC Highlight",e)).show():t.support()&&((n=new Notification("OmnomIRC Highlight",{icon:"omni.png",body:e})).onshow=function(){setTimeout(n.close,3e4)})},request:function(){t.support_webkit?window.webkitNotifications.requestPermission(function(){0===window.webkitNotifications.checkPermission()&&(t.show("Notifications Enabled!"),e.options.set("browserNotifications",!0),document.location.reload())}):t.support()?Notification.requestPermission(function(n){Notification.permission!==n&&(Notification.permission=n),"granted"===n&&(t.show("Notifications Enabled!"),e.options.set("browserNotifications",!0),document.location.reload())}):alert("Your browser doesn't support notifications")},sound:!1,make:function(n,o){var s=d.current();s&&(l.get("browserNotifications")&&t.show(n),l.get("ding")&&t.sound&&t.sound.play()),t.startFlash(),e.onnotification(n,o,s)},doFlash:!1,intervalHandler:!1,originalTitle:"",target:top.postMessage?top:top.document.postMessage?top.document:void 0,startFlash:function(){if(!t.doFlash)if(t.doFlash=!0,top==window){var e=!1;t.originalTitle=document.title,t.intervalHandler=setInterval(function(){document.title=(e?"[ @] ":"[@ ] ")+t.originalTitle,e=!e},500)}else void 0!==t.target&&t.target.postMessage("startFlash","*")},stopFlash:function(n){void 0===n&&(n=!1),t.doFlash&&(top==window?t.intervalHandler&&(clearInterval(t.intervalHandler),t.intervalHandler=!1,document.title=t.originalTitle):void 0!==t.target&&t.target.postMessage("stopFlash","*"),t.doFlash=!1,n||e.ls.set("stopFlash",Math.random().toString(36)+(new Date).getTime().toString()))},init:function(){$(window).on("storage",function(e){e.originalEvent.key==r.net()+"stopFlash"&&t.stopFlash(!0)}).unload(function(){t.stopFlash(!0)}).focus(function(){t.stopFlash()}),t.sound||(t.sound=new Audio("beep.mp3"))}};return{request:t.request,make:t.make,init:t.init}}(),S=function(){var n={smileys_a:[],cacheServerNicks:{},spLinks:[],name:function(e,o,s){void 0===s&&(s=-1),e="\0"==e?"":e;var i=encodeURIComponent(e),u=[19,20,22,24,25,26,27,28,29],d=0,g=0,h=e=$("<span>").text(e).html(),f=r.getNetwork(o),p=!0;switch(l.get("colordNames")){case"1":for(;e[g];)d+=e.charCodeAt(g++);h=$("<span>").append($("<span>").addClass(t+"uName-"+u[d%9].toString()).html(e)).html();break;case"2":void 0!==f&&void 0!==f.checkLogin&&-1!=s?(h=a.get("nick"+o.toString()+":"+s.toString()))||(p=!1,void 0===n.cacheServerNicks[o.toString()+":"+s.toString()]&&c.getJSON(f.checkLogin+"?c="+s.toString(10)+"&n="+i,function(e){n.cacheServerNicks[o.toString()+":"+s.toString()]=e.nick},!1,!1),h=n.cacheServerNicks[o.toString()+":"+s.toString()],a.set("nick"+o.toString()+":"+s.toString(),h)):h=e;break;default:h=e}return void 0!==f&&p&&(h=f.normal.split("NICKENCODE").join(i).split("NICK").join(h).split("USERID").join(s.toString(10))),void 0!==f?'<span title="'+f.name+'">'+h+"</span>":'<span title="Unknown Network">'+h+"</span>"},smileys:function(e){return e?/^[\w\s\d\.,!?]*$/.test(e)?e:($.each(n.smileys_a,function(t,n){e=e.replace(RegExp(n.regex,"g"),n.replace)}),e):""},links:function(e){if(!e||null===e||void 0===e)return"";var t='[^\\s<"]';return e=e.replace(RegExp("(|)","g"),""),$.map(n.spLinks,function(n){n=n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=e.replace(RegExp("(^|[\\s>])((?:(?:f|ht)tps?://(?:www\\.)?)"+n+t+"*)","g"),"$1$2").replace(RegExp("(^|[\\s>])("+n+t+"*)","g"),"$1$2")}),e.replace(RegExp('(^|[^a-zA-Z0-9_"])((?:(?:f|ht)tps?://)'+t+"+)","g"),'$1<a target="_blank" href="$2">$2</a>').replace(RegExp("(^|[^a-zA-Z0-9_/])(www\\."+t+"+)","g"),'$1<a target="_blank" href="http://$2">$2</a>').replace(RegExp("(^|.)("+t+"+)","g"),'$1<a target="_top" href="$2">$2</a>').replace(RegExp("(^|.)("+t+"+)","g"),'$1<a target="_top" href="http://$2">$2</a>')},colors:function(e){var n,o,s,r=[],i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};if(!e)return"";for(r=e.split(RegExp("([])")),e="<span>",o=0;o<r.length;o++){switch(s=!0,r[o]){case"":(n=r[o+1].replace(/^([0-9]{1,2}),([0-9]{1,2})(.*)/,"$1:$2"))==r[o+1]?(n=r[o+1].replace(/^([0-9]{1,2}).*/,"$1:"))!=r[o+1]?(i.fg=n.split(":")[0],r[o+1]=r[o+1].substr(n.length-1)):(i.fg="-1",i.bg="-1"):(i.fg=n.split(":")[0],i.bg=n.split(":")[1],n==r[o+1]?r[o+1]="":r[o+1]=r[o+1].substr(n.length));break;case"":i.bold=!i.bold;break;case"":i.italic=!i.italic;break;case"":n=i.fg,i.fg=i.bg,i.bg=n,"-1"==i.fg&&(i.fg="0"),"-1"==i.bg&&(i.bg="1");break;case"":i.underline=!i.underline;break;case"":i={fg:"-1",bg:"-1",underline:!1,bold:!1,italic:!1};break;default:s=!1}e+=s?'</span><span class="'+t+"fg-"+i.fg+" "+t+"bg-"+i.bg+'" style="'+(i.bold?"font-weight:bold;":"")+(i.underline?"text-decoration:underline;":"")+(i.italic?"font-style:italic;":"")+'">':r[o]}return e+="</span>",e=e.replace(/(\x03|\x02|\x1F|\x09|\x0F)/g,"")},highlight:function(e){var t="";return l.get("highRed")||(t+="background:none;padding:none;border:none;"),l.get("highBold")&&(t+="font-weight:bold;"),'<span class="highlight" style="'+t+'">'+e+"</span>"},parse:function(e,t){return void 0!=t&&t||(t=!1),e="\0"==e?"":e,e=$("<span>").text(e).html(),l.get("smileys")&&!1===t&&(e=n.smileys(e)),e=n.colors(e),e=n.links(e)},setSmileys:function(e){n.smileys_a=[],$.each(e,function(e,t){n.smileys_a.push({regex:t.regex,replace:t.replace.split("ADDSTUFF").join('data-code="'+t.code+'"').split("PIC").join(t.pic).split("ALT").join(t.alt)})})},setSpLinks:function(e){n.spLinks=e},parseTextDecorations:function(e){return""!==e&&l.get("textDeco")&&(">"==e[0]&&(e="3"+e),e=e.replace(/((^|\s)\*[^\*]+\*($|\s))/g,"$1").replace(/((^|\s)\/[^\/]+\/($|\s))/g,"$1").replace(/((^|\s)_[^_]+_($|\s))/g,"$1")),e},addLine:function(t,o){if(o||"highlight"==t.type||t.chan.toString().toLowerCase()==h.current().handler.toLowerCase()||t.name2===r.getPmIdent()){var s=n.name(t.name,t.network,t.uid),i=n.parse(t.message),a="*",c=i;switch(""!=r.nick()&&["message","action","pm","pmaction"].indexOf(t.type)>=0&&"*"!=t.name.toLowerCase()&&i.toLowerCase().indexOf(r.nick().toLowerCase().substr(0,l.get("charsHigh")))>=0&&(c=i=S.highlight(i),!o&&x.isBlurred()&&C.make("("+h.current().name+") <"+t.name+"> "+t.message,t.chan)),t.type){case"reload":return void(o||h.current().reload());case"reload_userlist":return void(o||h.current().reloadUserlist());case"relog":return void(o||r.fetch(void 0,!0));case"refresh":return void(o||location.reload(!0));case"join":if(c=[s," has joined "+h.current().name],o||f.add({nick:t.name,network:t.network}),1==r.getNetwork(t.network).type&&!l.get("oircJoinPart"))return;break;case"part":if(c=[s," has left "+h.current().name+" (",i,")"],o||f.remove({nick:t.name,network:t.network}),1==r.getNetwork(t.network).type&&!l.get("oircJoinPart"))return;break;case"quit":if(c=[s," has quit IRC (",i,")"],o||f.remove({nick:t.name,network:t.network}),1==r.getNetwork(t.network).type&&!l.get("oircJoinPart"))return;break;case"kick":c=[s," has kicked ",S.name(t.name2,t.network)," from "+h.current().name+" (",i,")"],o||f.remove({nick:t.name2,network:t.network});break;case"message":a=s;break;case"action":c=[s," ",i];break;case"mode":"string"==typeof i&&(i=t.message.split(" "),$.each(i,function(e,n){var o=$("<span>").html(n).text();-1==o.indexOf("+")&&-1==o.indexOf("-")&&(i[e]=S.name(n,t.network))}),i=i.join(" ")),c=[s," set "+h.current().name+" mode ",i];break;case"nick":c=[s," has changed nicks to ",S.name(t.name2,t.network)],o||(f.add({nick:t.name2,network:t.network}),f.remove({nick:t.name,network:t.network}));break;case"topic":if(e.ontopicchange(S.parse(t.message,!0)),""===t.name&&0===t.network&&o)return;c=[s," has changed the topic to ",S.parse(t.message,!0)];break;case"pm":if(t.chan==h.current().handler)a=s,t.type="message";else{if(o)return;if(t.name.toLowerCase()==r.nick().toLowerCase())return void h.joinPm(t.chan,r.getWholePmIdent(t.uid,t.network));a=["(PM)",s],h.joinPm(t.name,r.getWholePmIdent(t.uid,t.network)),C.make("(PM) <"+t.name+"> "+t.message,t.chan)}break;case"pmaction":if(t.chan==h.current().handler)c=[s," ",i],t.type="action";else{if(o)return;if(t.name.toLowerCase()==r.nick().toLowerCase())return void h.joinPm(t.chan,r.getWholePmIdent(t.uid,t.network));c=["(PM)",s," ",i],h.joinPm(t.name,r.getWholePmIdent(t.uid,t.network)),notofication.make("* (PM)"+t.name+" "+t.message,t.chan),t.type="pm"}break;case"highlight":return void("*"!=t.name.toLowerCase()&&C.make("("+t.chan+") <"+t.name+"> "+t.message,t.chan));case"internal":c=t.message;break;case"server":break;default:return}e.onmessage(a,c,t,o)}}};return{setSmileys:n.setSmileys,setSpLinks:n.setSpLinks,parse:n.parse,parseTextDecorations:n.parseTextDecorations,name:n.name,highlight:n.highlight,addLine:n.addLine}}(),y=function(){var e={$errors:!1,$warnings:!1,errors:[],warnings:[],$errorsPopup:!1,$warningsPopup:!1,getSinglePopupEntry:function(e){return $("<div>").css("border-bottom","1px solid black").append("Time: ",new Date(e.time).toLocaleTimeString(),"<br>File: ",$("<span>").text(e.file).html(),$.map(e.content,function(e,t){return["<br>",$("<span>").text(t).html(),": ",$("<span>").text(e).html()]}))},makePopup:function(t,n,o){return $("<div>").addClass("errorPopup").addClass(t.toLowerCase()).append($("<a>").text("Close").click(function(e){e.preventDefault(),$(this).parent().remove(),o()}),"&nbsp;",$("<b>").text(t),$("<div>").addClass("errorPopupCont").append($.map(n,function(t){return e.getSinglePopupEntry(t)}))).appendTo("body")},init:function(t,n){void 0===t&&(t=$("#errors")),void 0===n&&(n=$("#warnings")),t.click(function(){e.$errorsPopup||(e.$errorsPopup=e.makePopup("Errors",e.errors,function(){e.$errorsPopup=!1}))}),n.click(function(){e.$warningsPopup||(e.$warningsPopup=e.makePopup("Warnings",e.warnings,function(){e.$warningsPopup=!1}))}),e.$errors=t,e.$warnings=n},addError:function(t,n){e.errors.push({time:(new Date).getTime(),file:t,content:n}),e.$errors.css("display","").find(".count").text(e.errors.length),e.$errorsPopup&&e.$errorsPopup.children("div").append(e.getSinglePopupEntry(e.errors[e.errors.length-1]))},addWarning:function(t,n){e.warnings.push({time:(new Date).getTime(),file:t,content:n}),e.$warnings.css("display","").find(".count").text(e.warnings.length),e.$warningsPopup&&e.$warningsPopup.children("div").append(e.getSinglePopupEntry(e.warnings[e.warnings.length-1]))}};return{addError:e.addError,addWarning:e.addWarning,init:e.init}}(),x=function(){var t={isBlurred:!0,init:function(){$(window).blur(function(){t.isBlurred=!0}).focus(function(){t.isBlurred=!1})},changeLinks:function(){$('#adminLink a,a[href="."],a[href="?options"],a[href="index.php"]').each(function(){void 0!==$(this).attr("href").split("?")[1]?$(this).attr("href",$(this).attr("href")+"&network="+e.settings.net()):$(this).attr("href",$(this).attr("href")+"?network="+e.settings.net())})}};return{init:t.init,changeLinks:t.changeLinks,isBlurred:function(){return t.isBlurred}}}(),P=function(){var e={isOpen:!1,open:function(t){e.isOpen||(e.isOpen=!0,g.stop(t))},close:function(){e.isOpen&&(e.isOpen=!1,h.current().reload())},fetch:function(t,n,o){e.isOpen&&(void 0===o&&(o=0),c.getJSON("Log.php?day="+t+"&offset="+parseInt(o,10)+"&channel="+h.current().handlerB64,function(r){r.banned?(m.internal('<span style="color:#C73232;"><b>ERROR:</b> banned</span>'),n(!1)):($.map(r.lines,function(e){s(e,!0)}),r.lines.length>=1e3?e.fetch(t,n,o+1e3):void 0!==n&&n(!0))}))}};return{fetch:e.fetch,open:e.open,close:e.close}}();this.OMNOMIRCSERVER="https://omnomirc.omnimaga.org",this.settings={loggedIn:r.loggedIn,fetch:r.fetch,net:r.net,getNetwork:r.getNetwork,getPmIdent:r.getPmIdent,getWholePmIdent:r.getWholePmIdent,nick:r.nick,guestLevel:r.guestLevel,identGuest:r.identGuest,logout:r.logout},this.ls={get:i.get,set:i.set},this.network={getJSON:c.getJSON,post:c.post},this.options={get:l.get,set:l.set,getAll:l.getAll},this.instant={current:d.current},this.channels={load:h.load,join:h.join,joinPm:h.joinPm,part:h.part,getList:h.getList,getHandler:h.getHandler,current:h.current,setChans:h.setChans,highlight:h.highlight},this.users={add:f.add,remove:f.remove,setUsers:f.setUsers},this.send={send:m.send,internal:m.internal,val:m.val},this.parser={parse:S.parse,name:S.name,highlight:S.highlight},this.error={addWarning:y.addWarning,addError:y.addError,init:y.init},this.page={changeLinks:x.changeLinks,isBlurred:x.isBlurred},this.logs={fetch:P.fetch,open:P.open,close:P.close},this.statusBar={set:b.set},this.initinput=function(e,t){void 0===e&&(e=$("#message")),n=e,t&&k.init(),w.init(),v.init(),n.keypress(function(e){13==e.which&&(e.preventDefault(),n.attr("disabled")||m.send(function(){n.focus()}))})},this.connect=function(e){x.init(),C.init(),r.fetch(function(){d.init(),g.init(),h.init(),e()})},this.disconnect=function(){d.kill(),g.kill()},this.setClassPrefix=function(e){t=e},this.onerror=function(){},this.onwarning=function(){},this.onmessage=function(){},this.onmessageraw=!1,this.onuserchange=function(){},this.onchannelchange=function(){},this.onchanneljoin=function(){},this.onchannelpart=function(){},this.onsmileychange=function(){},this.onsetval=!1,this.ongetval=!1,this.ontopicchange=function(){},this.onnotification=function(){},e=this,void 0!==this.setOptions&&(this.options.setAll=l.setAll,this.setOptions(),delete this.options.setAll)}