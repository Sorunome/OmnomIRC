<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Sorunome:OmnomIRC</id>
	<version>0.1</version>

	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="before"><![CDATA[		updateStats('topic', true);
		updateStats('subject', $topicOptions['id'], $msgOptions['subject']);
]]></search>
			<add><![CDATA[
		// Send the new topic to OmnomIRC start
		if(!empty($modSettings['oirc_topics']) && !empty($modSettings['oirc_topicnotification']))
		{
			$chan = getOircSendToChan($topicOptions['board']);
			if($chan !== false)
			{
				sendToOmnomIRC(strtr($modSettings['oirc_topicnotification'],array(
					'{COLOR}' => "\x03",
					'{NAME}' => $posterOptions['name'],
					'{TOPIC}' => $msgOptions['subject'],
					'{SUBJECT}' => $msgOptions['subject'],
					'{TOPICID}' => $topicOptions['id'],
					'{POSTID}' => $msgOptions['id']
				)),$chan);
			}
		}
		// Send the new topic to OmnomIRC end
]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[		// One new post has been added today.
		trackStats(array('posts' => '+'));
]]></search>
			<add><![CDATA[
		// Send the new post to OmnomIRC start
		if(!empty($modSettings['oirc_posts']) && !empty($modSettings['oirc_postnotification']))
		{
			$chan = getOircSendToChan($topicOptions['board']);
			if($chan !== false)
			{
				$topicname = '';
				if(strpos($modSettings['oirc_postnotification'],'{TOPIC}') !== false){
					$topicname = getTopicName($topicOptions['id']);
				}
				sendToOmnomIRC(strtr($modSettings['oirc_postnotification'],array(
					'{COLOR}' => "\x03",
					'{NAME}' => $posterOptions['name'],
					'{TOPIC}' => $topicname,
					'{SUBJECT}' => $msgOptions['subject'],
					'{TOPICID}' => $topicOptions['id'],
					'{POSTID}' => $msgOptions['id']
				)),$chan);
			}
		}
		// Send the new post to OmnomIRC end
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
	// Mark the edited post as read.
	if (!empty($topicOptions['mark_as_read']) && !$user_info['is_guest'])]]></search>
			<add><![CDATA[
	// Send the new edit to OmnomIRC start
	if(!empty($modSettings['oirc_edits']) && !empty($modSettings['oirc_editnotification']))
	{
		$chan = getOircSendToChan($topicOptions['board']);
		if($chan !== false)
		{
			$topicname = '';
			if(strpos($modSettings['oirc_editnotification'],'{TOPIC}') !== false){
				$topicname = getTopicName($topicOptions['id']);
			}
			sendToOmnomIRC(strtr($modSettings['oirc_editnotification'],array(
				'{COLOR}' => "\x03",
				'{NAME}' => $posterOptions['name'],
				'{TOPIC}' => $topicname,
				'{SUBJECT}' => $msgOptions['subject'],
				'{TOPICID}' => $topicOptions['id'],
				'{POSTID}' => $msgOptions['id']
			)),$chan);
		}
	}
	// Send the new edit to OmnomIRC end
]]></add>
		</operation>
		<operation>
			<search position="end" />
			<add><![CDATA[
function sendToOmnomIRC($message,$channel)
{
	global $config,$only_include_oirc,$boarddir;
	$only_include_oirc = true;
	include_once($boarddir.'/checkLogin/index.php');
	$nick = '*';
	$time = (string)(time() - 60*60*24 + 60); // the sig key is only valid for one min!
	$uid = rand();
	$network = 0;
	
	$signature = $time.'|'.hash_hmac('sha512',$nick.$uid,$network.$config['sigKey'].$time);
	file_get_contents($config['oircUrl'].'/message.php?message='.base64_url_encode($message).'&channel='.$channel.'&nick='.base64_url_encode($nick).'&signature='.base64_url_encode($signature).'&time='.$time.'&network='.$network.'&id='.$uid.'noLoginErrors&serverident');
}

function getTopicName($id)
{
	global $smcFunc;
	$topicName = '';
	$request = $smcFunc['db_query']('',"SELECT id_first_msg FROM {db_prefix}topics WHERE id_topic = {int:id_topic} LIMIT 1",array('id_topic' => (int)$id));
	$temp = $smcFunc['db_fetch_assoc']($request);
	$smcFunc['db_free_result']($request);
	if(isset($temp['id_first_msg']))
	{
		$request = $smcFunc['db_query']('',"SELECT subject FROM {db_prefix}messages WHERE id_msg = {int:id_msg} LIMIT 1",array('id_msg' => (int)$temp['id_first_msg']));
		$temp = $smcFunc['db_fetch_assoc']($request);
		$smcFunc['db_free_result']($request);
		if(isset($temp['subject']))
		{
			$topicName = $temp['subject'];
		}
	}
	return $topicName;
}

function getOircSendToChan($id_board)
{
	global $smcFunc;
	
	$request = $smcFunc['db_query']('',"SELECT id_profile FROM {db_prefix}boards WHERE id_board = {int:id_board} LIMIT 1",array('id_board' => $id_board));
	$temp = $smcFunc['db_fetch_assoc']($request);
	$smcFunc['db_free_result']($request);
	if(!empty($temp['id_profile']))
	{
		$request = $smcFunc['db_query']('',"SELECT channel FROM {db_prefix}oirc_postchans WHERE id_profile = {int:id_profile} LIMIT 1",array('id_profile' => $temp['id_profile']));
		$temp = $smcFunc['db_fetch_assoc']($request);
		$smcFunc['db_free_result']($request);
		if(isset($temp['channel']) && $temp['channel']!='' && $temp['channel']!=-1)
		{
			return $temp['channel'];
		}
	}
	return false;
}
]]></add>
		</operation>
	</file>

</modification>
